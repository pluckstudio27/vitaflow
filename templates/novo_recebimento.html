{% extends "base.html" %}

{% block title %}Novo Recebimento{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Novo Recebimento
                    </h4>
                    <small>Registrar recebimento para solicitação {{ solicitacao.protocolo }}</small>
                </div>
                <div class="card-body">
                    <!-- Informações da Solicitação -->
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <strong>Dados da Solicitação</strong>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Protocolo:</strong> {{ solicitacao.protocolo }}<br>
                                    <strong>Setor:</strong> {{ solicitacao.setor }}<br>
                                    <strong>Item:</strong> {{ solicitacao.item_nome }}<br>
                                    <strong>Quantidade Solicitada:</strong> {{ solicitacao.quantidade_solicitada }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Solicitante:</strong> {{ solicitacao.solicitante }}<br>
                                    <strong>Data Necessária:</strong> {{ solicitacao.data_necessidade.strftime('%d/%m/%Y') }}<br>
                                    <strong>Autorizado por:</strong> {{ solicitacao.responsavel_tecnico }}<br>
                                    <strong>Validado por:</strong> {{ solicitacao.secretaria_validador }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulário de Recebimento -->
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Número da Nota Fiscal <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="numero_nota_fiscal" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fornecedor <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="fornecedor" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data da Nota Fiscal <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" name="data_nota_fiscal" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Total da NF <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" class="form-control" name="valor_total" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Responsável pelo Recebimento <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="responsavel_recebimento" required>
                        </div>
                        
                        <hr>
                        <h5><i class="fas fa-box"></i> Detalhes do Item</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quantidade Recebida <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="quantidade_recebida" min="1" value="{{ solicitacao.quantidade_solicitada }}" required>
                                    <small class="form-text text-muted">Quantidade solicitada: {{ solicitacao.quantidade_solicitada }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Unitário <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" class="form-control" name="valor_unitario" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lote</label>
                                    <input type="text" class="form-control" name="lote" placeholder="Número do lote (se aplicável)">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data de Validade</label>
                                    <input type="date" class="form-control" name="data_validade">
                                    <small class="form-text text-muted">Apenas para itens perecíveis</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Observações do Item</label>
                            <textarea class="form-control" name="observacoes_item" rows="2" placeholder="Observações sobre o estado, qualidade ou outras informações do item..."></textarea>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <label class="form-label">Observações Gerais</label>
                            <textarea class="form-control" name="observacoes" rows="3" placeholder="Observações gerais sobre o recebimento..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Importante:</strong> Após criar o recebimento, ele ficará pendente de conferência. Verifique todos os dados antes de confirmar.
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('painel_recebimento') }}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Criar Recebimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calcular valor total automaticamente
document.addEventListener('DOMContentLoaded', function() {
    const quantidadeInput = document.querySelector('input[name="quantidade_recebida"]');
    const valorUnitarioInput = document.querySelector('input[name="valor_unitario"]');
    const valorTotalInput = document.querySelector('input[name="valor_total"]');
    
    function calcularTotal() {
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
        const total = quantidade * valorUnitario;
        valorTotalInput.value = total.toFixed(2);
    }
    
    quantidadeInput.addEventListener('input', calcularTotal);
    valorUnitarioInput.addEventListener('input', calcularTotal);
    
    // Validação de data
    const dataNotaInput = document.querySelector('input[name="data_nota_fiscal"]');
    const hoje = new Date().toISOString().split('T')[0];
    dataNotaInput.max = hoje;
});
</script>
{% endblock %}