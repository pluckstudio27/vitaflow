{% extends "base.html" %}

{% block title %}Análise de Consumo - VitaFlow{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line"></i> Análise de Consumo e Sugestões</h2>
                <a href="{{ url_for('planejamento_compras') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Estoque Crítico</h6>
                            <h4>{{ analises|selectattr('status', 'equalto', 'crítico')|list|length }}</h4>
                            <small>≤ 5 unidades</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Estoque Baixo</h6>
                            <h4>{{ analises|selectattr('status', 'equalto', 'baixo')|list|length }}</h4>
                            <small>≤ 10 unidades</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sugestões de Compra</h6>
                            <h4>{{ analises|selectattr('sugestao_compra', 'greaterthan', 0)|list|length }}</h4>
                            <small>itens para comprar</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Análise Detalhada -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-analytics"></i> Análise Detalhada de Consumo</h5>
                    <small class="text-muted">Baseado no consumo dos últimos 3 meses</small>
                </div>
                <div class="card-body">
                    {% if analises %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaAnalise">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Estoque Atual</th>
                                    <th>Consumo Médio/Mês</th>
                                    <th>Estoque Mín. Sugerido</th>
                                    <th>Sugestão de Compra</th>
                                    <th>Status</th>
                                    <th>Localização</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analise in analises|sort(attribute='status') %}
                                <tr class="{% if analise.status == 'crítico' %}table-danger{% elif analise.status == 'baixo' %}table-warning{% endif %}">
                                    <td>
                                        <strong>{{ analise.item.nome }}</strong>
                                        {% if analise.item.descricao %}
                                        <br><small class="text-muted">{{ analise.item.descricao }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if analise.item.quantidade <= 5 %}bg-danger{% elif analise.item.quantidade <= 10 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ analise.item.quantidade }}
                                        </span>
                                    </td>
                                    <td>{{ analise.consumo_medio_mensal }}</td>
                                    <td>{{ analise.estoque_minimo_sugerido }}</td>
                                    <td>
                                        {% if analise.sugestao_compra > 0 %}
                                        <span class="badge bg-primary">{{ analise.sugestao_compra }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if analise.status == 'crítico' %}
                                        <span class="badge bg-danger">Crítico</span>
                                        {% elif analise.status == 'baixo' %}
                                        <span class="badge bg-warning">Baixo</span>
                                        {% else %}
                                        <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ analise.item.localizacao or 'Não informado' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Botões de Ação -->
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="gerarRelatorioCompras()">
                                    <i class="fas fa-file-export"></i> Gerar Lista de Compras
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-info" onclick="filtrarCriticos()">
                                    <i class="fas fa-filter"></i> Mostrar Apenas Críticos
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="mostrarTodos()">
                                    <i class="fas fa-eye"></i> Mostrar Todos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma análise disponível</h5>
                        <p class="text-muted">Não há dados suficientes para análise de consumo ou não há itens cadastrados.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Lista de Compras -->
    <div class="modal fade" id="modalListaCompras" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shopping-list"></i> Lista de Compras Sugeridas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="listaComprasContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="copiarLista()">
                        <i class="fas fa-copy"></i> Copiar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="dados-analises" style="display:none;">{{ analises|tojson|safe }}</div>

<script>
    // Carrega dados das análises do elemento HTML
    const dadosElement = document.getElementById('dados-analises');
    window.dadosAnalises = dadosElement ? JSON.parse(dadosElement.textContent || '[]') : [];
</script>

<script>
function filtrarCriticos() {
    const tabela = document.getElementById('tabelaAnalise');
    const linhas = tabela.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < linhas.length; i++) {
        const status = linhas[i].querySelector('.badge').textContent.trim();
        if (status !== 'Crítico') {
            linhas[i].style.display = 'none';
        } else {
            linhas[i].style.display = '';
        }
    }
}

function mostrarTodos() {
    const tabela = document.getElementById('tabelaAnalise');
    const linhas = tabela.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < linhas.length; i++) {
        linhas[i].style.display = '';
    }
}

function gerarRelatorioCompras() {
    let listaHtml = '<h6>Itens Sugeridos para Compra:</h6><ul class="list-group">';
    let temItens = false;
    
    window.dadosAnalises.forEach(function(analise) {
        if (analise.sugestao_compra > 0) {
            temItens = true;
            const prioridade = analise.status === 'crítico' ? 'URGENTE' : 'Normal';
            listaHtml += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${analise.item.nome}</strong>
                        <br><small class="text-muted">Estoque atual: ${analise.item.quantidade} | Consumo médio: ${analise.consumo_medio_mensal}/mês</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary rounded-pill">${analise.sugestao_compra}</span>
                        <br><small class="${analise.status === 'crítico' ? 'text-danger' : 'text-muted'}">${prioridade}</small>
                    </div>
                </li>
            `;
        }
    });
    
    if (!temItens) {
        listaHtml = '<p class="text-muted">Nenhum item precisa ser comprado no momento.</p>';
    } else {
        listaHtml += '</ul>';
    }
    
    document.getElementById('listaComprasContent').innerHTML = listaHtml;
    new bootstrap.Modal(document.getElementById('modalListaCompras')).show();
}

function copiarLista() {
    let texto = 'LISTA DE COMPRAS SUGERIDAS\n\n';
    
    window.dadosAnalises.forEach(function(analise) {
        if (analise.sugestao_compra > 0) {
            const prioridade = analise.status === 'crítico' ? ' [URGENTE]' : '';
            texto += `• ${analise.item.nome} - Quantidade: ${analise.sugestao_compra}${prioridade}\n`;
        }
    });
    
    navigator.clipboard.writeText(texto).then(function() {
        showAlert('Lista copiada para a área de transferência!', 'success');
    });
}
</script>
{% endblock %}