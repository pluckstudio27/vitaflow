{% extends 'base.html' %}
{% block title %}Relatórios Administrativos{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <i class="fas fa-chart-line me-2"></i>
    <h2 class="mb-0">Relatórios Administrativos</h2>
  </div>
  <p class="text-muted">Consumo médio e valores gastos no período selecionado.</p>
  <div id="rel-admin-root"></div>
</div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script>
const { useState, useEffect } = React;
function RelatoriosAdmin() {
  const today = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  const fmt = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const endDefault = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const startDefault = new Date(endDefault.getTime() - 29*24*3600*1000);
  const [dataInicio, setDataInicio] = useState(fmt(startDefault));
  const [dataFim, setDataFim] = useState(fmt(endDefault));
  const [useAi, setUseAi] = useState(false);
  const [loading, setLoading] = useState(false);
  const [items, setItems] = useState([]);
  const [totais, setTotais] = useState({});
  const [aiFeedback, setAiFeedback] = useState('');
  const [aiProvider, setAiProvider] = useState('');
  const load = async () => {
    setLoading(true);
    const params = new URLSearchParams({ data_inicio: dataInicio, data_fim: dataFim, use_ai: useAi ? 'true' : 'false' });
    try {
      const res = await fetchJson(`/api/relatorios/admin/consumo-gastos?${params.toString()}`);
      setItems(res.items || []);
      setTotais(res.totais || {});
      const f = String(res.ai_feedback || '').trim();
      setAiFeedback(f);
      const p = (res.params && res.params.ai_provider) ? String(res.params.ai_provider) : '';
      setAiProvider(p);
    } catch (e) {
      setItems([]);
      setTotais({});
      setAiFeedback('');
      setAiProvider('');
    } finally {
      setLoading(false);
    }
  };
  useEffect(() => { load(); }, []);
  const fmtNumber = (n, frac=2) => Number(n||0).toLocaleString('pt-BR', { maximumFractionDigits: frac });
  return (
    React.createElement('div', { className: 'row' },
      React.createElement('div', { className: 'col-lg-4' },
        React.createElement('div', { className: 'card border-0 shadow-sm mb-3' },
          React.createElement('div', { className: 'card-header bg-white d-flex align-items-center justify-content-between' },
            React.createElement('strong', null, 'Parâmetros'),
            React.createElement('span', { className: `badge ${aiProvider ? 'badge-success' : 'badge-light'}`, style: { display: aiProvider ? 'inline-block' : 'none' } }, `IA: ${aiProvider}`)
          ),
          React.createElement('div', { className: 'card-body' },
            React.createElement('div', { className: 'form-row' },
              React.createElement('div', { className: 'form-group col-md-6' },
                React.createElement('label', { className: 'small text-muted' }, 'Início'),
                React.createElement('input', { type: 'date', className: 'form-control', value: dataInicio, onChange: (e) => setDataInicio(e.target.value) })
              ),
              React.createElement('div', { className: 'form-group col-md-6' },
                React.createElement('label', { className: 'small text-muted' }, 'Fim'),
                React.createElement('input', { type: 'date', className: 'form-control', value: dataFim, onChange: (e) => setDataFim(e.target.value) })
              ),
              React.createElement('div', { className: 'form-group col-12' },
                React.createElement('div', { className: 'custom-control custom-switch' },
                  React.createElement('input', { type: 'checkbox', className: 'custom-control-input', id: 'adminUseAiReact', checked: useAi, onChange: (e) => setUseAi(e.target.checked) }),
                  React.createElement('label', { className: 'custom-control-label', htmlFor: 'adminUseAiReact' }, 'Usar Inteligência Artificial')
                )
              )
            ),
            React.createElement('div', { className: 'd-flex justify-content-end' },
              React.createElement('button', { className: 'btn btn-primary btn-sm', onClick: load },
                React.createElement('i', { className: 'fas fa-sync-alt' }), ' Atualizar'
              )
            )
          )
        ),
        React.createElement('div', { className: 'card border-0 shadow-sm', style: { display: aiFeedback ? '' : 'none' } },
          React.createElement('div', { className: 'card-header bg-white' }, React.createElement('strong', null, 'Resumo da IA')),
          React.createElement('div', { className: 'card-body' },
            React.createElement('div', { className: 'text-muted', style: { whiteSpace: 'pre-wrap' } }, aiFeedback)
          )
        )
      ),
      React.createElement('div', { className: 'col-lg-8' },
        React.createElement('div', { className: 'card border-0 shadow-sm' },
          React.createElement('div', { className: 'card-body' },
            React.createElement('div', { className: 'table-responsive' },
              React.createElement('table', { className: 'table table-hover' },
                React.createElement('thead', null,
                  React.createElement('tr', null,
                    React.createElement('th', null, 'Produto'),
                    React.createElement('th', { style: { width: '160px' } }, 'Consumo total'),
                    React.createElement('th', { style: { width: '160px' } }, 'Média diária'),
                    React.createElement('th', { style: { width: '180px' } }, 'Gastos (R$)')
                  )
                ),
                React.createElement('tbody', null,
                  loading ? React.createElement('tr', null,
                    React.createElement('td', { colSpan: 4 }, React.createElement('div', { className: 'text-center py-3' }, React.createElement('i', { className: 'fas fa-spinner fa-spin' }), ' Carregando relatório...'))
                  ) : (
                    items.length === 0 ? React.createElement('tr', null,
                      React.createElement('td', { colSpan: 4, className: 'text-center text-muted' }, 'Nenhum dado para o período selecionado.')
                    ) : items.map((it, idx) => React.createElement('tr', { key: idx },
                      React.createElement('td', null, React.createElement('strong', null, it.produto_nome || '-'), React.createElement('br', null), React.createElement('small', { className: 'text-muted' }, it.produto_codigo || '-')),
                      React.createElement('td', null, fmtNumber(it.total_consumo, 4)),
                      React.createElement('td', null, fmtNumber(it.media_diaria, 4)),
                      React.createElement('td', null, React.createElement('strong', null, fmtNumber(it.total_gastos, 2)))
                    ))
                  )
                ),
                React.createElement('tfoot', null,
                  React.createElement('tr', null,
                    React.createElement('th', { className: 'text-end' }, 'Totais:'),
                    React.createElement('th', null, fmtNumber(totais.consumo_geral, 4)),
                    React.createElement('th', null, fmtNumber((Number(totais.consumo_geral||0)/Number(totais.dias_periodo||1)), 4)),
                    React.createElement('th', null, fmtNumber(totais.gastos_geral, 2))
                  )
                )
              )
            )
          )
        )
      )
    )
  );
}
const root = ReactDOM.createRoot(document.getElementById('rel-admin-root'));
root.render(React.createElement(RelatoriosAdmin));
</script>
{% endblock %}
