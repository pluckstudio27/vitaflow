{% extends "base.html" %}

{% block title %}Dashboard - VitaFlow{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 text-gradient">
            <i class="fas fa-tachometer-alt"></i> Dashboard VitaFlow
        </h1>
        <p class="lead text-muted">Hospital Municipal de Angicos - Gestão de Almoxarifado e Farmácia</p>
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Última atualização: {{ hoje.strftime('%d/%m/%Y') }}</small>
            <span class="badge badge-success">Sistema Online</span>
        </div>
    </div>
</div>

<!-- Estatísticas Gerais -->
<div class="dashboard-grid">
    <div class="metric-card metric-card-primary">
        <div class="card-body position-relative">
            <div class="metric-value">{{ stats.total_almoxarifado }}</div>
            <div class="metric-label">Itens no Almoxarifado</div>
            <div class="metric-change">
                <i class="fas fa-box"></i>
                {{ stats.quantidade_almoxarifado }} unidades
            </div>
            <i class="fas fa-warehouse metric-icon"></i>
        </div>
    </div>
    
    <div class="metric-card metric-card-success">
        <div class="card-body position-relative">
            <div class="metric-value">{{ stats.total_farmacia }}</div>
            <div class="metric-label">Itens na Farmácia</div>
            <div class="metric-change">
                <i class="fas fa-pills"></i>
                {{ stats.quantidade_farmacia }} unidades
            </div>
            <i class="fas fa-pills metric-icon"></i>
        </div>
    </div>
    
    <div class="metric-card metric-card-info">
        <div class="card-body position-relative">
            <div class="metric-value">{{ stats.total_geral }}</div>
            <div class="metric-label">Total de Itens</div>
            <div class="metric-change">
                <i class="fas fa-chart-line"></i>
                {{ stats.quantidade_total }} unidades
            </div>
            <i class="fas fa-boxes metric-icon"></i>
        </div>
    </div>
    
    <div class="metric-card metric-card-warning">
        <div class="card-body position-relative">
            <div class="metric-value">{{ stats.itens_vencendo }}</div>
            <div class="metric-label">Próximos ao Vencimento</div>
            <div class="metric-change">
                <i class="fas fa-clock"></i>
                Próximos 30 dias
            </div>
            <i class="fas fa-exclamation-triangle metric-icon"></i>
        </div>
    </div>
</div>

<!-- Distribuição por Setor -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> Distribuição por Setor
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="text-center p-3 border rounded">
                            <i class="fas fa-user-nurse fa-2x text-primary mb-2"></i>
                            <h6>Enfermagem</h6>
                            <div class="h4 text-primary">{{ stats.por_setor.enfermagem or 0 }}</div>
                            <small class="text-muted">itens cadastrados</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-center p-3 border rounded">
                            <i class="fas fa-pills fa-2x text-success mb-2"></i>
                            <h6>Farmácia</h6>
                            <div class="h4 text-success">{{ stats.por_setor.farmacia or 0 }}</div>
                            <small class="text-muted">itens cadastrados</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="text-center p-3 border rounded">
                            <i class="fas fa-microscope fa-2x text-info mb-2"></i>
                            <h6>Laboratório</h6>
                            <div class="h4 text-info">{{ stats.por_setor.laboratorio or 0 }}</div>
                            <small class="text-muted">itens cadastrados</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-center p-3 border rounded">
                            <i class="fas fa-procedures fa-2x text-warning mb-2"></i>
                            <h6>Centro Cirúrgico</h6>
                            <div class="h4 text-warning">{{ stats.por_setor.centro_cirurgico or 0 }}</div>
                            <small class="text-muted">itens cadastrados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas e Status -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-circle"></i> Alertas do Sistema
                </h5>
            </div>
            <div class="card-body">
                <!-- Itens Vencendo -->
                {% if stats.itens_vencendo > 0 %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-clock"></i>
                        <strong>{{ stats.itens_vencendo }}</strong> itens vencem nos próximos 30 dias.
                        <a href="{{ url_for('listar_itens') }}?vencimento=proximo" class="alert-link">Ver lista</a>
                    </div>
                {% endif %}
                
                <!-- Itens com Estoque Baixo -->
                {% if stats.estoque_baixo > 0 %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-box-open"></i>
                        <strong>{{ stats.estoque_baixo }}</strong> itens com estoque baixo (≤5 unidades).
                        <a href="{{ url_for('listar_itens') }}?estoque=baixo" class="alert-link">Ver lista</a>
                    </div>
                {% endif %}
                
                <!-- Itens Vencidos -->
                {% if stats.itens_vencidos > 0 %}
                    <div class="alert alert-danger mb-3">
                        <i class="fas fa-times-circle"></i>
                        <strong>{{ stats.itens_vencidos }}</strong> itens vencidos precisam ser removidos.
                        <a href="{{ url_for('listar_itens') }}?vencimento=vencido" class="alert-link">Ver lista</a>
                    </div>
                {% endif %}
                
                {% if stats.itens_vencendo == 0 and stats.estoque_baixo == 0 and stats.itens_vencidos == 0 %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Sistema sem alertas críticos no momento.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Itens Próximos ao Vencimento -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Itens Próximos ao Vencimento (30 dias)
                </h5>
            </div>
            <div class="card-body">
                {% if itens_vencimento %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Setor</th>
                                <th>Localização</th>
                                <th>Quantidade</th>
                                <th>Data de Vencimento</th>
                                <th>Dias Restantes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in itens_vencimento %}
                            <tr>
                                <td>{{ item.nome }}</td>
                                <td class="text-capitalize">{{ item.setor.replace('_', ' ') }}</td>
                                <td>
                                    <span class="badge bg-{{ 'primary' if item.localizacao == 'almoxarifado' else 'success' }}">
                                        {{ item.localizacao.title() }}
                                    </span>
                                </td>
                                <td>{{ item.quantidade }}</td>
                                <td>{{ item.data_vencimento.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% set dias_restantes = (item.data_vencimento - hoje).days %}
                                    <span class="badge bg-{{ 'danger' if dias_restantes <= 7 else 'warning' if dias_restantes <= 15 else 'info' }}">
                                        {{ dias_restantes }} dias
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5>Nenhum item próximo ao vencimento!</h5>
                    <p class="text-muted">Todos os itens estão dentro do prazo de validade.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Comparativo Almoxarifado vs Farmácia -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-balance-scale"></i> Comparativo: Almoxarifado vs Farmácia
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center p-4 border rounded bg-light">
                            <i class="fas fa-warehouse fa-3x text-primary mb-3"></i>
                            <h4 class="text-primary">Almoxarifado</h4>
                            <div class="row">
                                <div class="col-6">
                                    <div class="h5">{{ stats.total_almoxarifado }}</div>
                                    <small class="text-muted">Tipos de Itens</small>
                                </div>
                                <div class="col-6">
                                    <div class="h5">{{ stats.quantidade_almoxarifado }}</div>
                                    <small class="text-muted">Total Unidades</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="{{ url_for('listar_itens') }}?localizacao=almoxarifado" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> Ver Itens
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-4 border rounded bg-light">
                            <i class="fas fa-pills fa-3x text-success mb-3"></i>
                            <h4 class="text-success">Farmácia</h4>
                            <div class="row">
                                <div class="col-6">
                                    <div class="h5">{{ stats.total_farmacia }}</div>
                                    <small class="text-muted">Tipos de Itens</small>
                                </div>
                                <div class="col-6">
                                    <div class="h5">{{ stats.quantidade_farmacia }}</div>
                                    <small class="text-muted">Total Unidades</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="{{ url_for('listar_itens') }}?localizacao=farmacia" class="btn btn-success">
                                    <i class="fas fa-eye"></i> Ver Itens
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resumo Total -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="text-center p-3 bg-info text-white rounded">
                            <h5 class="mb-2">
                                <i class="fas fa-calculator"></i> Total Geral do Hospital
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="h4">{{ stats.total_geral }}</div>
                                    <small>Tipos de Itens</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="h4">{{ stats.quantidade_total }}</div>
                                    <small>Total de Unidades</small>
                                </div>
                                <div class="col-md-4">
                                    {% if stats.valor_total %}
                                        <div class="h4">R$ {{ "%.2f"|format(stats.valor_total) }}</div>
                                        <small>Valor Total Estimado</small>
                                    {% else %}
                                        <div class="h6">Valor não calculado</div>
                                        <small>Preços não informados</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Movimentações de Estoque -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt"></i> Movimentações de Estoque
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-exchange-alt fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Transferir Itens</h5>
                                <p class="card-text text-muted">Almoxarifado → Farmácia</p>
                                <a href="{{ url_for('transferir_item') }}" class="btn btn-primary">
                                    <i class="fas fa-exchange-alt me-1"></i>Transferir
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <i class="fas fa-sign-out-alt fa-3x text-danger mb-3"></i>
                                <h5 class="card-title">Registrar Saída</h5>
                                <p class="card-text text-muted">Farmácia → Setores</p>
                                <a href="{{ url_for('saida_item') }}" class="btn btn-danger">
                                    <i class="fas fa-sign-out-alt me-1"></i>Registrar Saída
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Relatórios</h5>
                                <p class="card-text text-muted">Histórico de Movimentações</p>
                                <a href="{{ url_for('relatorio_movimentacoes') }}" class="btn btn-info">
                                    <i class="fas fa-chart-line me-1"></i>Ver Relatórios
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Ações Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('adicionar_item') }}" class="btn btn-primary btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-plus fa-2x mb-2"></i>
                            <span>Adicionar Item</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('listar_itens') }}" class="btn btn-info btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-list fa-2x mb-2"></i>
                            <span>Todos os Itens</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('listar_itens') }}?setor=enfermagem" class="btn btn-outline-primary btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-user-nurse fa-2x mb-2"></i>
                            <span>Enfermagem</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('listar_itens') }}?setor=farmacia" class="btn btn-outline-success btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-pills fa-2x mb-2"></i>
                            <span>Farmácia</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('listar_itens') }}?setor=laboratorio" class="btn btn-outline-info btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-microscope fa-2x mb-2"></i>
                            <span>Laboratório</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('listar_itens') }}?setor=centro_cirurgico" class="btn btn-outline-warning btn-lg w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-procedures fa-2x mb-2"></i>
                            <span>Centro Cirúrgico</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}