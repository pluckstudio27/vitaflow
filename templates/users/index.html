{% extends "base.html" %}

{% block title %}PluckLog - Gerenciamento de Usuários{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Gerenciamento de Usuários</h1>
                    <p class="text-muted">Gerencie usuários e suas permissões no sistema</p>
                </div>
                {% if is_super_admin %}
                <button type="button" class="btn btn-primary" onclick="openUserModal()">
                    <i class="fas fa-plus me-2"></i>Novo Usuário
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filter-nivel" class="form-label">Nível de Acesso</label>
                            <select class="form-select" id="filter-nivel">
                                <option value="">Todos os níveis</option>
                                <option value="super_admin">Super Administrador</option>
                                <option value="admin_central">Admin Central</option>
                                <option value="gerente_almox">Gerente Almoxarifado</option>
                                <option value="resp_sub_almox">Responsável Sub-Almox</option>
                                <option value="operador_setor">Operador Setor</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-status" class="form-label">Status</label>
                            <select class="form-select" id="filter-status">
                                <option value="">Todos</option>
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filter-search" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="filter-search" placeholder="Nome, username ou email">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Usuários -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Usuários do Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="users-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Nível de Acesso</th>
                                    <th>Hierarquia</th>
                                    <th>Categoria</th>
                                    <th>Status</th>
                                    <th>Último Login</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios %}
                                <tr data-nivel="{{ usuario.nivel_acesso }}" data-status="{{ usuario.ativo|lower }}" data-search="{{ (usuario.nome_completo + ' ' + usuario.username + ' ' + usuario.email)|lower }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title bg-primary rounded-circle">
                                                    {{ usuario.nome_completo.split()[0][0] }}{{ usuario.nome_completo.split()[-1][0] if usuario.nome_completo.split()|length > 1 else '' }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ usuario.nome_completo }}</div>
                                                <small class="text-muted">ID: {{ usuario.id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>
                                        {% if usuario.nivel_acesso == 'super_admin' %}
                                            <span class="badge bg-danger">Super Admin</span>
                                        {% elif usuario.nivel_acesso == 'admin_central' %}
                                            <span class="badge bg-warning">Admin Central</span>
                                        {% elif usuario.nivel_acesso == 'gerente_almox' %}
                                            <span class="badge bg-info">Gerente Almox</span>
                                        {% elif usuario.nivel_acesso == 'resp_sub_almox' %}
                                            <span class="badge bg-success">Resp. Sub-Almox</span>
                                        {% elif usuario.nivel_acesso == 'operador_setor' %}
                                            <span class="badge bg-secondary">Operador Setor</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ usuario.get_hierarchy_path() }}</small>
                                    </td>
                                    <td>
                                        {% set cat_display = usuario.get_categorias_display() %}
                                        {% if cat_display.tipo == 'todas' %}
                                            <small class="text-muted">Todas</small>
                                        {% elif cat_display.tipo == 'especifica' or cat_display.tipo == 'principal' %}
                                            {% set categoria = cat_display.categorias[0] %}
                                            <span class="badge badge-dynamic" data-color="{{ (categoria.cor if categoria.cor else '#6c757d') }}">
                                                {{ categoria.codigo }}
                                            </span>
                                            <small class="text-muted d-block">{{ categoria.nome }}</small>
                                        {% elif cat_display.tipo == 'multiplas' %}
                                            <span class="badge bg-info text-white">
                                                {{ cat_display.texto }}
                                            </span>
                                            <small class="text-muted d-block">
                                                {% for categoria in cat_display.categorias[:2] %}
                                                    {{ categoria.codigo }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                                {% if cat_display.categorias|length > 2 %}...{% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if usuario.ativo %}
                                            <span class="badge bg-success">Ativo</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inativo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if usuario.ultimo_login %}
                                            <small class="text-muted">{{ usuario.ultimo_login.strftime('%d/%m/%Y %H:%M') }}</small>
                                        {% else %}
                                            <small class="text-muted">Nunca</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if is_super_admin or (usuario.id == current_user.id) %}
                                            <button type="button" class="btn btn-outline-primary btn-edit" data-user-id="{{ usuario.id }}" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% endif %}
                                            {% if is_super_admin %}
                                                {% if usuario.ativo %}
                                                    <button type="button" class="btn btn-outline-warning btn-toggle-status" data-user-id="{{ usuario.id }}" title="Desativar">
                                                        <i class="fas fa-user-slash"></i>
                                                    </button>
                                                {% else %}
                                                    <button type="button" class="btn btn-outline-success btn-toggle-status" data-user-id="{{ usuario.id }}" title="Ativar">
                                                        <i class="fas fa-user-check"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                            {% if is_super_admin or (usuario.id == current_user.id) %}
                                                {% if not (usuario.nivel_acesso == 'super_admin' and not is_super_admin) %}
                                                <button type="button" class="btn btn-outline-info btn-reset-password" data-user-id="{{ usuario.id }}" title="Resetar Senha">
                                                    <i class="fas fa-key"></i>
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                            {% if is_super_admin and usuario.nivel_acesso != 'super_admin' %}
                                                <button type="button" class="btn btn-outline-danger btn-delete" data-user-id="{{ usuario.id }}" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Usuário -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Novo Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="user-id" name="id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="user-nome" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="user-nome" name="nome_completo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="user-username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="user-username" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label for="user-email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="user-email" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="user-nivel" class="form-label">Nível de Acesso *</label>
                            <select class="form-select" id="user-nivel" name="nivel_acesso" required onchange="updateHierarchyFields()">
                                <option value="">Selecione...</option>
                                <option value="super_admin">Super Administrador</option>
                                <option value="admin_central">Admin Central</option>
                                <option value="gerente_almox">Gerente Almoxarifado</option>
                                <option value="resp_sub_almox">Responsável Sub-Almoxarifado</option>
                                <option value="operador_setor">Operador Setor</option>
                            </select>
                        </div>
                        
                        <!-- Campos de Hierarquia -->
                        <div class="col-md-6" id="central-field" style="display: none;">
                            <label for="user-central" class="form-label">Central</label>
                            <select class="form-select" id="user-central" name="central_id">
                                <option value="">Selecione...</option>
                                {% for central in centrais %}
                                    <option value="{{ central.id }}">{{ central.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6" id="almoxarifado-field" style="display: none;">
                            <label for="user-almoxarifado" class="form-label">Almoxarifado</label>
                            <select class="form-select" id="user-almoxarifado" name="almoxarifado_id">
                                <option value="">Selecione...</option>
                                {% for almoxarifado in almoxarifados %}
                                    <option value="{{ almoxarifado.id }}" data-central="{{ almoxarifado.central_id }}">{{ almoxarifado.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Operador Setor: seleção múltipla de Almoxarifados -->
                        <div class="col-12" id="operador-almox-multi-field" style="display: none;">
                            <label class="form-label">Almoxarifados (múltiplos)</label>
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <input type="text" id="operador-almox-search" class="form-control form-control-sm" placeholder="Filtrar por nome do almoxarifado" style="max-width: 320px;">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" id="operador-almox-select-all">Selecionar todos</button>
                                        <button type="button" class="btn btn-outline-secondary" id="operador-almox-clear">Limpar seleção</button>
                                    </div>
                                </div>
                                <div class="table-responsive" style="max-height: 240px; overflow: auto;">
                                    <table class="table table-sm table-hover mb-2">
                                        <thead>
                                            <tr>
                                                <th style="width: 64px;">ID</th>
                                                <th>Almoxarifado</th>
                                                <th>Central</th>
                                                <th style="width: 100px;">Selecionar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="operador-almox-table-body">
                                            <!-- Linhas injetadas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="operador-almox-selected-chips" class="mt-2"></div>
                                <div class="form-text">Use Central e Almoxarifados para filtrar os setores disponíveis.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6" id="sub-almoxarifado-field" style="display: none;">
                            <label for="user-sub-almoxarifado" class="form-label">Sub-Almoxarifado</label>
                            <select class="form-select" id="user-sub-almoxarifado" name="sub_almoxarifado_id">
                                <option value="">Selecione...</option>
                                {% for sub_almoxarifado in sub_almoxarifados %}
                                    <option value="{{ sub_almoxarifado.id }}" data-almoxarifado="{{ sub_almoxarifado.almoxarifado_id }}">{{ sub_almoxarifado.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Operador Setor: seleção múltipla de Sub‑Almoxarifados -->
                        <div class="col-12" id="operador-sub-multi-field" style="display: none;">
                            <label class="form-label">Sub‑Almoxarifados (múltiplos)</label>
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <input type="text" id="operador-sub-search" class="form-control form-control-sm" placeholder="Filtrar por nome do sub‑almoxarifado" style="max-width: 320px;">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" id="operador-sub-select-all">Selecionar todos</button>
                                        <button type="button" class="btn btn-outline-secondary" id="operador-sub-clear">Limpar seleção</button>
                                    </div>
                                </div>
                                <div class="table-responsive" style="max-height: 240px; overflow: auto;">
                                    <table class="table table-sm table-hover mb-2">
                                        <thead>
                                            <tr>
                                                <th style="width: 64px;">ID</th>
                                                <th>Sub‑Almoxarifado</th>
                                                <th>Almoxarifado</th>
                                                <th style="width: 100px;">Selecionar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="operador-sub-table-body">
                                            <!-- Linhas injetadas via JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="operador-sub-selected-chips" class="mt-2"></div>
                                <div class="form-text">O setor selecionado poderá receber materiais dos sub‑almoxarifados marcados.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6" id="setor-field" style="display: none;">
                            <label for="user-setor" class="form-label">Setor</label>
                            <select class="form-select" id="user-setor" name="setor_id">
                                <option value="">Selecione...</option>
                                {% for setor in setores %}
                                    <option value="{{ setor.id }}"
                                            data-sub-almoxarifado="{{ setor.sub_almoxarifado_id }}"
                                            data-almoxarifado="{{ setor.almoxarifado_id }}"
                                            data-central="{{ setor.central_id }}"
                                            data-sub-almoxarifado-ids="{{ setor.sub_almoxarifado_ids|join(',') }}"
                                            data-almoxarifado-ids="{{ setor.almoxarifado_ids|join(',') }}"
                                            data-central-ids="{{ setor.central_ids|join(',') }}">
                                        {{ setor.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Observação para Operador Setor -->
                        <div class="col-12" id="operador-setor-note" style="display: none;">
                            <div class="alert alert-info py-2 px-3 mb-0">
                                Observação: para o nível <strong>Operador Setor</strong>, não é necessário vincular um Sub‑Almoxarifado. 
                                Selecione diretamente o <strong>Setor</strong>. Você pode usar <strong>Central</strong> e <strong>Almoxarifado</strong> para filtrar os setores disponíveis.
                            </div>
                        </div>
                        
                        <div class="col-md-6" id="password-field">
                            <label for="user-password" class="form-label">Senha *</label>
                            <input type="password" class="form-control" id="user-password" name="password" required>
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        
                        {% if is_super_admin %}
                        <div class="col-12" id="categorias-especificas-section">
                            <label class="form-label">Categorias Específicas</label>
                            <div class="border rounded p-3">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <select class="form-select" id="categoria-adicionar">
                                            <option value="">Selecione uma categoria para adicionar...</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}">
                                                    {{ categoria.codigo }} - {{ categoria.nome }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-primary" onclick="adicionarCategoriaEspecifica()">
                                            <i class="fas fa-plus"></i> Adicionar
                                        </button>
                                    </div>
                                </div>
                                <div id="categorias-especificas-lista">
                                    <!-- Lista de categorias específicas será carregada aqui -->
                                </div>
                                <div class="form-text">
                                    Defina as categorias que o usuário terá acesso. Se nenhuma categoria for selecionada, 
                                    o usuário terá acesso a todas as categorias (apenas para administradores).
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <label for="user-ativo" class="form-label">Status</label>
                            <select class="form-select" id="user-ativo" name="ativo">
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isEditMode = false;

// Filtros
function applyFilters() {
    const nivelFilter = document.getElementById('filter-nivel').value;
    const statusFilter = document.getElementById('filter-status').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();
    
    const rows = document.querySelectorAll('#users-table tbody tr');
    
    rows.forEach(row => {
        const nivel = row.getAttribute('data-nivel');
        const status = row.getAttribute('data-status');
        const searchText = row.getAttribute('data-search');
        
        let show = true;
        
        if (nivelFilter && nivel !== nivelFilter) show = false;
        if (statusFilter && status !== statusFilter) show = false;
        if (searchFilter && !searchText.includes(searchFilter)) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('filter-nivel').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-search').value = '';
    applyFilters();
}

// Event listeners para filtros
document.getElementById('filter-nivel').addEventListener('change', applyFilters);
document.getElementById('filter-status').addEventListener('change', applyFilters);
document.getElementById('filter-search').addEventListener('input', applyFilters);

// Modal de usuário
const IS_SUPER_ADMIN = "{{ 'true' if is_super_admin else 'false' }}" === 'true';
function openUserModal(userId = null) {
    isEditMode = !!userId;
    const modal = document.getElementById('userModal');
    const title = document.getElementById('userModalTitle');
    const form = document.getElementById('userForm');
    const passwordField = document.getElementById('password-field');
    
    // Reset form
    form.reset();
    document.getElementById('user-id').value = '';
    
    // Limpar categorias temporárias e reexibir todas as opções
    categoriasSelecionadas = [];
    const select = document.getElementById('categoria-adicionar');
    const options = select.querySelectorAll('option');
    options.forEach(option => {
        if (option.value) option.style.display = '';
    });
    
    if (isEditMode) {
        title.textContent = 'Editar Usuário';
        passwordField.style.display = 'none';
        document.getElementById('user-password').required = false;
        // Carregar dados do usuário via AJAX
        loadUserData(userId);
    } else {
        title.textContent = 'Novo Usuário';
        passwordField.style.display = 'block';
        document.getElementById('user-password').required = true;
        // Limpar lista de categorias para novo usuário
        carregarCategoriasEspecificas();
    }
    
    // Se não for super admin, desabilitar campos sensíveis, mas manter hierarquia visível
    if (!IS_SUPER_ADMIN) {
        document.getElementById('user-nivel').setAttribute('disabled', 'disabled');
        document.getElementById('user-ativo').setAttribute('disabled', 'disabled');
        // Campos de hierarquia permanecem visíveis e serão filtrados pelos listeners
    }

    updateHierarchyFields();
    // Carregar listas dinâmicas via API caso o template tenha vindo vazio
    (async function preloadHierarchyOptions() {
        try {
            await ensureHierarchyOptionsLoaded();
            // Garantir que o select de Categorias Específicas seja populado dinamicamente
            try { await ensureCategoryOptionsLoaded(); } catch (_) {}
            // Após carregar, aplicar filtros e inicializar tabelas múltiplas
            try { onUserCentralChange(); } catch (_) {}
            try { onUserAlmoxChange(); } catch (_) {}
            try { initOperadorAlmoxTable(); refreshOperadorAlmoxTable(); onOperadorAlmoxMultiChange(); } catch (_) {}
            try { initOperadorSubTable(); refreshOperadorSubTable(); } catch (_) {}
        } catch (e) {
            console.warn('Falha ao carregar hierarquia dinamicamente:', e);
        }
    })();
    // Listeners de selects dependentes
    const centralSelect = document.getElementById('user-central');
    const almoxSelect = document.getElementById('user-almoxarifado');
    if (centralSelect) centralSelect.addEventListener('change', onUserCentralChange);
    if (almoxSelect) almoxSelect.addEventListener('change', onUserAlmoxChange);
    // Quando o Sub-Almoxarifado mudar, atualizar a lista de Setores
    const subSelect = document.getElementById('user-sub-almoxarifado');
    if (subSelect) {
        subSelect.removeEventListener('change', onUserAlmoxChange);
        subSelect.addEventListener('change', onUserAlmoxChange);
    }
    // Ao mudar Setor, sincronizar sub‑almoxarifados que ele recebe produtos
    const setorSelect = document.getElementById('user-setor');
    if (setorSelect) {
        setorSelect.addEventListener('change', function(){
            try { syncOperadorSubsFromSetor(); } catch (_) {}
            try { refreshOperadorSubTable(); } catch (_) {}
        });
    }
    // Aplicar filtros iniciais
    onUserCentralChange();
    onUserAlmoxChange();

    // Normalização global dos pais de Sub‑Almoxarifados (sequencial → ObjectId)
    // Executa uma vez ao abrir o modal para evitar inconsistências futuras.
    (async function normalizeSubSelectParents() {
        try {
            const almoxSelect = document.getElementById('user-almoxarifado');
            const subSelect = document.getElementById('user-sub-almoxarifado');
            if (!almoxSelect || !subSelect) return;
            const knownAlmoxIds = new Set();
            almoxSelect.querySelectorAll('option').forEach(opt => {
                const v = String(opt.value || '');
                if (v) knownAlmoxIds.add(v);
            });
            const subOptions = Array.from(subSelect.querySelectorAll('option'));
            const toMap = [];
            subOptions.forEach((opt, idx) => {
                if (idx === 0) return;
                const parentId = String(opt.getAttribute('data-almoxarifado') || '');
                if (!parentId) return;
                const looksSeq = /^[0-9]+$/.test(parentId);
                const unknownToKnown = !knownAlmoxIds.has(parentId);
                if (looksSeq || unknownToKnown) {
                    toMap.push(parentId);
                }
            });
            const unique = [...new Set(toMap.filter(Boolean))];
            if (unique.length === 0) return;
            const results = await Promise.all(unique.map(id => fetchJson(`/api/almoxarifados/${encodeURIComponent(id)}`).catch(() => null)));
            for (let i = 0; i < unique.length; i++) {
                const resp = results[i];
                if (!resp) continue;
                const rawId = String(resp.id || '');
                if (!rawId) continue;
                subOptions.forEach((opt, idx) => {
                    if (idx === 0) return;
                    const parentId = String(opt.getAttribute('data-almoxarifado') || '');
                    if (parentId === unique[i]) {
                        opt.setAttribute('data-almoxarifado', rawId);
                    }
                });
            }
            // Reaplicar filtros após normalização
            onUserAlmoxChange();
        } catch (e) {
            console.warn('Falha ao normalizar pais de Sub‑Almoxarifado (global):', e);
        }
    })();
    
    // Abrir o modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}

// Fallback dinâmico: popula selects de Central, Almoxarifado, Sub‑Almoxarifado e Setor via API
async function ensureHierarchyOptionsLoaded() {
    const centralSelect = document.getElementById('user-central');
    const almoxSelect = document.getElementById('user-almoxarifado');
    const subSelect = document.getElementById('user-sub-almoxarifado');
    const setorSelect = document.getElementById('user-setor');

    // Helper para verificar se há mais de uma opção real (além de "Selecione...")
    const hasRealOptions = (selectEl) => {
        if (!selectEl) return false;
        const opts = Array.from(selectEl.querySelectorAll('option'));
        return opts.some((opt, idx) => idx > 0 && (opt.value || '').trim() !== '');
    };

    // Carregar Centrais
    if (centralSelect && !hasRealOptions(centralSelect)) {
        try {
            const resp = await fetchJson('/api/centrais?per_page=1000');
            const items = (resp && resp.items) ? resp.items : [];
            const prev = centralSelect.value;
            centralSelect.innerHTML = '<option value="">Selecione...</option>' + items.map(c => `
                <option value="${String(c.id)}">${c.nome || c.id}</option>
            `).join('');
            if (prev) centralSelect.value = prev;
        } catch (e) {
            console.warn('Não foi possível carregar centrais via API:', e);
        }
    }

    // Carregar Almoxarifados
    if (almoxSelect && !hasRealOptions(almoxSelect)) {
        try {
            const resp = await fetchJson('/api/almoxarifados?per_page=1000');
            const items = (resp && resp.items) ? resp.items : [];
            const prev = almoxSelect.value;
            almoxSelect.innerHTML = '<option value="">Selecione...</option>' + items.map(a => `
                <option value="${String(a.id)}" data-central="${String(a.central_id ?? '')}">${a.nome || a.id}</option>
            `).join('');
            if (prev) almoxSelect.value = prev;
        } catch (e) {
            console.warn('Não foi possível carregar almoxarifados via API:', e);
        }
    }

    // Carregar Sub‑Almoxarifados
    if (subSelect && !hasRealOptions(subSelect)) {
        try {
            const resp = await fetchJson('/api/sub-almoxarifados?per_page=1000');
            const items = (resp && resp.items) ? resp.items : [];
            const prev = subSelect.value;
            subSelect.innerHTML = '<option value="">Selecione...</option>' + items.map(s => `
                <option value="${String(s.id)}" data-almoxarifado="${String(s.almoxarifado_id ?? '')}">${s.nome || s.id}</option>
            `).join('');
            if (prev) subSelect.value = prev;
        } catch (e) {
            console.warn('Não foi possível carregar sub‑almoxarifados via API:', e);
        }
    }

    // Carregar Setores
    if (setorSelect && !hasRealOptions(setorSelect)) {
        try {
            const resp = await fetchJson('/api/setores?per_page=1000');
            const items = (resp && resp.items) ? resp.items : [];
            const prev = setorSelect.value;
            setorSelect.innerHTML = '<option value="">Selecione...</option>' + items.map(s => {
                const subIds = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids.map(String).join(',') : '';
                const almoxIds = Array.isArray(s.almoxarifado_ids) ? s.almoxarifado_ids.map(String).join(',') : '';
                const centralIds = Array.isArray(s.central_ids) ? s.central_ids.map(String).join(',') : '';
                return `
                    <option value="${String(s.id)}"
                            data-sub-almoxarifado="${String(s.sub_almoxarifado_id ?? '')}"
                            data-almoxarifado="${String(s.almoxarifado_id ?? '')}"
                            data-central="${String(s.central_id ?? '')}"
                            data-sub-almoxarifado-ids="${subIds}"
                            data-almoxarifado-ids="${almoxIds}"
                            data-central-ids="${centralIds}">${s.nome || s.id}</option>`;
            }).join('');
            if (prev) setorSelect.value = prev;
        } catch (e) {
            console.warn('Não foi possível carregar setores via API:', e);
        }
    }
}

// Fallback dinâmico: popula o select de Categorias Específicas via API quando vazio
async function ensureCategoryOptionsLoaded() {
    const select = document.getElementById('categoria-adicionar');
    if (!select) return; // Seção visível apenas para super admin
    const opts = Array.from(select.querySelectorAll('option'));
    const hasReal = opts.some((opt, idx) => idx > 0 && (opt.value || '').trim() !== '');
    if (hasReal) return;
    try {
        const resp = await fetchJson('/api/categorias?per_page=1000');
        const items = (resp && resp.items) ? resp.items : [];
        const prev = select.value;
        select.innerHTML = '<option value="">Selecione uma categoria para adicionar...</option>' + items.map(c => {
            const id = String(c.id || c._id || '');
            const nome = c.nome || id;
            const codigo = c.codigo ? String(c.codigo) + ' - ' : '';
            return `<option value="${id}">${codigo}${nome}</option>`;
        }).join('');
        if (prev) select.value = prev;
    } catch (e) {
        console.warn('Não foi possível carregar categorias via API:', e);
    }
}

function updateHierarchyFields() {
    const nivel = document.getElementById('user-nivel').value;
    const operadorNote = document.getElementById('operador-setor-note');
    
    // Sempre esconder todos os campos inicialmente
    document.getElementById('central-field').style.display = 'none';
    document.getElementById('almoxarifado-field').style.display = 'none';
    document.getElementById('sub-almoxarifado-field').style.display = 'none';
    const operadorSubMultiField = document.getElementById('operador-sub-multi-field');
    if (operadorSubMultiField) operadorSubMultiField.style.display = 'none';
    const operadorAlmoxMultiField = document.getElementById('operador-almox-multi-field');
    if (operadorAlmoxMultiField) operadorAlmoxMultiField.style.display = 'none';
    document.getElementById('setor-field').style.display = 'none';
    if (operadorNote) operadorNote.style.display = 'none';
    
    // Permitir exibição dos campos mesmo para não‑super admins;
    // filtros e listeners já limitam conforme Central/Almox selecionados.
    
    // Mostrar campos baseado no nível
    switch(nivel) {
        case 'admin_central':
            document.getElementById('central-field').style.display = 'block';
            break;
        case 'gerente_almox':
            document.getElementById('central-field').style.display = 'block';
            document.getElementById('almoxarifado-field').style.display = 'block';
            break;
        case 'resp_sub_almox':
            document.getElementById('central-field').style.display = 'block';
            document.getElementById('almoxarifado-field').style.display = 'block';
            document.getElementById('sub-almoxarifado-field').style.display = 'block';
            break;
        case 'operador_setor':
            document.getElementById('central-field').style.display = 'block';
            // Substituir select simples por tabela de múltiplos Almoxarifados
            if (operadorAlmoxMultiField) operadorAlmoxMultiField.style.display = 'block';
            // Para Operador Setor, usar tabela de múltiplos Sub‑Almoxarifados
            if (operadorSubMultiField) operadorSubMultiField.style.display = 'block';
            document.getElementById('setor-field').style.display = 'block';
            if (operadorNote) operadorNote.style.display = 'block';
            // Reaplicar filtros para garantir que o select de Setor apareça
            // imediatamente após a seleção do nível de acesso.
            try { onUserCentralChange(); } catch (_) {}
            try { initOperadorAlmoxTable(); refreshOperadorAlmoxTable(); onOperadorAlmoxMultiChange(); } catch (_) {}
            try { initOperadorSubTable(); refreshOperadorSubTable(); } catch (_) {}
            break;
    }
}

// ================= Operador Setor: Tabela múltipla de Almoxarifados =================
let operadorAlmoxSelecionados = [];
let operadorAlmoxTableInitialized = false;

function initOperadorAlmoxTable() {
    if (operadorAlmoxTableInitialized) return;
    const body = document.getElementById('operador-almox-table-body');
    if (!body) return;

    const almoxSelect = document.getElementById('user-almoxarifado');
    const centralSelect = document.getElementById('user-central');
    const centralNomePorId = {};

    // Mapear nomes de centrais do select
    if (centralSelect) {
        centralSelect.querySelectorAll('option').forEach(opt => {
            const val = opt.value;
            const nome = opt.textContent.trim();
            if (val) centralNomePorId[String(val)] = nome;
        });
    }

    const rows = [];
    if (almoxSelect) {
        almoxSelect.querySelectorAll('option').forEach((opt, idx) => {
            if (idx === 0) return;
            const id = opt.value;
            const nome = opt.textContent.trim();
            const centralId = opt.getAttribute('data-central') || '';
            const centralNome = centralNomePorId[String(centralId)] || centralId || '';
            rows.push({ id, nome, centralId, centralNome });
        });
    }

    body.innerHTML = rows.map(r => `
        <tr data-id="${r.id}" data-central="${r.centralId}">
            <td>${r.id}</td>
            <td>${r.nome}</td>
            <td>${r.centralNome}</td>
            <td>
                <input type="checkbox" class="form-check-input operador-almox-check" value="${r.id}">
            </td>
        </tr>
    `).join('');

    // Listeners de seleção
    body.querySelectorAll('.operador-almox-check').forEach(chk => {
        chk.addEventListener('change', function() {
            const id = this.value;
            if (this.checked) {
                if (!operadorAlmoxSelecionados.includes(id)) operadorAlmoxSelecionados.push(id);
            } else {
                operadorAlmoxSelecionados = operadorAlmoxSelecionados.filter(v => String(v) !== String(id));
            }
            renderOperadorAlmoxChips();
            try { onOperadorAlmoxMultiChange(); } catch (_) {}
            try { refreshOperadorSubTable(); } catch (_) {}
        });
    });

    // Botões utilitários
    const btnAll = document.getElementById('operador-almox-select-all');
    const btnClear = document.getElementById('operador-almox-clear');
    const search = document.getElementById('operador-almox-search');
    if (btnAll) btnAll.addEventListener('click', function(){
        document.querySelectorAll('#operador-almox-table-body tr').forEach(row => {
            if (row.style.display === 'none') return;
            const chk = row.querySelector('.operador-almox-check');
            if (!chk) return;
            chk.checked = true;
            const id = chk.value;
            if (!operadorAlmoxSelecionados.includes(id)) operadorAlmoxSelecionados.push(id);
        });
        renderOperadorAlmoxChips();
        try { onOperadorAlmoxMultiChange(); } catch (_) {}
        try { refreshOperadorSubTable(); } catch (_) {}
    });
    if (btnClear) btnClear.addEventListener('click', function(){
        operadorAlmoxSelecionados = [];
        document.querySelectorAll('#operador-almox-table-body .operador-almox-check').forEach(chk => { chk.checked = false; });
        renderOperadorAlmoxChips();
        try { onOperadorAlmoxMultiChange(); } catch (_) {}
        try { refreshOperadorSubTable(); } catch (_) {}
    });
    if (search) search.addEventListener('input', refreshOperadorAlmoxTable);

    operadorAlmoxTableInitialized = true;
}

function refreshOperadorAlmoxTable() {
    const centralId = document.getElementById('user-central')?.value || '';
    const term = (document.getElementById('operador-almox-search')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('#operador-almox-table-body tr');
    let anyVisible = false;
    rows.forEach(row => {
        const cId = row.getAttribute('data-central') || '';
        const nome = row.children[1]?.textContent?.toLowerCase() || '';
        let show = centralId ? (String(cId) === String(centralId)) : true;
        if (term) show = show && nome.includes(term);
        row.style.display = show ? '' : 'none';
        if (show) anyVisible = true;
    });
    // Se nada visível com a central atual, tentar normalizar ID da central
    if (centralId && !anyVisible) {
        fetchJson(`/api/centrais/${encodeURIComponent(centralId)}`)
            .then(data => {
                const mappedCentral = String(data.id || centralId);
                rows.forEach(row => {
                    const cId = row.getAttribute('data-central') || '';
                    const nome = row.children[1]?.textContent?.toLowerCase() || '';
                    let show = String(cId) === String(mappedCentral);
                    if (term) show = show && nome.includes(term);
                    row.style.display = show ? '' : 'none';
                });
            })
            .catch(() => { /* no-op */ });
    }
}

function renderOperadorAlmoxChips() {
    const container = document.getElementById('operador-almox-selected-chips');
    if (!container) return;
    container.innerHTML = '';
    if (operadorAlmoxSelecionados.length === 0) {
        container.innerHTML = '<div class="text-muted">Nenhum almoxarifado selecionado</div>';
        return;
    }
    operadorAlmoxSelecionados.forEach(id => {
        const row = document.querySelector(`#operador-almox-table-body tr[data-id="${CSS.escape(String(id))}"]`);
        const nome = row ? (row.children[1]?.textContent || id) : id;
        const chip = document.createElement('div');
        chip.className = 'badge bg-secondary me-2 mb-2 d-inline-flex align-items-center';
        chip.innerHTML = `${nome}<button type="button" class="btn-close btn-close-white ms-2" aria-label="Remover"></button>`;
        chip.querySelector('button').addEventListener('click', function(){
            operadorAlmoxSelecionados = operadorAlmoxSelecionados.filter(v => String(v) !== String(id));
            const chk = document.querySelector(`#operador-almox-table-body .operador-almox-check[value="${CSS.escape(String(id))}"]`);
            if (chk) chk.checked = false;
            renderOperadorAlmoxChips();
            try { onOperadorAlmoxMultiChange(); } catch (_) {}
            try { refreshOperadorSubTable(); } catch (_) {}
        });
        container.appendChild(chip);
    });
}

function onOperadorAlmoxMultiChange() {
    const setorSelect = document.getElementById('user-setor');
    const centralId = document.getElementById('user-central')?.value || '';
    if (!setorSelect) return;
    const setorOptions = setorSelect.querySelectorAll('option');
    const selectedSubs = operadorSubsSelecionados.slice().map(String);
    const selectedAlmox = operadorAlmoxSelecionados.slice().map(String);

    let setorVisible = 0;
    setorOptions.forEach((opt, idx) => {
        if (idx === 0) return;
        const sid = opt.getAttribute('data-sub-almoxarifado') || '';
        const aid = opt.getAttribute('data-almoxarifado') || '';
        const cid = opt.getAttribute('data-central') || '';
        const sidMulti = (opt.getAttribute('data-sub-almoxarifado-ids') || '').split(',').filter(Boolean);
        const aidMulti = (opt.getAttribute('data-almoxarifado-ids') || '').split(',').filter(Boolean);
        const cidMulti = (opt.getAttribute('data-central-ids') || '').split(',').filter(Boolean);
        let show = false;
        if (selectedSubs.length > 0) {
            const matchSub = selectedSubs.some(x => String(sid) === String(x) || sidMulti.includes(String(x)));
            show = matchSub;
        } else if (selectedAlmox.length > 0) {
            const matchAlmox = selectedAlmox.some(x => String(aid) === String(x) || aidMulti.includes(String(x)));
            show = matchAlmox;
        } else if (centralId) {
            const matchCentral = String(cid) === String(centralId) || cidMulti.includes(String(centralId));
            show = matchCentral;
        } else {
            show = true;
        }
        opt.style.display = show ? '' : 'none';
        if (show) setorVisible++;
    });

    const selectedSetor = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
    if (selectedSetor && selectedSetor.style.display === 'none') {
        setorSelect.value = '';
    }
    setorSelect.disabled = setorVisible === 0;

    // Fallbacks: normalizar Central quando necessário
    const onlyCentralFiltering = !!centralId && selectedAlmox.length === 0 && selectedSubs.length === 0 && setorVisible === 0;
    if (onlyCentralFiltering) {
        fetchJson(`/api/centrais/${encodeURIComponent(centralId)}`)
            .then(data => {
                const mappedCentral = String(data.id || centralId);
                let setorVisible2 = 0;
                setorOptions.forEach((opt, idx) => {
                    if (idx === 0) return;
                    const cid = opt.getAttribute('data-central') || '';
                    const cidMulti = (opt.getAttribute('data-central-ids') || '').split(',').filter(Boolean);
                    const show = String(cid) === String(mappedCentral) || cidMulti.includes(String(mappedCentral));
                    opt.style.display = show ? '' : 'none';
                    if (show) setorVisible2++;
                });
                const selectedSetor2 = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
                if (selectedSetor2 && selectedSetor2.style.display === 'none') {
                    setorSelect.value = '';
                }
                setorSelect.disabled = setorVisible2 === 0;
            })
            .catch(() => { /* no-op */ });
    }

    try { syncOperadorSubsFromSetor(); } catch (_) {}
}

// ================= Operador Setor: Tabela múltipla de Sub‑Almoxarifados =================
let operadorSubsSelecionados = [];
let operadorSubTableInitialized = false;

function initOperadorSubTable() {
    if (operadorSubTableInitialized) return;
    const body = document.getElementById('operador-sub-table-body');
    if (!body) return;

    // Mapear nomes de almoxarifado
    const almoxSelect = document.getElementById('user-almoxarifado');
    const almoxNomePorId = {};
    const almoxCentralPorId = {};
    if (almoxSelect) {
        almoxSelect.querySelectorAll('option').forEach(opt => {
            const val = opt.value;
            const nome = opt.textContent.trim();
            if (val) {
                almoxNomePorId[String(val)] = nome;
                almoxCentralPorId[String(val)] = opt.getAttribute('data-central') || '';
            }
        });
    }

    // Construir linhas a partir do select de sub‑almoxarifados já fornecido pelo template
    const subSelect = document.getElementById('user-sub-almoxarifado');
    const rows = [];
    subSelect.querySelectorAll('option').forEach((opt, idx) => {
        if (idx === 0) return;
        const id = opt.value;
        const nome = opt.textContent.trim();
        const almoxId = opt.getAttribute('data-almoxarifado') || '';
        const almoxNome = almoxNomePorId[String(almoxId)] || almoxId || '';
        rows.push({ id, nome, almoxId, almoxNome });
    });

    // Montar tabela
    body.innerHTML = rows.map(r => `
        <tr data-id="${r.id}" data-almox="${r.almoxId}" data-central="${almoxCentralPorId[String(r.almoxId)] || ''}">
            <td>${r.id}</td>
            <td>${r.nome}</td>
            <td>${r.almoxNome}</td>
            <td>
                <input type="checkbox" class="form-check-input operador-sub-check" value="${r.id}">
            </td>
        </tr>
    `).join('');

    // Listeners de seleção
    body.querySelectorAll('.operador-sub-check').forEach(chk => {
        chk.addEventListener('change', function() {
            const id = this.value;
            if (this.checked) {
                if (!operadorSubsSelecionados.includes(id)) operadorSubsSelecionados.push(id);
            } else {
                operadorSubsSelecionados = operadorSubsSelecionados.filter(v => String(v) !== String(id));
            }
            renderOperadorSubChips();
        });
    });

    // Botões utilitários
    const btnAll = document.getElementById('operador-sub-select-all');
    const btnClear = document.getElementById('operador-sub-clear');
    const search = document.getElementById('operador-sub-search');
    if (btnAll) btnAll.addEventListener('click', function(){
        // Selecionar apenas os visíveis (pertencentes à Central e filtros atuais)
        document.querySelectorAll('#operador-sub-table-body tr').forEach(row => {
            if (row.style.display === 'none') return;
            const chk = row.querySelector('.operador-sub-check');
            if (!chk) return;
            chk.checked = true;
            const id = chk.value;
            if (!operadorSubsSelecionados.includes(id)) operadorSubsSelecionados.push(id);
        });
        renderOperadorSubChips();
    });
    if (btnClear) btnClear.addEventListener('click', function(){
        operadorSubsSelecionados = [];
        document.querySelectorAll('#operador-sub-table-body .operador-sub-check').forEach(chk => { chk.checked = false; });
        renderOperadorSubChips();
    });
    if (search) search.addEventListener('input', refreshOperadorSubTable);

    // Normalizar IDs e Central das linhas (corrige mismatch entre sequenciais e ObjectId)
    (async function normalizeOperadorSubRows() {
        try {
            const almoxSelect = document.getElementById('user-almoxarifado');
            if (!almoxSelect) return;
            const knownAlmoxIds = new Set();
            almoxSelect.querySelectorAll('option').forEach(opt => knownAlmoxIds.add(String(opt.value)));

            const tableRows = Array.from(document.querySelectorAll('#operador-sub-table-body tr'));
            const unknownIds = [...new Set(tableRows
                .map(r => String(r.getAttribute('data-almox') || ''))
                .filter(id => id && !knownAlmoxIds.has(id))
            )];

            if (unknownIds.length === 0) return;

            const results = await Promise.all(unknownIds.map(id => fetchJson(`/api/almoxarifados/${encodeURIComponent(id)}`).catch(() => null)));
            for (let i = 0; i < unknownIds.length; i++) {
                const resp = results[i];
                if (!resp) continue;
                const normalizedId = String(resp.id || '');
                const centralId = String(resp.central_id ?? '');

                let normalizedName = normalizedId;
                const opt = almoxSelect.querySelector(`option[value="${CSS.escape(normalizedId)}"]`);
                if (opt) normalizedName = opt.textContent.trim();

                document.querySelectorAll(`#operador-sub-table-body tr[data-almox="${CSS.escape(unknownIds[i])}"]`).forEach(row => {
                    row.setAttribute('data-almox', normalizedId);
                    row.setAttribute('data-central', centralId);
                    const cellName = row.children[2];
                    if (cellName) cellName.textContent = normalizedName;
                });
            }
            // Reaplicar filtro após normalização
            refreshOperadorSubTable();
        } catch (e) {
            console.warn('Falha ao normalizar linhas de Sub‑Almoxarifados:', e);
        }
    })();

    operadorSubTableInitialized = true;
}

function refreshOperadorSubTable() {
    const almoxIdSingle = document.getElementById('user-almoxarifado')?.value || '';
    const centralId = document.getElementById('user-central')?.value || '';
    const setorId = document.getElementById('user-setor')?.value || '';
    const term = (document.getElementById('operador-sub-search')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('#operador-sub-table-body tr');
    const almoxIds = (operadorAlmoxSelecionados && operadorAlmoxSelecionados.length > 0)
        ? operadorAlmoxSelecionados.slice().map(String)
        : (almoxIdSingle ? [String(almoxIdSingle)] : []);
    const applyAlmoxFilter = almoxIds.length > 0 && !setorId; // Quando Setor está selecionado, não restringir por Almox
    let effectiveCentralId = centralId;
    let anyVisible = false;
    rows.forEach(row => {
        const aId = row.getAttribute('data-almox') || '';
        const cId = row.getAttribute('data-central') || '';
        const nome = row.children[1]?.textContent?.toLowerCase() || '';
        let show = !!effectiveCentralId && (String(cId) === String(effectiveCentralId));
        if (applyAlmoxFilter) show = show && (almoxIds.some(x => String(aId) === String(x)));
        if (term) show = show && nome.includes(term);
        row.style.display = show ? '' : 'none';
        if (show) anyVisible = true;
    });

    // Fallback: se nada visível com a central atual, tentar normalizar ID da central
    if (centralId && !anyVisible) {
        fetchJson(`/api/centrais/${encodeURIComponent(centralId)}`)
            .then(data => {
                effectiveCentralId = String(data.id || centralId);
                let anyVisible2 = false;
                rows.forEach(row => {
                    const aId = row.getAttribute('data-almox') || '';
                    const cId = row.getAttribute('data-central') || '';
                    const nome = row.children[1]?.textContent?.toLowerCase() || '';
                    let show = !!effectiveCentralId && (String(cId) === String(effectiveCentralId));
                    if (applyAlmoxFilter) show = show && (almoxIds.some(x => String(aId) === String(x)));
                    if (term) show = show && nome.includes(term);
                    row.style.display = show ? '' : 'none';
                    if (show) anyVisible2 = true;
                });
                // Podar/atualizar seleção após refiltro
                const visibleIds = new Set();
                rows.forEach(row => { if (row.style.display !== 'none') visibleIds.add(String(row.getAttribute('data-id') || '')); });
                const before = operadorSubsSelecionados.slice();
                operadorSubsSelecionados = operadorSubsSelecionados.filter(id => visibleIds.has(String(id)));
                document.querySelectorAll('#operador-sub-table-body .operador-sub-check').forEach(chk => {
                    chk.checked = operadorSubsSelecionados.includes(chk.value) && (chk.closest('tr').style.display !== 'none');
                });
                const changed = before.length !== operadorSubsSelecionados.length || before.some((v,i) => v !== operadorSubsSelecionados[i]);
                if (changed) renderOperadorSubChips();
            })
            .catch(() => { /* ignora */ });
    }

    // Podar seleção para IDs visíveis e sincronizar checkboxes/chips
    const visibleIds = new Set();
    rows.forEach(row => { if (row.style.display !== 'none') visibleIds.add(String(row.getAttribute('data-id') || '')); });
    const before = operadorSubsSelecionados.slice();
    operadorSubsSelecionados = operadorSubsSelecionados.filter(id => visibleIds.has(String(id)));
    // Atualizar checkboxes conforme seleção
    document.querySelectorAll('#operador-sub-table-body .operador-sub-check').forEach(chk => {
        chk.checked = operadorSubsSelecionados.includes(chk.value) && (chk.closest('tr').style.display !== 'none');
    });
    // Se houve alteração, re-render chips
    const changed = before.length !== operadorSubsSelecionados.length || before.some((v,i) => v !== operadorSubsSelecionados[i]);
    if (changed) renderOperadorSubChips();
}

function renderOperadorSubChips() {
    const container = document.getElementById('operador-sub-selected-chips');
    if (!container) return;
    container.innerHTML = '';
    if (operadorSubsSelecionados.length === 0) {
        container.innerHTML = '<div class="text-muted">Nenhum sub‑almoxarifado selecionado</div>';
        return;
    }
    operadorSubsSelecionados.forEach(id => {
        const row = document.querySelector(`#operador-sub-table-body tr[data-id="${CSS.escape(String(id))}"]`);
        const nome = row ? (row.children[1]?.textContent || id) : id;
        const chip = document.createElement('div');
        chip.className = 'badge bg-secondary me-2 mb-2 d-inline-flex align-items-center';
        chip.innerHTML = `${nome}<button type="button" class="btn-close btn-close-white ms-2" aria-label="Remover"></button>`;
        chip.querySelector('button').addEventListener('click', function(){
            operadorSubsSelecionados = operadorSubsSelecionados.filter(v => String(v) !== String(id));
            const chk = document.querySelector(`#operador-sub-table-body .operador-sub-check[value="${CSS.escape(String(id))}"]`);
            if (chk) chk.checked = false;
            renderOperadorSubChips();
        });
        container.appendChild(chip);
    });
}

function syncOperadorSubsFromSetor() {
    const setorSelect = document.getElementById('user-setor');
    if (!setorSelect) return;
    const opt = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
    const idsStr = opt ? (opt.getAttribute('data-sub-almoxarifado-ids') || '') : '';
    const ids = idsStr.split(',').filter(Boolean);
    operadorSubsSelecionados = ids.slice();
    // Marcar checkboxes
    document.querySelectorAll('#operador-sub-table-body .operador-sub-check').forEach(chk => {
        chk.checked = operadorSubsSelecionados.includes(chk.value);
    });
    renderOperadorSubChips();

    // Fallback: se não houver dados no option, buscar do endpoint de Setor
    if (operadorSubsSelecionados.length === 0 && setorSelect.value) {
        fetchJson(`/api/setores/${encodeURIComponent(setorSelect.value)}`)
            .then(resp => {
                const arr = (resp && resp.sub_almoxarifado_ids) ? resp.sub_almoxarifado_ids : [];
                if (Array.isArray(arr) && arr.length > 0) {
                    operadorSubsSelecionados = arr.map(String);
                    document.querySelectorAll('#operador-sub-table-body .operador-sub-check').forEach(chk => {
                        chk.checked = operadorSubsSelecionados.includes(chk.value);
                    });
                    renderOperadorSubChips();
                }
            })
            .catch(err => console.warn('Não foi possível carregar vínculos de sub‑almoxarifados do Setor:', err));
    }
}

// Filtros dependentes: Central → Almoxarifado → Sub-Almoxarifado → Setor
function onUserCentralChange() {
    const centralSelect = document.getElementById('user-central');
    const almoxSelect = document.getElementById('user-almoxarifado');
    const subSelect = document.getElementById('user-sub-almoxarifado');
    const setorSelect = document.getElementById('user-setor');

    if (!centralSelect || !almoxSelect) return;

    const centralId = centralSelect.value || '';

    // Filtrar opções de almoxarifado pelo data-central com fallback de mapeamento
    const applyFilter = (matchId) => {
        const almoxOptions = almoxSelect.querySelectorAll('option');
        let visibleCount = 0;
        almoxOptions.forEach((opt, idx) => {
            if (idx === 0) return; // manter primeira opção "Selecione..."
            const optCentral = opt.getAttribute('data-central') || '';
            if (!matchId) {
                opt.style.display = ''; // sem central selecionada, mostrar todas
            } else {
                const show = (String(optCentral) === String(matchId));
                opt.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            }
        });
        return visibleCount;
    };

    // 1) Tenta com o valor do select (ObjectId ou sequencial em alguns casos)
    let visible = applyFilter(centralId);

    // 2) Se nada visível, buscar id normalizado da central via API e refiltrar
    const looksLikeOid = typeof centralId === 'string' && centralId.length === 24;
    const looksLikeSeq = /^[0-9]+$/.test(String(centralId));
    if (centralId && visible === 0 && (looksLikeOid || looksLikeSeq)) {
        fetch(`/api/centrais/${encodeURIComponent(centralId)}`)
            .then(r => r.ok ? r.json() : Promise.reject(new Error('Falha ao mapear central')))
            .then(data => {
                const mappedId = String(data.id || '');
                visible = applyFilter(mappedId);
                finalizeState();
            })
            .catch(() => {
                finalizeState();
            });
    } else {
        finalizeState();
    }

    function finalizeState() {
    
    // Resetar seleção se incompatível e controlar disabled
    const selectedAlmox = almoxSelect.querySelector(`option[value="${almoxSelect.value}"]`);
    if (selectedAlmox && selectedAlmox.style.display === 'none') {
        almoxSelect.value = '';
    }
    almoxSelect.disabled = !centralId || visible === 0;

    // Reset do Sub, mas o Setor deve usar fallback por Almox/Central
    if (subSelect) {
        subSelect.value = '';
        const subOptions = subSelect.querySelectorAll('option');
        subOptions.forEach((opt, idx) => { if (idx !== 0) opt.style.display = 'none'; });
        subSelect.disabled = !almoxSelect.value;
    }
    if (setorSelect) {
        onUserAlmoxChange();
    }
    // Atualizar tabela de subs (filtro por almox)
    try { refreshOperadorSubTable(); } catch (_) {}
    // Atualizar tabela de almox múltiplos e cascade de Setor, quando modo Operador Setor
    try { refreshOperadorAlmoxTable(); onOperadorAlmoxMultiChange(); } catch (_) {}
    }
}

function onUserAlmoxChange() {
    const almoxSelect = document.getElementById('user-almoxarifado');
    const subSelect = document.getElementById('user-sub-almoxarifado');
    const setorSelect = document.getElementById('user-setor');
    if (!almoxSelect || !subSelect) return;

    const almoxId = almoxSelect.value || '';
    const centralSelect = document.getElementById('user-central');
    const centralId = centralSelect ? (centralSelect.value || '') : '';

    // Filtrar sub-almoxarifados pelo data-almoxarifado, com fallback de mapeamento
    const subOptions = subSelect.querySelectorAll('option');
    let visibleCount = 0;
    subOptions.forEach((opt, idx) => {
        if (idx === 0) return;
        const parentId = opt.getAttribute('data-almoxarifado') || '';
        if (!almoxId) {
            opt.style.display = 'none';
        } else {
            const show = (String(parentId) === String(almoxId));
            opt.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        }
    });

    const looksLikeOid = typeof almoxId === 'string' && almoxId.length === 24;
    const looksLikeSeq = /^[0-9]+$/.test(String(almoxId));
    const refilterWith = (matchId) => {
        visibleCount = 0;
        subOptions.forEach((opt, idx) => {
            if (idx === 0) return;
            const parentId = opt.getAttribute('data-almoxarifado') || '';
            const show = !!matchId && (String(parentId) === String(matchId));
            opt.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        return visibleCount;
    };

    // Se nada ficou visível, tentar mapear o ID via API para normalizar (ObjectId ↔ sequencial)
    if (almoxId && visibleCount === 0 && (looksLikeOid || looksLikeSeq)) {
        fetchJson(`/api/almoxarifados/${encodeURIComponent(almoxId)}`)
            .then(data => {
                const seqId = String((data.id_normalized ?? '') || '');
                const rawId = String((data.id ?? '') || '');
                const normalizedVisible = refilterWith(seqId || rawId);
                // Caso ainda não haja opções visíveis, normalizar os parents dos Sub‑Almoxarifados (sequencial → ObjectId)
                if (normalizedVisible === 0) {
                    normalizeSubParentsByApi().then(() => {
                        const normalizedVisible2 = refilterWith(seqId || rawId);
                        finalizeState(seqId || almoxId, normalizedVisible2, rawId || almoxId);
                    }).catch(() => {
                        finalizeState(seqId || almoxId, normalizedVisible, rawId || almoxId);
                    });
                } else {
                    finalizeState(seqId || almoxId, normalizedVisible, rawId || almoxId);
                }
            })
            .catch(() => {
                finalizeState(almoxId, visibleCount, almoxId);
            });
    } else {
        finalizeState(almoxId, visibleCount, almoxId);
    }

    // Normaliza os atributos data-almoxarifado das opções do Sub‑Almoxarifado, convertendo IDs sequenciais para ObjectId
    function normalizeSubParentsByApi() {
        const uniqueSeqParents = new Set();
        subOptions.forEach((opt, idx) => {
            if (idx === 0) return;
            const parentId = opt.getAttribute('data-almoxarifado') || '';
            if (/^[0-9]+$/.test(String(parentId))) uniqueSeqParents.add(String(parentId));
        });
        if (uniqueSeqParents.size === 0) return Promise.resolve();
        const promises = Array.from(uniqueSeqParents).map(pid => {
            return fetchJson(`/api/almoxarifados/${encodeURIComponent(pid)}`).then(data => {
                const rawId = String((data.id ?? '') || '');
                if (rawId) {
                    subOptions.forEach((opt, idx) => {
                        if (idx === 0) return;
                        if (String(opt.getAttribute('data-almoxarifado') || '') === String(pid)) {
                            opt.setAttribute('data-almoxarifado', rawId);
                        }
                    });
                }
            }).catch(() => {});
        });
        return Promise.all(promises);
    }

    function finalizeState(normalizedAlmoxId, subVisible, rawAlmoxId) {
        // Resetar seleção e desabilitar se necessário
        const selectedSub = subSelect.querySelector(`option[value="${subSelect.value}"]`);
        if (selectedSub && selectedSub.style.display === 'none') {
            subSelect.value = '';
        }
        subSelect.disabled = !normalizedAlmoxId || subVisible === 0;

        // Cascade para setores, usando ID normalizado quando disponível
        if (setorSelect) {
            const subId = subSelect.value || '';
            const setorOptions = setorSelect.querySelectorAll('option');
            let setorVisible = 0;
            setorOptions.forEach((opt, idx) => {
                if (idx === 0) return;
                const sid = opt.getAttribute('data-sub-almoxarifado') || '';
                const aid = opt.getAttribute('data-almoxarifado') || '';
                const cid = opt.getAttribute('data-central') || '';
                const sidMulti = (opt.getAttribute('data-sub-almoxarifado-ids') || '').split(',').filter(Boolean);
                const aidMulti = (opt.getAttribute('data-almoxarifado-ids') || '').split(',').filter(Boolean);
                const cidMulti = (opt.getAttribute('data-central-ids') || '').split(',').filter(Boolean);
                let show = false;
                if (subId) {
                    const subMatch = String(sid) === String(subId) || sidMulti.includes(String(subId));
                    show = subMatch;
                } else if (normalizedAlmoxId) {
                    const almoxCandidates = [String(normalizedAlmoxId), String(rawAlmoxId || '')].filter(Boolean);
                    const almoxMatch = almoxCandidates.some(x => String(aid) === x || aidMulti.includes(x));
                    show = almoxMatch;
                } else if (centralId) {
                    const centralMatch = String(cid) === String(centralId) || cidMulti.includes(String(centralId));
                    show = centralMatch;
                } else {
                    // Sem filtro selecionado: mostrar todos os setores
                    show = true;
                }
                opt.style.display = show ? '' : 'none';
                if (show) setorVisible++;
            });
            const selectedSetor = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
            if (selectedSetor && selectedSetor.style.display === 'none') {
                setorSelect.value = '';
            }
            setorSelect.disabled = setorVisible === 0;

            // Fallback: se apenas central estiver selecionada e nada visível, tentar normalizar central
            const onlyCentralFiltering = !!centralId && !normalizedAlmoxId && !subId;
            if (onlyCentralFiltering && setorVisible === 0) {
                fetchJson(`/api/centrais/${encodeURIComponent(centralId)}`)
                    .then(data => {
                        const mappedCentral = String(data.id || centralId);
                        let setorVisible2 = 0;
                        setorOptions.forEach((opt, idx) => {
                            if (idx === 0) return;
                            const cid = opt.getAttribute('data-central') || '';
                            const cidMulti = (opt.getAttribute('data-central-ids') || '').split(',').filter(Boolean);
                            const show = String(cid) === String(mappedCentral) || cidMulti.includes(String(mappedCentral));
                            opt.style.display = show ? '' : 'none';
                            if (show) setorVisible2++;
                        });
                        const selectedSetor2 = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
                        if (selectedSetor2 && selectedSetor2.style.display === 'none') {
                            setorSelect.value = '';
                        }
                        setorSelect.disabled = setorVisible2 === 0;
                    })
                    .catch(() => { /* no-op */ });
            }

            // Fallback: se almoxarifado estiver selecionado e nada visível, tentar normalizar almox e refiltrar
            const almoxFiltering = !!normalizedAlmoxId && setorVisible === 0;
            if (almoxFiltering) {
                const almoxIdToMap = String(rawAlmoxId || normalizedAlmoxId);
                fetchJson(`/api/almoxarifados/${encodeURIComponent(almoxIdToMap)}`)
                    .then(data => {
                        const seqId = String((data.id_normalized ?? '') || '');
                        const idRaw = String((data.id ?? '') || '');
                        let setorVisible3 = 0;
                        setorOptions.forEach((opt, idx) => {
                            if (idx === 0) return;
                            const aid = opt.getAttribute('data-almoxarifado') || '';
                            const aidMulti = (opt.getAttribute('data-almoxarifado-ids') || '').split(',').filter(Boolean);
                            const candidates = [seqId, idRaw].filter(Boolean);
                            const show = candidates.some(x => String(aid) === String(x) || aidMulti.includes(String(x)));
                            opt.style.display = show ? '' : 'none';
                            if (show) setorVisible3++;
                        });
                        const selectedSetor3 = setorSelect.querySelector(`option[value="${setorSelect.value}"]`);
                        if (selectedSetor3 && selectedSetor3.style.display === 'none') {
                            setorSelect.value = '';
                        }
                        setorSelect.disabled = setorVisible3 === 0;
                    })
                    .catch(() => { /* no-op */ });
            }
        }
        // Ao mudar listas, sincronizar seleção de subs a partir do setor
        try { syncOperadorSubsFromSetor(); } catch (_) {}
    }
}

// Funções CRUD
function editUser(userId) {
    openUserModal(userId);
}

function loadUserData(userId) {
    fetchJson(`/api/usuarios/${userId}`)
        .then(user => {
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-nome').value = user.nome_completo;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-nivel').value = user.nivel_acesso;
            document.getElementById('user-ativo').value = user.ativo.toString();
            
            // Definir hierarquia
            if (user.central_id) document.getElementById('user-central').value = user.central_id;
            if (user.almoxarifado_id) document.getElementById('user-almoxarifado').value = user.almoxarifado_id;
            if (user.sub_almoxarifado_id) document.getElementById('user-sub-almoxarifado').value = user.sub_almoxarifado_id;
            if (user.setor_id) document.getElementById('user-setor').value = user.setor_id;
            
            updateHierarchyFields();
            // Aplicar filtros iniciais conforme valores carregados
            onUserCentralChange();
            onUserAlmoxChange();
            
            // Carregar categorias específicas
            carregarCategoriasEspecificas();
        })
        .catch(error => {
            console.error('Erro ao carregar usuário:', error);
            alert(error.message || 'Erro ao carregar dados do usuário');
        });
}

function toggleUserStatus(userId) {
    if (confirm('Tem certeza que deseja alterar o status deste usuário?')) {
        fetchJson(`/api/usuarios/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(data => {
            alert(data.message || 'Status alterado com sucesso');
            location.reload();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert(error.message || 'Erro ao alterar status do usuário');
        });
    }
}

function resetPassword(userId) {
    openResetPasswordModal(userId);
}

// CSS para modal de reset de senha injetado via JS
const resetPwdModalStyle = document.createElement('style');
resetPwdModalStyle.textContent = `
    .custom-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .custom-modal.show { display: flex; }
    .custom-modal-content { background: #fff; border-radius: 8px; padding: 16px; width: 100%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
`;
document.head.appendChild(resetPwdModalStyle);

// Criar modal de reset de senha via DOM
const resetPasswordModal = document.createElement('div');
resetPasswordModal.id = 'resetPasswordModal';
resetPasswordModal.className = 'custom-modal';
resetPasswordModal.innerHTML = `
    <div class="custom-modal-content">
        <h5 class="mb-2">Resetar senha do usuário</h5>
        <div class="mb-2">
            <input type="password" id="novaSenhaInput" class="form-control" placeholder="Nova senha" autocomplete="new-password">
        </div>
        <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" id="cancelResetBtn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmResetBtn">Confirmar</button>
        </div>
    </div>
`;
document.body.appendChild(resetPasswordModal);

let currentResetUserId = null;
function openResetPasswordModal(userId) {
    currentResetUserId = userId;
    const input = document.getElementById('novaSenhaInput');
    if (input) input.value = '';
    resetPasswordModal.classList.add('show');
    setTimeout(() => input && input.focus(), 0);
}

function closeResetPasswordModal() {
    resetPasswordModal.classList.remove('show');
    currentResetUserId = null;
}

// Handlers do modal
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'cancelResetBtn') {
        closeResetPasswordModal();
    } else if (e.target && e.target.id === 'confirmResetBtn') {
        const novaSenha = (document.getElementById('novaSenhaInput').value || '').trim();
        if (!novaSenha) {
            alert('Nova senha é obrigatória');
            return;
        }
        fetchJson(`/api/usuarios/${currentResetUserId}/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nova_senha: novaSenha })
        })
        .then(data => {
            alert(data.message || 'Senha resetada com sucesso!');
            closeResetPasswordModal();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert(error.message || 'Erro ao resetar senha');
        });
    }
});

// Fechar ao clicar fora do conteúdo
resetPasswordModal.addEventListener('click', function(e) {
    if (e.target === resetPasswordModal) {
        closeResetPasswordModal();
    }
});

// Submit com Enter
document.addEventListener('keydown', function(e) {
    const isOpen = resetPasswordModal.classList.contains('show');
    if (isOpen && e.key === 'Enter') {
        const confirmBtn = document.getElementById('confirmResetBtn');
        if (confirmBtn) confirmBtn.click();
    }
});

function deleteUser(userId) {
    if (confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
        fetchJson(`/api/usuarios/${userId}`, {
            method: 'DELETE'
        })
        .then(data => {
            alert(data.message || 'Usuário excluído com sucesso');
            location.reload();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert(error.message || 'Erro ao excluir usuário');
        });
    }
}

// Submit do formulário
document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Converter valores
    data.ativo = data.ativo === 'true';
    
    // Mapear campos do formulário para API
    const apiData = {
        nome: data.nome_completo,
        email: data.email,
        login: data.username,
        nivel: data.nivel_acesso,
        ativo: data.ativo,
        central_id: data.central_id || null,
        almoxarifado_id: data.almoxarifado_id || null,
        sub_almoxarifado_id: data.sub_almoxarifado_id || null,
        setor_id: data.setor_id || null,
        categoria_id: data.categoria_id || null
    };

    // Para Operador Setor, usar seleção primária dos widgets múltiplos como fallback
    try {
        const nivelAtual = document.getElementById('user-nivel').value;
        if (nivelAtual === 'operador_setor') {
            const almoxPrimario = (operadorAlmoxSelecionados && operadorAlmoxSelecionados[0]) ? String(operadorAlmoxSelecionados[0]) : null;
            const subPrimario = (operadorSubsSelecionados && operadorSubsSelecionados[0]) ? String(operadorSubsSelecionados[0]) : null;
            if (almoxPrimario) apiData.almoxarifado_id = almoxPrimario;
            if (subPrimario) apiData.sub_almoxarifado_id = subPrimario;
        }
    } catch (_) {}
    
    // Adicionar senha (obrigatória na criação, opcional na edição)
    if (!isEditMode) {
        // Na criação, senha é obrigatória
        if (!data.password) {
            alert('Senha é obrigatória para novos usuários');
            return;
        }
        apiData.senha = data.password;
    } else {
        // Na edição, senha é opcional
        if (data.password) {
            apiData.senha = data.password;
        }
    }
    
    const url = isEditMode ? `/api/usuarios/${data.id}` : '/api/usuarios';
    const method = isEditMode ? 'PUT' : 'POST';
    
    fetchJson(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(apiData)
    })
    .then(data => {
        // Se nível é Operador Setor, persistir múltiplos sub‑almoxarifados no setor
        const nivelAtual = document.getElementById('user-nivel').value;
        const setorIdAtual = document.getElementById('user-setor').value || null;
        const subsSelecionados = operadorSubsSelecionados.slice();
        const centralIdAtual = document.getElementById('user-central')?.value || '';
        // Garantir que apenas sub‑almoxarifados da Central selecionada sejam persistidos
        const subsDaCentral = subsSelecionados.filter(id => {
            const row = document.querySelector(`#operador-sub-table-body tr[data-id="${CSS.escape(String(id))}"]`);
            if (!row) return false;
            const cId = row.getAttribute('data-central') || '';
            return centralIdAtual ? String(cId) === String(centralIdAtual) : true;
        });
        const persistPromise = (nivelAtual === 'operador_setor' && setorIdAtual)
            ? fetchJson(`/api/setores/${encodeURIComponent(setorIdAtual)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sub_almoxarifado_ids: subsDaCentral })
              }).catch(err => {
                console.error('Falha ao atualizar sub‑almoxarifados do setor:', err);
                throw new Error('Usuário salvo, porém houve erro ao atualizar vínculos de sub‑almoxarifados do setor.');
              })
            : Promise.resolve();
        return persistPromise.then(() => data);
    })
    .then(data => {
        // Se é criação de usuário e há categorias selecionadas, adicioná-las
        if (!isEditMode && categoriasSelecionadas.length > 0) {
            return adicionarCategoriasAposCreacao(data.id);
        }
        alert('Usuário salvo com sucesso!');
        location.reload();
    })
    .catch(error => {
        console.error('Erro:', error);
        alert(error.error || error.message || 'Erro ao salvar usuário');
    });
});

// CSS para avatar
const style = document.createElement('style');
style.textContent = `
    .avatar-sm {
        width: 32px;
        height: 32px;
    }
    .avatar-title {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: white;
    }
`;
document.head.appendChild(style);

// Funções para gerenciar categorias específicas

// Array para armazenar categorias temporariamente durante criação
let categoriasSelecionadas = [];

function carregarCategoriasEspecificas() {
    const userId = document.getElementById('user-id').value;
    if (!userId) {
        // Se não há userId (novo usuário), limpar lista temporária
        categoriasSelecionadas = [];
        const lista = document.getElementById('categorias-especificas-lista');
        lista.innerHTML = '<div class="text-muted">Nenhuma categoria específica configurada</div>';
        return;
    }
    
    fetchJson(`/api/usuarios/${userId}/categorias-especificas`)
        .then(data => {
            const lista = document.getElementById('categorias-especificas-lista');
            lista.innerHTML = '';
            
            if (data.categorias_especificas && data.categorias_especificas.length > 0) {
                data.categorias_especificas.forEach(categoria => {
                    adicionarCategoriaLista(categoria);
                });
            } else {
                lista.innerHTML = '<div class="text-muted">Nenhuma categoria específica configurada</div>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar categorias específicas:', error);
        });
}

function adicionarCategoriaEspecifica() {
    const select = document.getElementById('categoria-adicionar');
    const categoriaId = select.value;
    const userId = document.getElementById('user-id').value;
    
    if (!categoriaId) {
        if (window.showNotification) window.showNotification('warning', 'Selecione uma categoria para adicionar.');
        return;
    }
    
    // Se é um usuário existente, usar API
    if (userId) {
        fetchJson(`/api/usuarios/${userId}/categorias-especificas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ categoria_id: categoriaId })
        })
        .then(data => {
            if (data.error) {
                if (window.showNotification) window.showNotification('danger', `Falha ao adicionar categoria: ${data.error}`);
            } else {
                adicionarCategoriaLista(data.categoria);
                select.value = '';
                // Remover opção do select temporariamente
                const option = select.querySelector(`option[value="${categoriaId}"]`);
                if (option) option.style.display = 'none';
                if (window.showNotification) window.showNotification('success', 'Categoria adicionada ao usuário.');
            }
        })
        .catch(error => {
            console.error('Erro ao adicionar categoria:', error);
            const friendly = (window.friendlyErrorMessage ? window.friendlyErrorMessage(error, 'user_categoria_add') : (error && error.message ? error.message : String(error)));
            if (window.showNotification) window.showNotification('danger', `Falha ao adicionar categoria: ${friendly}`);
        });
    } else {
        // Se é novo usuário, armazenar temporariamente
        const option = select.querySelector(`option[value="${categoriaId}"]`);
        if (option) {
            const categoria = {
                id: categoriaId,
                nome: option.textContent.trim()
            };
            
            // Verificar se já foi adicionada
            if (!categoriasSelecionadas.find(c => c.id === categoria.id)) {
                categoriasSelecionadas.push(categoria);
                adicionarCategoriaLista(categoria, true); // true indica que é temporário
                select.value = '';
                option.style.display = 'none';
            } else {
                alert('Esta categoria já foi adicionada');
            }
        }
    }
}

function adicionarCategoriaLista(categoria, isTemporary = false) {
    const lista = document.getElementById('categorias-especificas-lista');
    
    // Remover mensagem de "nenhuma categoria"
    const emptyMessage = lista.querySelector('.text-muted');
    if (emptyMessage) emptyMessage.remove();
    
    const div = document.createElement('div');
    div.className = 'badge bg-primary me-2 mb-2 d-inline-flex align-items-center';
    div.setAttribute('data-categoria-id', categoria.id);
    
    if (isTemporary) {
        div.innerHTML = `
            ${categoria.nome}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removerCategoriaTemporaria('${categoria.id}', this)" 
                    aria-label="Remover"></button>
        `;
    } else {
        div.innerHTML = `
            ${categoria.nome}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removerCategoriaEspecifica('${categoria.id}', this)" 
                    aria-label="Remover"></button>
        `;
    }
    
    lista.appendChild(div);
}

function removerCategoriaTemporaria(categoriaId, button) {
    // Remover da lista temporária
    categoriasSelecionadas = categoriasSelecionadas.filter(c => c.id !== categoriaId);
    
    // Remover da lista visual
    button.parentElement.remove();
    
    // Reexibir opção no select
    const select = document.getElementById('categoria-adicionar');
    const option = select.querySelector(`option[value="${categoriaId}"]`);
    if (option) option.style.display = '';
    
    // Se não há mais categorias, mostrar mensagem
    const lista = document.getElementById('categorias-especificas-lista');
    if (lista.children.length === 0) {
        lista.innerHTML = '<div class="text-muted">Nenhuma categoria específica configurada</div>';
    }
}

function removerCategoriaEspecifica(categoriaId, button) {
    const userId = document.getElementById('user-id').value;
    
    fetchJson(`/api/usuarios/${userId}/categorias-especificas/${categoriaId}`, {
        method: 'DELETE'
    })
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // Remover da lista
            button.parentElement.remove();
            
            // Reexibir opção no select
            const select = document.getElementById('categoria-adicionar');
            const option = select.querySelector(`option[value="${categoriaId}"]`);
            if (option) option.style.display = '';
            
            // Se não há mais categorias, mostrar mensagem
            const lista = document.getElementById('categorias-especificas-lista');
            if (lista.children.length === 0) {
                lista.innerHTML = '<div class="text-muted">Nenhuma categoria específica configurada</div>';
            }
        }
    })
    .catch(error => {
        console.error('Erro ao remover categoria:', error);
        alert('Erro ao remover categoria específica');
    });
}

function adicionarCategoriasAposCreacao(userId) {
    // Adicionar cada categoria selecionada via API
    const promises = categoriasSelecionadas.map(categoria => {
        return fetchJson(`/api/usuarios/${userId}/categorias-especificas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ categoria_id: categoria.id })
        }).catch(err => {
            throw new Error(`Erro ao adicionar categoria ${categoria.nome}: ${err.message || ''}`);
        });
    });
    
    return Promise.all(promises)
        .then(results => {
            alert('Usuário criado com sucesso e categorias específicas adicionadas!');
            // Aguardar um pouco antes de recarregar para evitar cancelamento de requisições
            setTimeout(() => {
                location.reload();
            }, 100);
        })
        .catch(error => {
            console.error('Erro ao adicionar categorias:', error);
            alert('Usuário criado, mas houve erro ao adicionar categorias específicas. Edite o usuário para configurar as categorias.');
            setTimeout(() => {
                location.reload();
            }, 100);
        });
}

// Event listeners para os botões
document.addEventListener('DOMContentLoaded', function() {
    // Botões de editar
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            editUser(userId);
        });
    });

    // Botões de toggle status
    document.querySelectorAll('.btn-toggle-status').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            toggleUserStatus(userId);
        });
    });

    // Botões de reset password
    document.querySelectorAll('.btn-reset-password').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            resetPassword(userId);
        });
    });

    // Botões de delete
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            deleteUser(userId);
        });
    });
});
</script>
{% endblock %}