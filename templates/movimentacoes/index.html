{% extends "base.html" %}

{% block title %}Movimentações{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-exchange-alt"></i> Movimentações</h2>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaTransferenciaModal">
                        <i class="fas fa-plus"></i> Nova Transferência
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#distribuicaoModal">
                        <i class="fas fa-share-alt"></i> Distribuição
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filtroTipo" class="form-label">Tipo</label>
                            <select class="form-select" id="filtroTipo">
                                <option value="">Todos</option>
                                <option value="ENTRADA">Entrada</option>
                                <option value="SAIDA">Saída</option>
                                <option value="TRANSFERENCIA">Transferência</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroProduto" class="form-label">Produto</label>
                            <input type="text" class="form-control" id="filtroProduto" placeholder="Nome ou código">
                        </div>
                        <div class="col-md-2">
                            <label for="filtroDataInicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="filtroDataInicio">
                        </div>
                        <div class="col-md-2">
                            <label for="filtroDataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="filtroDataFim">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="filtrarMovimentacoes()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Movimentações -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Origem</th>
                                    <th>Destino</th>
                                    <th>Responsável</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="movimentacoesTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <nav aria-label="Paginação">
                        <ul class="pagination justify-content-center" id="paginacao">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Transferência -->
<div class="modal fade" id="novaTransferenciaModal" tabindex="-1" aria-labelledby="novaTransferenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novaTransferenciaModalLabel">Nova Transferência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transferenciaForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="produtoTransferencia" class="form-label">Produto *</label>
                                <select class="form-select" id="produtoTransferencia" required onchange="carregarLocaisProduto(); carregarTiposDestino();">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantidadeTransferencia" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="quantidadeTransferencia" step="0.001" min="0.001" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Origem</h6>
                            <div class="mb-3">
                                <label for="tipoOrigemTransferencia" class="form-label">Tipo de Local *</label>
                                <select class="form-select" id="tipoOrigemTransferencia" required onchange="carregarLocaisOrigem()">
                                    <option value="">Selecione...</option>
                                    <option value="almoxarifado">Almoxarifado</option>
                                    <option value="sub_almoxarifado">Sub-Almoxarifado</option>
                                    <option value="setor">Setor</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="localOrigemTransferencia" class="form-label">Local *</label>
                                <select class="form-select" id="localOrigemTransferencia" required>
                                    <option value="">Selecione o tipo primeiro...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Destino</h6>
                            <div class="mb-3">
                                <label for="tipoDestinoTransferencia" class="form-label">Tipo de Local *</label>
                                <select class="form-select" id="tipoDestinoTransferencia" required onchange="carregarLocaisDestino()">
                                    <option value="">Selecione...</option>
                                    <option value="almoxarifado">Almoxarifado</option>
                                    <option value="sub_almoxarifado">Sub-Almoxarifado</option>
                                    <option value="setor">Setor</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="localDestinoTransferencia" class="form-label">Local *</label>
                                <select class="form-select" id="localDestinoTransferencia" required>
                                    <option value="">Selecione o tipo primeiro...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoTransferencia" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivoTransferencia" maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesTransferencia" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoesTransferencia" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="executarTransferencia()">
                    <i class="fas fa-exchange-alt"></i> Executar Transferência
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Distribuição -->
<div class="modal fade" id="distribuicaoModal" tabindex="-1" aria-labelledby="distribuicaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="distribuicaoModalLabel">Distribuição para Setores</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="distribuicaoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="produtoDistribuicao" class="form-label">Produto *</label>
                                <select class="form-select" id="produtoDistribuicao" required onchange="carregarLocaisProdutoDistribuicao()">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantidadeDistribuicao" class="form-label">Quantidade Total *</label>
                                <input type="number" class="form-control" id="quantidadeDistribuicao" step="0.001" min="0.001" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Origem</h6>
                            <div class="mb-3">
                                <label for="tipoOrigemDistribuicao" class="form-label">Tipo de Local *</label>
                                <select class="form-select" id="tipoOrigemDistribuicao" required onchange="carregarLocaisOrigemDistribuicao()">
                                    <option value="">Selecione...</option>
                                    <option value="central">Central</option>
                                    <option value="almoxarifado">Almoxarifado</option>
                                    <option value="sub_almoxarifado">Sub-Almoxarifado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="localOrigemDistribuicao" class="form-label">Local *</label>
                                <select class="form-select" id="localOrigemDistribuicao" required>
                                    <option value="">Selecione o tipo primeiro...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Setores de Destino</h6>
                            <div class="mb-3">
                                <label class="form-label">Selecione os setores:</label>
                                <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <div id="setoresDistribuicao">
                                        {% for setor in setores %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="{{ setor.id }}" id="setor{{ setor.id }}">
                                            <label class="form-check-label" for="setor{{ setor.id }}">
                                                {{ setor.nome }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoDistribuicao" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivoDistribuicao" maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesDistribuicao" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoesDistribuicao" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="executarDistribuicao()">
                    <i class="fas fa-share-alt"></i> Executar Distribuição
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dados dos locais -->
<script type="application/json" id="centrais-data">{{ centrais | tojson | safe }}</script>
<script type="application/json" id="almoxarifados-data">{{ almoxarifados | tojson | safe }}</script>
<script type="application/json" id="sub-almoxarifados-data">{{ sub_almoxarifados | tojson | safe }}</script>
<script type="application/json" id="setores-data">{{ setores | tojson | safe }}</script>

<script>
let currentPage = 1;
const itemsPerPage = 20;

// Carregar dados dos locais
const locaisData = {
    centrais: JSON.parse(document.getElementById('centrais-data')?.textContent || '[]'),
    almoxarifados: JSON.parse(document.getElementById('almoxarifados-data')?.textContent || '[]'),
    sub_almoxarifados: JSON.parse(document.getElementById('sub-almoxarifados-data')?.textContent || '[]'),
    setores: JSON.parse(document.getElementById('setores-data')?.textContent || '[]')
};

// Carregar movimentações
function carregarMovimentacoes(page = 1) {
    currentPage = page;
    
    const filtros = {
        tipo: document.getElementById('filtroTipo').value,
        produto: document.getElementById('filtroProduto').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        page: page,
        per_page: itemsPerPage
    };
    
    const params = new URLSearchParams();
    Object.keys(filtros).forEach(key => {
        if (filtros[key]) params.append(key, filtros[key]);
    });
    
    fetch(`/api/movimentacoes?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            renderizarMovimentacoes(data.items);
            renderizarPaginacao(data.pagination);
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('movimentacoesTableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar movimentações: ${error.message}
                    </td>
                </tr>
            `;
        });
}

// Renderizar movimentações na tabela
function renderizarMovimentacoes(movimentacoes) {
    const tbody = document.getElementById('movimentacoesTableBody');
    
    if (!movimentacoes || movimentacoes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-inbox"></i> Nenhuma movimentação encontrada
                </td>
            </tr>
        `;
        return;
    }
    
    const tipoIcons = {
        'entrada': 'fas fa-arrow-down text-success',
        'saida': 'fas fa-arrow-up text-danger',
        'transferencia': 'fas fa-exchange-alt text-primary'
    };
    
    tbody.innerHTML = movimentacoes.map(mov => `
        <tr>
            <td>
                <div>${new Date(mov.data_movimentacao).toLocaleDateString('pt-BR')}</div>
                <small class="text-muted">${new Date(mov.data_movimentacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</small>
            </td>
            <td>
                <i class="${tipoIcons[mov.tipo_movimentacao?.toLowerCase()] || 'fas fa-question'}"></i>
                ${mov.tipo_movimentacao}
            </td>
            <td>
                <strong>${mov.produto_codigo}</strong><br>
                <small class="text-muted">${mov.produto_nome}</small>
            </td>
            <td>${parseFloat(mov.quantidade).toLocaleString('pt-BR')} ${mov.produto_unidade}</td>
            <td>${mov.origem_nome || '-'}</td>
            <td>${mov.destino_nome || '-'}</td>
            <td>${mov.usuario_responsavel}</td>
            <td>${mov.motivo || '-'}</td>
        </tr>
    `).join('');
}

// Renderizar paginação
function renderizarPaginacao(pagination) {
    const paginacaoEl = document.getElementById('paginacao');
    
    if (!pagination || pagination.total_pages <= 1) {
        paginacaoEl.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Botão anterior
    if (pagination.current_page > 1) {
        html += `<li class="page-item">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${pagination.current_page - 1})">Anterior</a>
        </li>`;
    }
    
    // Páginas
    for (let i = Math.max(1, pagination.current_page - 2); i <= Math.min(pagination.total_pages, pagination.current_page + 2); i++) {
        html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${i})">${i}</a>
        </li>`;
    }
    
    // Botão próximo
    if (pagination.current_page < pagination.total_pages) {
        html += `<li class="page-item">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${pagination.current_page + 1})">Próximo</a>
        </li>`;
    }
    
    paginacaoEl.innerHTML = html;
}

// Filtrar movimentações
function filtrarMovimentacoes() {
    carregarMovimentacoes(1);
}

// Carregar produtos para os selects
function carregarProdutos() {
    fetch('/api/produtos?ativo=true&per_page=1000')
        .then(response => response.json())
        .then(data => {
            const produtos = data.items || [];
            
            const selectTransferencia = document.getElementById('produtoTransferencia');
            const selectDistribuicao = document.getElementById('produtoDistribuicao');
            
            const options = produtos.map(produto => 
                `<option value="${produto.id}">${produto.codigo} - ${produto.nome}</option>`
            ).join('');
            
            selectTransferencia.innerHTML = '<option value="">Selecione um produto...</option>' + options;
            selectDistribuicao.innerHTML = '<option value="">Selecione um produto...</option>' + options;
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
        });
}

// Carregar locais de origem para transferência
function carregarLocaisOrigem() {
    const tipo = document.getElementById('tipoOrigemTransferencia').value;
    const produtoId = document.getElementById('produtoTransferencia').value;
    const select = document.getElementById('localOrigemTransferencia');
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }
    
    let locais = [];
    switch (tipo) {
        case 'almoxarifado':
            locais = locaisData.almoxarifados;
            break;
        case 'sub_almoxarifado':
            locais = locaisData.sub_almoxarifados;
            break;
        case 'setor':
            locais = locaisData.setores;
            break;
    }
    
    // Se um produto estiver selecionado, mostrar apenas locais com estoque
    if (produtoId) {
        fetch(`/api/produtos/${produtoId}/estoque`)
            .then(response => response.json())
            .then(data => {
                if (data.estoques && data.estoques.length > 0) {
                    const estoquesDoTipo = data.estoques.filter(estoque => 
                        estoque.tipo === tipo && estoque.quantidade_disponivel > 0
                    );
                    
                    const options = estoquesDoTipo
                        .filter(estoque => estoque.local_id !== undefined && estoque.local_id !== null && estoque.local_id !== 'undefined')
                        .map(estoque => {

                            // Garantir que local_id é um número válido
                            const localId = parseInt(estoque.local_id);
                            if (isNaN(localId) || localId <= 0) {
                                return null;
                            }
                            return `<option value="${localId}">${estoque.nome_local} (Disponível: ${estoque.quantidade_disponivel})</option>`;
                        })
                        .filter(option => option !== null)
                        .join('');
                    
                    select.innerHTML = '<option value="">Selecione...</option>' + options;
                } else {
                    select.innerHTML = '<option value="">Nenhum local com estoque disponível</option>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar estoque:', error);
                // Fallback para mostrar todos os locais
                const options = locais
                    .filter(local => local.id !== undefined && local.id !== null)
                    .map(local => 
                        `<option value="${local.id}">${local.nome}</option>`
                    ).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            });
    } else {
        // Se nenhum produto selecionado, mostrar todos os locais
        const options = locais
            .filter(local => local.id !== undefined && local.id !== null && local.id !== 'undefined')
            .map(local => {
                // Garantir que id é um número válido
                const localId = parseInt(local.id);
                if (isNaN(localId) || localId <= 0) {
                    return null;
                }
                return `<option value="${localId}">${local.nome}</option>`;
            })
            .filter(option => option !== null)
            .join('');
        select.innerHTML = '<option value="">Selecione...</option>' + options;
    }
}

// Carregar tipos de destino disponíveis baseados na central do produto
function carregarTiposDestino() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const tipoSelect = document.getElementById('tipoDestinoTransferencia');
    const localSelect = document.getElementById('localDestinoTransferencia');
    
    // Limpar seleções
    tipoSelect.value = '';
    localSelect.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
    
    if (!produtoId) {
        tipoSelect.innerHTML = `
            <option value="">Selecione um produto primeiro...</option>
        `;
        return;
    }
    
    // Buscar informações do produto para verificar quais tipos estão disponíveis
    fetch(`/api/produtos/${produtoId}`)
        .then(response => response.json())
        .then(produto => {
            let opcoesDisponiveis = [];
            
            // Central não é mais um local de estoque - removido
            
            // Verificar se existem almoxarifados da central
            const almoxarifadosDaCentral = locaisData.almoxarifados.filter(almox => almox.central_id === produto.central_id);
            if (almoxarifadosDaCentral.length > 0) {
                opcoesDisponiveis.push('<option value="almoxarifado">Almoxarifado</option>');
            }
            
            // Verificar se existem sub-almoxarifados da central
            const almoxarifadosIds = almoxarifadosDaCentral.map(almox => almox.id);
            const subAlmoxarifadosDaCentral = locaisData.sub_almoxarifados.filter(subAlmox => almoxarifadosIds.includes(subAlmox.almoxarifado_id));
            if (subAlmoxarifadosDaCentral.length > 0) {
                opcoesDisponiveis.push('<option value="sub_almoxarifado">Sub-Almoxarifado</option>');
            }
            
            // Verificar se existem setores da central
            const subAlmoxarifadosIds = subAlmoxarifadosDaCentral.map(subAlmox => subAlmox.id);
            const setoresDaCentral = locaisData.setores.filter(setor => subAlmoxarifadosIds.includes(setor.sub_almoxarifado_id));
            if (setoresDaCentral.length > 0) {
                opcoesDisponiveis.push('<option value="setor">Setor</option>');
            }
            
            if (opcoesDisponiveis.length === 0) {
                tipoSelect.innerHTML = '<option value="">Nenhum tipo de local disponível</option>';
            } else {
                tipoSelect.innerHTML = '<option value="">Selecione...</option>' + opcoesDisponiveis.join('');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar tipos de destino:', error);
            tipoSelect.innerHTML = '<option value="">Erro ao carregar tipos</option>';
        });
}

// Carregar locais de destino para transferência
function carregarLocaisDestino() {
    const tipo = document.getElementById('tipoDestinoTransferencia').value;
    const produtoId = document.getElementById('produtoTransferencia').value;
    const select = document.getElementById('localDestinoTransferencia');
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }
    
    if (!produtoId) {
        select.innerHTML = '<option value="">Selecione um produto primeiro...</option>';
        return;
    }
    
    // Buscar informações do produto para obter a central
    fetch(`/api/produtos/${produtoId}`)
        .then(response => response.json())
        .then(produto => {
            let locais = [];
            
            switch (tipo) {
                case 'almoxarifado':
                    // Permitir apenas almoxarifados da central do produto
                    locais = locaisData.almoxarifados.filter(almox => almox.central_id === produto.central_id);
                    break;
                case 'sub_almoxarifado':
                    // Permitir apenas sub-almoxarifados dos almoxarifados da central do produto
                    const almoxarifadosDaCentral = locaisData.almoxarifados.filter(almox => almox.central_id === produto.central_id);
                    const almoxarifadosIds = almoxarifadosDaCentral.map(almox => almox.id);
                    locais = locaisData.sub_almoxarifados.filter(subAlmox => almoxarifadosIds.includes(subAlmox.almoxarifado_id));
                    break;
                case 'setor':
                    // Permitir apenas setores dos sub-almoxarifados da central do produto
                    const almoxarifadosDaCentralSetor = locaisData.almoxarifados.filter(almox => almox.central_id === produto.central_id);
                    const almoxarifadosIdsSetor = almoxarifadosDaCentralSetor.map(almox => almox.id);
                    const subAlmoxarifadosDaCentral = locaisData.sub_almoxarifados.filter(subAlmox => almoxarifadosIdsSetor.includes(subAlmox.almoxarifado_id));
                    const subAlmoxarifadosIds = subAlmoxarifadosDaCentral.map(subAlmox => subAlmox.id);
                    locais = locaisData.setores.filter(setor => subAlmoxarifadosIds.includes(setor.sub_almoxarifado_id));
                    break;
            }
            
            if (locais.length === 0) {
                select.innerHTML = '<option value="">Nenhum local disponível para este produto</option>';
            } else {
                const options = locais
                    .filter(local => local.id !== undefined && local.id !== null && local.id !== 'undefined')
                    .map(local => {
                        // Garantir que id é um número válido
                        const localId = parseInt(local.id);
                        if (isNaN(localId) || localId <= 0) {
                            return null;
                        }
                        return `<option value="${localId}">${local.nome}</option>`;
                    })
                    .filter(option => option !== null)
                    .join('');
                
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar informações do produto:', error);
            select.innerHTML = '<option value="">Erro ao carregar locais</option>';
        });
}

// Carregar locais de origem para distribuição
function carregarLocaisOrigemDistribuicao() {
    const tipo = document.getElementById('tipoOrigemDistribuicao').value;
    const produtoId = document.getElementById('produtoDistribuicao').value;
    const select = document.getElementById('localOrigemDistribuicao');
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }
    
    let locais = [];
    switch (tipo) {
        case 'central':
            locais = locaisData.centrais;
            break;
        case 'almoxarifado':
            locais = locaisData.almoxarifados;
            break;
        case 'sub_almoxarifado':
            locais = locaisData.sub_almoxarifados;
            break;
    }
    
    // Se um produto estiver selecionado, mostrar apenas locais com estoque
    if (produtoId) {
        fetch(`/api/produtos/${produtoId}/estoque`)
            .then(response => response.json())
            .then(data => {
                if (data.estoques && data.estoques.length > 0) {
                    const estoquesDoTipo = data.estoques.filter(estoque => 
                        estoque.tipo === tipo && estoque.quantidade_disponivel > 0
                    );
                    
                    const options = estoquesDoTipo.map(estoque => 
                        `<option value="${estoque.local_id}">${estoque.nome_local} (Disponível: ${estoque.quantidade_disponivel})</option>`
                    ).join('');
                    
                    select.innerHTML = '<option value="">Selecione...</option>' + options;
                } else {
                    select.innerHTML = '<option value="">Nenhum local com estoque disponível</option>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar estoque:', error);
                // Fallback para mostrar todos os locais
                const options = locais.map(local => 
                    `<option value="${local.id}">${local.nome}</option>`
                ).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            });
    } else {
        // Se nenhum produto selecionado, mostrar todos os locais
        const options = locais.map(local => 
            `<option value="${local.id}">${local.nome}</option>`
        ).join('');
        select.innerHTML = '<option value="">Selecione...</option>' + options;
    }
}

// Carregar locais onde o produto está disponível para distribuição
function carregarLocaisProdutoDistribuicao() {
    const produtoId = document.getElementById('produtoDistribuicao').value;
    const tipoOrigemSelect = document.getElementById('tipoOrigemDistribuicao');
    const localOrigemSelect = document.getElementById('localOrigemDistribuicao');
    
    // Limpar seleções anteriores
    tipoOrigemSelect.value = '';
    localOrigemSelect.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
    
    if (!produtoId) {
        return;
    }
    
    // Buscar estoque do produto
    fetch(`/api/produtos/${produtoId}/estoque`)
        .then(response => response.json())
        .then(data => {
            if (data.estoques && data.estoques.length > 0) {
                // Agrupar por tipo de local (apenas centrais, almoxarifados e sub-almoxarifados para distribuição)
                const locaisPorTipo = {};
                data.estoques.forEach(estoque => {
                    if (estoque.quantidade_disponivel > 0 && estoque.tipo !== 'setor') {
                        const tipo = estoque.tipo;
                        if (!locaisPorTipo[tipo]) {
                            locaisPorTipo[tipo] = [];
                        }
                        locaisPorTipo[tipo].push({
                            id: estoque.local_id,
                            nome: estoque.nome_local,
                            quantidade: estoque.quantidade_disponivel
                        });
                    }
                });
                
                // Se há apenas um tipo de local, selecionar automaticamente
                const tipos = Object.keys(locaisPorTipo);
                if (tipos.length === 1) {
                    const tipoUnico = tipos[0];
                    tipoOrigemSelect.value = tipoUnico;
                    
                    // Carregar locais deste tipo
                    const locais = locaisPorTipo[tipoUnico];
                    const options = locais.map(local => 
                        `<option value="${local.id}">${local.nome} (Disponível: ${local.quantidade})</option>`
                    ).join('');
                    
                    localOrigemSelect.innerHTML = '<option value="">Selecione...</option>' + options;
                    
                    // Se há apenas um local, selecionar automaticamente
                    if (locais.length === 1) {
                        localOrigemSelect.value = locais[0].id;
                    }
                } else if (tipos.length > 1) {
                    // Mostrar mensagem informativa
                    localOrigemSelect.innerHTML = '<option value="">Produto disponível em múltiplos tipos de local - selecione o tipo primeiro</option>';
                } else {
                    localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível para distribuição</option>';
                }
            } else {
                localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar estoque do produto:', error);
            localOrigemSelect.innerHTML = '<option value="">Erro ao carregar estoque</option>';
        });
}

// Carregar locais onde o produto está disponível
function carregarLocaisProduto() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const tipoOrigemSelect = document.getElementById('tipoOrigemTransferencia');
    const localOrigemSelect = document.getElementById('localOrigemTransferencia');
    
    // Limpar seleções anteriores
    tipoOrigemSelect.value = '';
    localOrigemSelect.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
    
    if (!produtoId) {
        return;
    }
    
    // Buscar estoque do produto
    fetch(`/api/produtos/${produtoId}/estoque`)
        .then(response => response.json())
        .then(data => {
            if (data.estoques && data.estoques.length > 0) {
                // Agrupar por tipo de local
                const locaisPorTipo = {};
                data.estoques.forEach(estoque => {
                    if (estoque.quantidade_disponivel > 0) {
                        const tipo = estoque.tipo;
                        if (!locaisPorTipo[tipo]) {
                            locaisPorTipo[tipo] = [];
                        }
                        locaisPorTipo[tipo].push({
                            id: estoque.local_id,
                            nome: estoque.nome_local,
                            quantidade: estoque.quantidade_disponivel
                        });
                    }
                });
                
                // Se há apenas um tipo de local, selecionar automaticamente
                const tipos = Object.keys(locaisPorTipo);
                if (tipos.length === 1) {
                    const tipoUnico = tipos[0];
                    tipoOrigemSelect.value = tipoUnico;
                    
                    // Carregar locais deste tipo
                    const locais = locaisPorTipo[tipoUnico];
                    const options = locais.map(local => 
                        `<option value="${local.id}">${local.nome} (Disponível: ${local.quantidade})</option>`
                    ).join('');
                    
                    localOrigemSelect.innerHTML = '<option value="">Selecione...</option>' + options;
                    
                    // Se há apenas um local, selecionar automaticamente
                    if (locais.length === 1) {
                        localOrigemSelect.value = locais[0].id;
                    }
                } else if (tipos.length > 1) {
                    // Mostrar mensagem informativa
                    localOrigemSelect.innerHTML = '<option value="">Produto disponível em múltiplos tipos de local - selecione o tipo primeiro</option>';
                } else {
                    localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível</option>';
                }
            } else {
                localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar estoque do produto:', error);
            localOrigemSelect.innerHTML = '<option value="">Erro ao carregar estoque</option>';
        });
}

// Executar transferência
function executarTransferencia() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const quantidade = document.getElementById('quantidadeTransferencia').value;
    const tipoOrigem = document.getElementById('tipoOrigemTransferencia').value;
    const localOrigem = document.getElementById('localOrigemTransferencia').value;
    const tipoDestino = document.getElementById('tipoDestinoTransferencia').value;
    const localDestino = document.getElementById('localDestinoTransferencia').value;
    const motivo = document.getElementById('motivoTransferencia').value;
    const observacoes = document.getElementById('observacoesTransferencia').value;
    
    // Validações
    if (!produtoId || !quantidade || !tipoOrigem || !localOrigem || !tipoDestino || !localDestino) {
        alert('Preencha todos os campos obrigatórios');
        return;
    }
    
    if (!localOrigem || localOrigem === '' || localOrigem === 'undefined' || localOrigem === undefined || localOrigem === null || isNaN(parseInt(localOrigem))) {
        alert('Por favor, selecione um local de origem válido.');
        return;
    }
    
    if (parseInt(localOrigem) <= 0) {
        alert('Por favor, selecione um local de origem válido.');
        return;
    }
    
    // Validar local de destino
    if (!localDestino || localDestino === '' || localDestino === 'undefined' || localDestino === undefined || localDestino === null || isNaN(parseInt(localDestino))) {
        alert('Por favor, selecione um local de destino válido.');
        return;
    }
    
    if (parseInt(localDestino) <= 0) {
        alert('Por favor, selecione um local de destino válido.');
        return;
    }
    
    if (parseFloat(quantidade) <= 0) {
        alert('Quantidade deve ser maior que zero');
        return;
    }
    
    // Preparar dados
    const origemId = parseInt(localOrigem);
    const destinoId = parseInt(localDestino);
    
    // Validação final dos IDs
    if (isNaN(origemId) || origemId <= 0) {
        alert('ID do local de origem inválido');
        return;
    }
    
    if (isNaN(destinoId) || destinoId <= 0) {
        alert('ID do local de destino inválido');
        return;
    }
    
    // Validar se origem e destino são diferentes
    if (tipoOrigem === tipoDestino && origemId === destinoId) {
        alert('Não é possível transferir de um local para ele mesmo. Por favor, selecione um local de destino diferente.');
        return;
    }
    
    const dadosTransferencia = {
        produto_id: parseInt(produtoId),
        quantidade: parseFloat(quantidade),
        motivo: motivo,
        observacoes: observacoes,
        origem: {
            tipo: tipoOrigem,
            id: origemId
        },
        destino: {
            tipo: tipoDestino,
            id: destinoId
        }
    };
    
    // Enviar para API
    fetch('/api/movimentacoes/transferencia', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dadosTransferencia)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Erro ao executar transferência');
            });
        }
    })
    .then(result => {
        alert('Transferência executada com sucesso!');
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('novaTransferenciaModal'));
        modal.hide();
        
        // Limpar formulário
        document.getElementById('transferenciaForm').reset();
        
        // Recarregar lista
        carregarMovimentacoes(currentPage);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao executar transferência: ' + error.message);
    });
}

// Executar distribuição
function executarDistribuicao() {
    const produtoId = document.getElementById('produtoDistribuicao').value;
    const quantidade = document.getElementById('quantidadeDistribuicao').value;
    const tipoOrigem = document.getElementById('tipoOrigemDistribuicao').value;
    const localOrigem = document.getElementById('localOrigemDistribuicao').value;
    const motivo = document.getElementById('motivoDistribuicao').value;
    const observacoes = document.getElementById('observacoesDistribuicao').value;
    
    // Coletar setores selecionados
    const setoresSelecionados = [];
    document.querySelectorAll('#setoresDistribuicao input[type="checkbox"]:checked').forEach(checkbox => {
        setoresSelecionados.push(parseInt(checkbox.value));
    });
    
    // Validações
    if (!produtoId || !quantidade || !tipoOrigem || !localOrigem) {
        alert('Preencha todos os campos obrigatórios');
        return;
    }
    
    if (setoresSelecionados.length === 0) {
        alert('Selecione pelo menos um setor de destino');
        return;
    }
    
    if (parseFloat(quantidade) <= 0) {
        alert('Quantidade deve ser maior que zero');
        return;
    }
    
    // Preparar dados
    const dadosDistribuicao = {
        produto_id: parseInt(produtoId),
        quantidade_total: parseFloat(quantidade),
        motivo: motivo,
        observacoes: observacoes,
        origem: {
            tipo: tipoOrigem,
            id: parseInt(localOrigem)
        },
        setores_destino: setoresSelecionados
    };
    
    // Enviar para API
    fetch('/api/movimentacoes/distribuicao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dadosDistribuicao)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Erro ao executar distribuição');
            });
        }
    })
    .then(result => {
        alert(`Distribuição executada com sucesso! ${result.movimentacoes_criadas} movimentações criadas.`);
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('distribuicaoModal'));
        modal.hide();
        
        // Limpar formulário
        document.getElementById('distribuicaoForm').reset();
        document.querySelectorAll('#setoresDistribuicao input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Recarregar lista
        carregarMovimentacoes(currentPage);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao executar distribuição: ' + error.message);
    });
}

// Event listeners
document.getElementById('filtroProduto').addEventListener('input', 
    debounce(() => filtrarMovimentacoes(), 500)
);

// Função debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Carregar dados iniciais
document.addEventListener('DOMContentLoaded', () => {
    carregarMovimentacoes(1);
    carregarProdutos();
});
</script>
{% endblock %}