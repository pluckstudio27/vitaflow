{% extends "base.html" %}

{% block title %}PluckLog - Movimentações{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-exchange-alt"></i> Movimentações</h2>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaTransferenciaModal">
                        <i class="fas fa-plus"></i> Nova Transferência
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#distribuicaoModal">
                        <i class="fas fa-arrow-up"></i> Saída
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filtroTipo" class="form-label">Tipo</label>
                            <select class="form-select" id="filtroTipo">
                                <option value="">Todos</option>
                                <option value="ENTRADA">Entrada</option>
                                <option value="SAIDA">Saída</option>
                                <option value="TRANSFERENCIA">Transferência</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroProduto" class="form-label">Produto</label>
                            <input type="text" class="form-control" id="filtroProduto" placeholder="Nome ou código">
                        </div>
                        <div class="col-md-2">
                            <label for="filtroDataInicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="filtroDataInicio">
                        </div>
                        <div class="col-md-2">
                            <label for="filtroDataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="filtroDataFim">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="filtrarMovimentacoes()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Movimentações -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button type="button" id="btnOrdenacaoMovs" class="btn btn-outline-secondary btn-sm" onclick="toggleOrdenacaoMovs()" title="Mostrar mais antigas primeiro">
                            <i class="fas fa-sort-amount-down"></i> Mais recentes primeiro
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Local</th>
                                    <th>Responsável</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="movimentacoesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <nav aria-label="Paginação">
                        <ul class="pagination justify-content-center" id="paginacao">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Transferência -->
<div class="modal fade" id="novaTransferenciaModal" tabindex="-1" aria-labelledby="novaTransferenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novaTransferenciaModalLabel">Nova Transferência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="transferenciaMsg" class="alert alert-warning d-none" role="alert"></div>
                <form id="transferenciaForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="produtoTransferencia" class="form-label">Produto *</label>
                                <input type="text" class="form-control mb-2" id="buscaProdutoTransferencia" placeholder="Buscar produto por nome ou código...">
                                <select class="form-select" id="produtoTransferencia" required onchange="carregarLocaisProduto(); carregarTiposDestino();">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantidadeTransferencia" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="quantidadeTransferencia" step="0.001" min="0.001" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Origem</h6>
                            <div class="mb-3">
                                <label for="tipoOrigemTransferencia" class="form-label">Tipo de Local *</label>
                                <select class="form-select" id="tipoOrigemTransferencia" required onchange="carregarLocaisOrigem()">
                                    <option value="">Selecione...</option>
                                    <option value="almoxarifado">Almoxarifado</option>
                                    <option value="sub_almoxarifado">Sub-Almoxarifado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="localOrigemTransferencia" class="form-label">Local *</label>
                                <select class="form-select" id="localOrigemTransferencia" required>
                                    <option value="">Selecione o tipo primeiro...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Destino</h6>
                            <div class="mb-3">
                                <label for="tipoDestinoTransferencia" class="form-label">Tipo de Local *</label>
                                <select class="form-select" id="tipoDestinoTransferencia" required onchange="carregarLocaisDestino()">
                                    <option value="">Selecione...</option>
                                    <option value="almoxarifado">Almoxarifado</option>
                                    <option value="sub_almoxarifado">Sub-Almoxarifado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="localDestinoTransferencia" class="form-label">Local *</label>
                                <select class="form-select" id="localDestinoTransferencia" required>
                                    <option value="">Selecione o tipo primeiro...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoTransferencia" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivoTransferencia" maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesTransferencia" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoesTransferencia" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="executarTransferencia()">
                    <i class="fas fa-exchange-alt"></i> Executar Transferência
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Saída -->
<div class="modal fade" id="distribuicaoModal" tabindex="-1" aria-labelledby="distribuicaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="distribuicaoModalLabel">Saída para Setores</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="distribuicaoMsg" class="alert alert-warning d-none" role="alert"></div>
                <form id="distribuicaoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="produtoDistribuicao" class="form-label">Produto *</label>
                                <input type="text" class="form-control mb-2" id="buscaProdutoDistribuicao" placeholder="Buscar produto por nome ou código...">
                                <select class="form-select" id="produtoDistribuicao" required onchange="carregarLocaisProdutoDistribuicao()">
                                    <option value="">Selecione um produto...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Origem</h6>
                            <div class="mb-3">
                                <h6 class="text-muted">Disponibilidade por Local</h6>
                                <div id="distribuicaoDisponibilidade" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-muted">Selecione um produto para visualizar a disponibilidade por local.</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Setores de Destino</h6>
                            <div class="mb-3">
                                <label class="form-label">Selecione setores e informe quantidades:</label>
                                <div class="border rounded p-2" style="max-height: 240px; overflow-y: auto;">
                                    <div id="setoresDistribuicao">
                                        <div class="text-muted">Selecione um local de origem na tabela para listar os setores disponíveis conforme a hierarquia.</div>
                                    </div>
                            </div>
                            <div id="resumoDistribuicao" class="alert alert-info mt-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Resumo:</strong>
                                    <span id="resumoDisponivel">Disponível: -</span> ·
                                    <span id="resumoTotal">Total: -</span> ·
                                    <span id="resumoAlocado">Alocado: -</span> ·
                                    <span id="resumoSaldo">Saldo: -</span>
                                </div>
                                <div>
                                    <small class="text-muted">Distribua quantidades dentro do disponível da origem.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoDistribuicao" class="form-label">Motivo</label>
                        <input type="text" class="form-control" id="motivoDistribuicao" maxlength="200">
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesDistribuicao" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoesDistribuicao" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="executarDistribuicao()">
                    <i class="fas fa-arrow-up"></i> Executar Saída
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dados dos locais -->
<script type="application/json" id="centrais-data">{{ centrais | tojson | safe }}</script>
<script type="application/json" id="almoxarifados-data">{{ almoxarifados | tojson | safe }}</script>
<script type="application/json" id="sub-almoxarifados-data">{{ sub_almoxarifados | tojson | safe }}</script>
<script type="application/json" id="setores-data">{{ setores | tojson | safe }}</script>
<script type="application/json" id="use-mongo-flag">{{ 'true' if use_mongo else 'false' }}</script>

<script>
let currentPage = 1;
const itemsPerPage = 20;
let ordemMovimentacoes = 'desc'; // 'desc' = mais recentes primeiro (padrão), 'asc' = mais antigas primeiro

// Carregar dados dos locais
const centraisEl = document.getElementById('centrais-data');
const almoxEl = document.getElementById('almoxarifados-data');
const subEl = document.getElementById('sub-almoxarifados-data');
const setoresEl = document.getElementById('setores-data');

// Inicialização defensiva dos dados de locais (evita erros de parser do linter)
const locaisData = {};
locaisData.centrais = JSON.parse((centraisEl && centraisEl.textContent) ? centraisEl.textContent : '[]');
locaisData.almoxarifados = JSON.parse((almoxEl && almoxEl.textContent) ? almoxEl.textContent : '[]');
locaisData.sub_almoxarifados = JSON.parse((subEl && subEl.textContent) ? subEl.textContent : '[]');
locaisData.setores = JSON.parse((setoresEl && setoresEl.textContent) ? setoresEl.textContent : '[]');

// Indica se estamos em modo MongoDB (IDs são strings)
const USE_MONGO = (document.getElementById('use-mongo-flag') && document.getElementById('use-mongo-flag').textContent === 'true');

// Comparação segura de IDs (suporta números e strings)
function idEq(a, b) {
    return String(a) === String(b);
}

// Carregar movimentações
function carregarMovimentacoes(page = 1) {
    currentPage = page;
    
    const filtros = {
        tipo: document.getElementById('filtroTipo').value,
        produto: document.getElementById('filtroProduto').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        page: page,
        per_page: itemsPerPage,
        ordem: ordemMovimentacoes
    };
    
    const params = new URLSearchParams();
    Object.keys(filtros).forEach(key => {
        if (filtros[key]) params.append(key, filtros[key]);
    });
    
    window.fetchJson(`/api/movimentacoes?${params.toString()}`)
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            renderizarMovimentacoes(data.items);
            renderizarPaginacao(data.pagination);
        })
        .catch(error => {
            console.error('Erro:', error);
            // Se sessão expirar, o utilitário global já alerta e redireciona; evita poluir a tabela
            if (String(error && error.message).includes('Sessão expirada')) {
                return;
            }
            document.getElementById('movimentacoesTableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao carregar movimentações: ${error.message}
                    </td>
                </tr>
            `;
        });
}

// Alternar ordenação das movimentações (mais recentes/mais antigas)
function atualizarBotaoOrdenacao() {
    const btn = document.getElementById('btnOrdenacaoMovs');
    if (!btn) return;
    if (ordemMovimentacoes === 'desc') {
        btn.innerHTML = '<i class="fas fa-sort-amount-down"></i> Mais recentes primeiro';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-secondary');
        btn.title = 'Mostrar mais antigas primeiro';
    } else {
        btn.innerHTML = '<i class="fas fa-sort-amount-up"></i> Mais antigas primeiro';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-primary');
        btn.title = 'Mostrar mais recentes primeiro';
    }
}
function toggleOrdenacaoMovs() {
    ordemMovimentacoes = (ordemMovimentacoes === 'desc' ? 'asc' : 'desc');
    atualizarBotaoOrdenacao();
    carregarMovimentacoes(1);
}

// Renderizar movimentações na tabela
function renderizarMovimentacoes(movimentacoes) {
    const tbody = document.getElementById('movimentacoesTableBody');
    
    if (!movimentacoes || movimentacoes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox"></i> Nenhuma movimentação encontrada
                </td>
            </tr>
        `;
        return;
    }
    
    const tipoIcons = {
        'entrada': 'fas fa-arrow-down text-success',
        'saida': 'fas fa-arrow-up text-danger',
        'transferencia': 'fas fa-exchange-alt text-primary',
        // suportar registros legados marcados como "distribuição" com ícone de saída
        'distribuicao': 'fas fa-arrow-up text-danger',
        'distribuição': 'fas fa-arrow-up text-danger'
    };
    const tipoLabels = {
        'entrada': 'Entrada',
        'saida': 'Saída',
        'transferencia': 'Transferência',
        // mapear registros antigos para "Saída"
        'distribuicao': 'Saída',
        'distribuição': 'Saída'
    };
    
    tbody.innerHTML = movimentacoes.map(mov => `
        <tr>
            <td>
                <div>${new Date(mov.data_movimentacao).toLocaleDateString('pt-BR')}</div>
                <small class="text-muted">${new Date(mov.data_movimentacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</small>
            </td>
            <td>
                <i class="${tipoIcons[mov.tipo_movimentacao?.toLowerCase()] || 'fas fa-question'}"></i>
                ${tipoLabels[mov.tipo_movimentacao?.toLowerCase()] || mov.tipo_movimentacao}
            </td>
            <td>
                <strong>${mov.produto_nome}</strong><br>
                <small>${mov.produto_codigo}</small>
            </td>
            <td>${parseFloat(mov.quantidade).toLocaleString('pt-BR')} ${mov.produto_unidade}</td>
            <td>${(() => {
                const origem = mov.origem_nome || '';
                const destino = mov.destino_nome || '';
                if (origem && destino) return `${origem} → ${destino}`;
                return origem || destino || '-';
            })()}</td>
            <td>${mov.usuario_responsavel}</td>
            <td>${mov.motivo || '-'}</td>
        </tr>
    `).join('');
}

// Renderizar paginação
function renderizarPaginacao(pagination) {
    const paginacaoEl = document.getElementById('paginacao');
    
    if (!pagination || pagination.total_pages <= 1) {
        paginacaoEl.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Botão anterior
    if (pagination.current_page > 1) {
        html += `<li class="page-item">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${pagination.current_page - 1})">Anterior</a>
        </li>`;
    }
    
    // Páginas
    for (let i = Math.max(1, pagination.current_page - 2); i <= Math.min(pagination.total_pages, pagination.current_page + 2); i++) {
        html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${i})">${i}</a>
        </li>`;
    }
    
    // Botão próximo
    if (pagination.current_page < pagination.total_pages) {
        html += `<li class="page-item">
            <a class="page-link" href="#" onclick="carregarMovimentacoes(${pagination.current_page + 1})">Próximo</a>
        </li>`;
    }
    
    paginacaoEl.innerHTML = html;
}

// Filtrar movimentações
function filtrarMovimentacoes() {
    carregarMovimentacoes(1);
}

// Carregar produtos para os selects
function carregarProdutos(searchTerm = '') {
    const params = new URLSearchParams({ativo: 'true', per_page: '1000'});
    if (searchTerm && searchTerm.trim() !== '') {
        params.set('search', searchTerm.trim());
    }
    fetchJson('/api/produtos?' + params.toString())
        .then(data => {
            const produtos = data.items || [];
            const selectTransferencia = document.getElementById('produtoTransferencia');
            const selectDistribuicao = document.getElementById('produtoDistribuicao');
            const options = produtos.map(produto => 
                `<option value="${produto.id}">${produto.codigo || ''} - ${produto.nome}</option>`
            ).join('');
            if (selectTransferencia) {
                const current = selectTransferencia.value;
                selectTransferencia.innerHTML = '<option value="">Selecione um produto...</option>' + options;
                if (current && [...selectTransferencia.options].some(o => o.value === current)) {
                    selectTransferencia.value = current;
                }
            }
            if (selectDistribuicao) {
                const current2 = selectDistribuicao.value;
                selectDistribuicao.innerHTML = '<option value="">Selecione um produto...</option>' + options;
                if (current2 && [...selectDistribuicao.options].some(o => o.value === current2)) {
                    selectDistribuicao.value = current2;
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
        });
}

// Carregar locais de origem para transferência
function carregarLocaisOrigem() {
    const tipo = document.getElementById('tipoOrigemTransferencia').value;
    const produtoId = document.getElementById('produtoTransferencia').value;
    const select = document.getElementById('localOrigemTransferencia');
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }

    const buildLocaisPermitidos = async () => {
        if (USE_MONGO) {
            // Em Mongo, buscar via API respeitando a central do produto
            if (!produtoId) {
                if (tipo === 'almoxarifado') {
                    const resp = await fetchJson(`/api/almoxarifados?per_page=1000`);
                    return resp.items || [];
                }
                if (tipo === 'sub_almoxarifado') {
                    const resp = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                    return resp.items || [];
                }
                if (tipo === 'setor') {
                    const resp = await fetchJson(`/api/setores?per_page=1000`);
                    return resp.items || [];
                }
                return [];
            }
            const produto = await fetchJson(`/api/produtos/${produtoId}`);
            const produtoCentral = produto.central_id;
            if (tipo === 'almoxarifado') {
                const resp = await fetchJson(`/api/almoxarifados?central_id=${encodeURIComponent(produtoCentral)}&per_page=1000`);
                return resp.items || [];
            } else if (tipo === 'sub_almoxarifado') {
                const almoxResp = await fetchJson(`/api/almoxarifados?central_id=${encodeURIComponent(produtoCentral)}&per_page=1000`);
                const almoxIdsCentral = (almoxResp.items || []).map(a => String(a.id));
                const subsResp = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                return (subsResp.items || []).filter(sa => almoxIdsCentral.includes(String(sa.almoxarifado_id)));
            } else if (tipo === 'setor') {
                const almoxResp = await fetchJson(`/api/almoxarifados?central_id=${encodeURIComponent(produtoCentral)}&per_page=1000`);
                const almoxIdsCentral = (almoxResp.items || []).map(a => String(a.id));
                const subsResp = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                const subIdsCentral = (subsResp.items || []).filter(sa => almoxIdsCentral.includes(String(sa.almoxarifado_id))).map(sa => String(sa.id));
                const setoresResp = await fetchJson(`/api/setores?per_page=1000`);
                return (setoresResp.items || []).filter(s => subIdsCentral.includes(String(s.sub_almoxarifado_id)));
            }
            return [];
        } else {
            // SQL: usar dados embutidos no template
            if (!produtoId) {
                if (tipo === 'almoxarifado') return (locaisData.almoxarifados || []);
                if (tipo === 'sub_almoxarifado') return (locaisData.sub_almoxarifados || []);
                if (tipo === 'setor') return (locaisData.setores || []);
                return [];
            }
            const produto = await fetchJson(`/api/produtos/${produtoId}`);
            const produtoCentral = produto.central_id;
            if (tipo === 'almoxarifado') {
                return (locaisData.almoxarifados || [])
                    .filter(a => String(a.central_id) === String(produtoCentral));
            } else if (tipo === 'sub_almoxarifado') {
                const almoxIdsCentral = (locaisData.almoxarifados || [])
                    .filter(a => String(a.central_id) === String(produtoCentral))
                    .map(a => String(a.id));
                return (locaisData.sub_almoxarifados || [])
                    .filter(sa => almoxIdsCentral.includes(String(sa.almoxarifado_id)));
            } else if (tipo === 'setor') {
                const almoxIdsCentral = (locaisData.almoxarifados || [])
                    .filter(a => String(a.central_id) === String(produtoCentral))
                    .map(a => String(a.id));
                const subIdsCentral = (locaisData.sub_almoxarifados || [])
                    .filter(sa => almoxIdsCentral.includes(String(sa.almoxarifado_id)))
                    .map(sa => String(sa.id));
                return (locaisData.setores || [])
                    .filter(s => subIdsCentral.includes(String(s.sub_almoxarifado_id)));
            }
            return [];
        }
    };

    // Mostrar estado de carregamento
    select.innerHTML = '<option value="">Carregando...</option>';

    buildLocaisPermitidos()
        .then(async locaisPermitidos => {
            // Sem produto: apenas lista locais permitidos pelo tipo
            if (!produtoId) {
                const options = (locaisPermitidos || []).map(l => `<option value="${l.id}">${l.nome}</option>`).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
                return;
            }

            // Com produto: intersectar com locais que têm estoque (ignorar estoque.tipo para evitar vazamento de sub-almoxarifados)
            const estoqueData = await fetchJson(`/api/produtos/${produtoId}/estoque`);
            const estoques = Array.isArray(estoqueData.estoques) ? estoqueData.estoques : [];
            const normalizeTipo = (t) => String(t || '').toLowerCase().replace(/[-]/g, '_').replace(/^subalmoxarifado$/, 'sub_almoxarifado');
            const tipoSel = normalizeTipo(tipo);
            const tipoMatch = (t) => {
                const nt = normalizeTipo(t);
                if (tipoSel === 'sub_almoxarifado') return nt === 'sub_almoxarifado' || nt === 'subalmoxarifado';
                return nt === tipoSel; // 'almoxarifado', 'setor', 'central'
            };
            const estoquePorId = {};
            const nomeLocalPorId = {};

            estoques.filter(e => e && tipoMatch(e.tipo)).forEach(e => {
                const id = String(e.local_id);
                if (e.nome_local) {
                    nomeLocalPorId[id] = e.nome_local;
                }
                if (typeof e.quantidade_disponivel === 'number' && e.quantidade_disponivel > 0) {
                    estoquePorId[id] = e.quantidade_disponivel;
                }
            });

            const locaisFiltrados = (locaisPermitidos || []).filter(l => estoquePorId[String(l.id)] > 0);

            if (!locaisFiltrados || locaisFiltrados.length === 0) {
                select.innerHTML = '<option value="">Nenhum local com estoque disponível na central do produto</option>';
            } else {
                const options = locaisFiltrados.map(local => {
                    const id = String(local.id);
                    const qtd = estoquePorId[id] || 0;
                    return `<option value="${local.id}">${local.nome} (Disponível: ${qtd})</option>`;
                }).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar locais de origem:', error);
            // Fallback para mostrar todos os locais do tipo (sem filtrar por estoque)
            let locais = [];
            if (tipo === 'almoxarifado') locais = (locaisData.almoxarifados || []);
            else if (tipo === 'sub_almoxarifado') locais = (locaisData.sub_almoxarifados || []);
            else if (tipo === 'setor') locais = (locaisData.setores || []);
            const options = locais.map(local => `<option value="${local.id}">${local.nome}</option>`).join('');
            select.innerHTML = '<option value="">Selecione...</option>' + options;
        });
}

// Carregar tipos de destino disponíveis baseados na central do produto
function carregarTiposDestino() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const tipoSelect = document.getElementById('tipoDestinoTransferencia');
    const localSelect = document.getElementById('localDestinoTransferencia');
    
    // Limpar seleções
    tipoSelect.value = '';
    localSelect.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
    
    if (!produtoId) {
        tipoSelect.innerHTML = `
            <option value="">Selecione um produto primeiro...</option>
        `;
        return;
    }
    
    // Buscar informações do produto para verificar quais tipos estão disponíveis
    fetchJson(`/api/produtos/${produtoId}`)
        .then(async produto => {
            let opcoesDisponiveis = [];

            if (USE_MONGO) {
                // Em Mongo, buscar listas via API e comparar por string central_id
                const almoxResp = await fetchJson(`/api/almoxarifados?central_id=${encodeURIComponent(produto.central_id)}&per_page=1000`);
                const almoxarifadosDaCentral = almoxResp.items || [];
                if (almoxarifadosDaCentral.length > 0) {
                    opcoesDisponiveis.push('<option value="almoxarifado">Almoxarifado</option>');
                }
                // Normalizar IDs para comparação robusta (número ou ObjectId)
                const almoxIds = almoxarifadosDaCentral.map(a => String(a.id));
                const subsResp = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                const subAlmoxarifadosDaCentral = (subsResp.items || []).filter(sa => almoxIds.includes(String(sa.almoxarifado_id)));
                if (subAlmoxarifadosDaCentral.length > 0) {
                    opcoesDisponiveis.push('<option value="sub_almoxarifado">Sub-Almoxarifado</option>');
                }
            } else {
                // SQL: usar dados carregados do template sem chamadas à API
                const almoxarifadosDaCentral = (locaisData.almoxarifados || []).filter(almox => String(almox.central_id) === String(produto.central_id));
                if (almoxarifadosDaCentral.length > 0) {
                    opcoesDisponiveis.push('<option value="almoxarifado">Almoxarifado</option>');
                }
                const almoxIds = almoxarifadosDaCentral.map(almox => String(almox.id));
                const subAlmoxarifadosDaCentral = (locaisData.sub_almoxarifados || []).filter(subAlmox => almoxIds.includes(String(subAlmox.almoxarifado_id)));
                if (subAlmoxarifadosDaCentral.length > 0) {
                    opcoesDisponiveis.push('<option value="sub_almoxarifado">Sub-Almoxarifado</option>');
                }
            }
            
            if (opcoesDisponiveis.length === 0) {
                tipoSelect.innerHTML = '<option value="">Nenhum tipo de local disponível</option>';
            } else {
                tipoSelect.innerHTML = '<option value="">Selecione...</option>' + opcoesDisponiveis.join('');
                // Se houver apenas um tipo disponível, selecionar automaticamente e carregar locais
                const totalOptions = tipoSelect.options.length;
                if (totalOptions === 2) { // inclui a opção "Selecione..." + 1 disponível
                    tipoSelect.selectedIndex = 1;
                    try { carregarLocaisDestino(); } catch (_) {}
                }
            }
        })
        .catch(error => {
            console.error('Erro ao carregar tipos de destino:', error);
            tipoSelect.innerHTML = '<option value="">Erro ao carregar tipos</option>';
        });
}

// Carregar locais de destino para transferência
function carregarLocaisDestino() {
    const tipo = document.getElementById('tipoDestinoTransferencia').value;
    const produtoId = document.getElementById('produtoTransferencia').value;
    const select = document.getElementById('localDestinoTransferencia');
    const tipoOrigem = document.getElementById('tipoOrigemTransferencia').value;
    const localOrigem = document.getElementById('localOrigemTransferencia').value;
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }
    
    if (!produtoId) {
        select.innerHTML = '<option value="">Selecione um produto primeiro...</option>';
        return;
    }
    
    // Buscar informações do produto para obter a central
    fetchJson(`/api/produtos/${produtoId}`)
        .then(async produto => {
            let locais = [];
            
            if (USE_MONGO) {
                // Em Mongo, buscar listas via API e montar conforme o tipo, respeitando a origem
                if (tipo === 'almoxarifado') {
                    const resp = await fetchJson(`/api/almoxarifados?central_id=${encodeURIComponent(produto.central_id)}&per_page=1000`);
                    locais = resp.items || [];
                } else if (tipo === 'sub_almoxarifado') {
                    // Carregar apenas sub-almoxarifados que pertencem ao almoxarifado da origem
                    if (!tipoOrigem || !localOrigem) {
                        select.innerHTML = '<option value="">Selecione o almoxarifado de origem primeiro...</option>';
                        return;
                    }
                    let almoxRefId = null;
                    if (tipoOrigem === 'almoxarifado') {
                        almoxRefId = String(localOrigem);
                    } else if (tipoOrigem === 'sub_almoxarifado') {
                        const subsAll = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                        const subOrigem = (subsAll.items || []).find(sa => String(sa.id) === String(localOrigem));
                        almoxRefId = subOrigem ? String(subOrigem.almoxarifado_id) : null;
                    } else if (tipoOrigem === 'setor') {
                        const setoresAll = await fetchJson(`/api/setores?per_page=1000`);
                        const setorOrigem = (setoresAll.items || []).find(s => String(s.id) === String(localOrigem));
                        if (setorOrigem) {
                            const subsAll = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                            const subParent = (subsAll.items || []).find(sa => String(sa.id) === String(setorOrigem.sub_almoxarifado_id));
                            almoxRefId = subParent ? String(subParent.almoxarifado_id) : null;
                        }
                    }
                    if (!almoxRefId) {
                        select.innerHTML = '<option value="">Origem inválida ou não encontrada</option>';
                        return;
                    }
                    const subsResp = await fetchJson(`/api/sub-almoxarifados?per_page=1000`);
                    locais = (subsResp.items || []).filter(sa => String(sa.almoxarifado_id) === almoxRefId);
                } else if (tipo === 'setor') {
                    // Carregar setores respeitando múltiplos vínculos: sub_almoxarifado_id e sub_almoxarifado_ids
                    if (!tipoOrigem || !localOrigem) {
                        select.innerHTML = '<option value="">Selecione a origem primeiro...</option>';
                        return;
                    }
                    const setoresResp = await fetchJson(`/api/setores?per_page=1000`);
                    const todosSetores = setoresResp.items || [];
                    if (tipoOrigem === 'sub_almoxarifado') {
                        const subRefId = String(localOrigem);
                        locais = todosSetores.filter(s => {
                            const single = String(s.sub_almoxarifado_id);
                            const multi = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids.map(v => String(v)) : [];
                            return single === subRefId || multi.includes(subRefId);
                        });
                    } else if (tipoOrigem === 'setor') {
                        const setorOrigem = todosSetores.find(s => String(s.id) === String(localOrigem));
                        const subRefId = setorOrigem ? String(setorOrigem.sub_almoxarifado_id) : null;
                        if (!subRefId) {
                            select.innerHTML = '<option value="">Origem inválida ou não encontrada</option>';
                            return;
                        }
                        locais = todosSetores.filter(s => {
                            const single = String(s.sub_almoxarifado_id);
                            const multi = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids.map(v => String(v)) : [];
                            return single === subRefId || multi.includes(subRefId);
                        });
                    } else if (tipoOrigem === 'almoxarifado') {
                        // Permitir setores vinculados ao almoxarifado selecionado, inclusive múltiplos
                        const almoxRefId = String(localOrigem);
                        locais = todosSetores.filter(s => {
                            const aSingle = String(s.almoxarifado_id || '');
                            const aMulti = Array.isArray(s.almoxarifado_ids) ? s.almoxarifado_ids.map(v => String(v)) : [];
                            return aSingle === almoxRefId || aMulti.includes(almoxRefId);
                        });
                    }
                }
            } else {
                // SQL: montar listas a partir dos dados embutidos no template
                switch (tipo) {
                    case 'almoxarifado':
                        locais = (locaisData.almoxarifados || []).filter(a => a.central_id === produto.central_id);
                        break;
                    case 'sub_almoxarifado': {
                        if (!tipoOrigem || !localOrigem) {
                            select.innerHTML = '<option value="">Selecione o almoxarifado de origem primeiro...</option>';
                            return;
                        }
                        let almoxRefId = null;
                        if (tipoOrigem === 'almoxarifado') {
                            almoxRefId = localOrigem;
                        } else if (tipoOrigem === 'sub_almoxarifado') {
                            const subOrigem = (locaisData.sub_almoxarifados || []).find(sa => idEq(sa.id, localOrigem));
                            almoxRefId = subOrigem ? subOrigem.almoxarifado_id : null;
                        } else if (tipoOrigem === 'setor') {
                            const setorOrigem = (locaisData.setores || []).find(s => idEq(s.id, localOrigem));
                            const subParent = setorOrigem ? (locaisData.sub_almoxarifados || []).find(sa => idEq(sa.id, setorOrigem.sub_almoxarifado_id)) : null;
                            almoxRefId = subParent ? subParent.almoxarifado_id : null;
                        }
                        if (!almoxRefId) {
                            select.innerHTML = '<option value="">Origem inválida ou não encontrada</option>';
                            return;
                        }
                        locais = (locaisData.sub_almoxarifados || []).filter(sa => idEq(sa.almoxarifado_id, almoxRefId));
                        break;
                    }
                    case 'setor': {
                        if (!tipoOrigem || !localOrigem) {
                            select.innerHTML = '<option value="">Selecione a origem primeiro...</option>';
                            return;
                        }
                        const todosSetores = (locaisData.setores || []);
                        if (tipoOrigem === 'sub_almoxarifado') {
                            const subRefId = localOrigem;
                            locais = todosSetores.filter(s => {
                                const single = s.sub_almoxarifado_id;
                                const multi = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids : [];
                                return idEq(single, subRefId) || multi.some(v => idEq(v, subRefId));
                            });
                        } else if (tipoOrigem === 'setor') {
                            const setorOrigem = todosSetores.find(s => idEq(s.id, localOrigem));
                            const subRefId = setorOrigem ? setorOrigem.sub_almoxarifado_id : null;
                            if (!subRefId) {
                                select.innerHTML = '<option value="">Origem inválida ou não encontrada</option>';
                                return;
                            }
                            locais = todosSetores.filter(s => {
                                const single = s.sub_almoxarifado_id;
                                const multi = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids : [];
                                return idEq(single, subRefId) || multi.some(v => idEq(v, subRefId));
                            });
                        } else if (tipoOrigem === 'almoxarifado') {
                            // Permitir setores vinculados ao almoxarifado selecionado, inclusive múltiplos
                            const almoxRefId = localOrigem;
                            // Subs pertencentes ao almoxarifado (para cobrir setores vinculados por sub)
                            const subsDoAlmox = (locaisData.sub_almoxarifados || [])
                                .filter(sa => idEq(sa.almoxarifado_id, almoxRefId))
                                .map(sa => String(sa.id));
                            locais = todosSetores.filter(s => {
                                const aSingle = s.almoxarifado_id;
                                const aMulti = Array.isArray(s.almoxarifado_ids) ? s.almoxarifado_ids : [];
                                const sSingle = String(s.sub_almoxarifado_id || '');
                                const sMulti = Array.isArray(s.sub_almoxarifado_ids) ? s.sub_almoxarifado_ids.map(v => String(v)) : [];
                                return idEq(aSingle, almoxRefId) || aMulti.some(v => idEq(v, almoxRefId)) || subsDoAlmox.includes(sSingle) || sMulti.some(v => subsDoAlmox.includes(String(v)));
                            });
                        }
                        break;
                    }
                }
            }
            
            if (locais.length === 0) {
                select.innerHTML = '<option value="">Nenhum local disponível para este produto</option>';
            } else {
                // Anexar quantidade atual do produto no destino, quando disponível
                let estoquePorId = {};
                try {
                    const estoqueData = await fetchJson(`/api/produtos/${produtoId}/estoque`);
                    const normalizeTipo = (t) => String(t || '').toLowerCase().replace(/[-]/g, '_').replace(/^subalmoxarifado$/, 'sub_almoxarifado');
                    const tipoSel = normalizeTipo(tipo);
                    const tipoMatch = (t) => {
                        const nt = normalizeTipo(t);
                        if (tipoSel === 'sub_almoxarifado') return nt === 'sub_almoxarifado' || nt === 'subalmoxarifado';
                        return nt === tipoSel;
                    };
                    (Array.isArray(estoqueData.estoques) ? estoqueData.estoques : [])
                        .filter(e => e && tipoMatch(e.tipo))
                        .forEach(e => {
                            estoquePorId[String(e.local_id)] = e.quantidade_disponivel;
                        });
                } catch (err) {
                    console.error('Erro ao carregar estoque do destino:', err);
                }

                // UI: não permitir transferir para o mesmo Sub‑Almoxarifado
                if (String(tipo) === 'sub_almoxarifado' && String(tipoOrigem) === 'sub_almoxarifado' && localOrigem) {
                    locais = locais.filter(local => String(local.id) !== String(localOrigem));
                }

                // Remover duplicidades por id (se houver)
                const uniqById = new Map();
                locais.forEach(local => {
                    const key = String(local.id);
                    if (!uniqById.has(key)) uniqById.set(key, local);
                });
                locais = Array.from(uniqById.values());

                const options = locais
                    .filter(local => local.id !== undefined && local.id !== null && local.id !== 'undefined')
                    .map(local => {
                        const qtd = estoquePorId[String(local.id)];
                        const qtyText = (typeof qtd === 'number') ? ` (Atual: ${qtd})` : '';
                        return `<option value="${local.id}">${local.nome}${qtyText}</option>`;
                    }) // não forçar parseInt para suportar ObjectId
                    .join('');
                
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar informações do produto:', error);
            select.innerHTML = '<option value="">Erro ao carregar locais</option>';
        });
}

// Carregar locais de origem para distribuição
function carregarLocaisOrigemDistribuicao() {
    const tipo = document.getElementById('tipoOrigemDistribuicao').value;
    const produtoId = document.getElementById('produtoDistribuicao').value;
    const select = document.getElementById('localOrigemDistribuicao');
    
    if (!tipo) {
        select.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
        return;
    }
    // Mostrar estado de carregamento
    select.innerHTML = '<option value="">Carregando...</option>';

    let locais = [];
    const carregarListaBase = async () => {
        if (USE_MONGO) {
            // Em Mongo, buscar via API
            if (tipo === 'almoxarifado') {
                const resp = await fetchJson('/api/almoxarifados?per_page=1000');
                return resp.items || [];
            } else if (tipo === 'sub_almoxarifado') {
                const resp = await fetchJson('/api/sub-almoxarifados?per_page=1000');
                return resp.items || [];
            } else if (tipo === 'central') {
                // Central não é usada em Mongo (opção removida), manter fallback
                return locaisData.centrais || [];
            }
            return [];
        } else {
            // SQL: usar dados embutidos
            if (tipo === 'central') return (locaisData.centrais || []);
            if (tipo === 'almoxarifado') return (locaisData.almoxarifados || []);
            if (tipo === 'sub_almoxarifado') return (locaisData.sub_almoxarifados || []);
            return [];
        }
    };
    
    // Se um produto estiver selecionado, mostrar apenas locais com estoque
    if (produtoId) {
        fetchJson(`/api/produtos/${produtoId}/estoque`)
            .then(data => {
                if (data.estoques && data.estoques.length > 0) {
                    const normalizeTipo = (t) => String(t || '').toLowerCase().replace(/[-]/g, '_').replace(/^subalmoxarifado$/, 'sub_almoxarifado');
                    const estoquesDoTipo = data.estoques.filter(estoque => 
                        normalizeTipo(estoque.tipo) === normalizeTipo(tipo) && estoque.quantidade_disponivel > 0
                    );
                    
                    const options = estoquesDoTipo.map(estoque => 
                        `<option value="${estoque.local_id}">${estoque.nome_local} (Disponível: ${estoque.quantidade_disponivel})</option>`
                    ).join('');
                    
                    select.innerHTML = '<option value="">Selecione...</option>' + options;
                } else {
                    select.innerHTML = '<option value="">Nenhum local com estoque disponível</option>';
                }
            })
            .catch(async error => {
                console.error('Erro ao carregar estoque:', error);
                // Fallback: carregar lista base e mostrar todos os locais
                try {
                    locais = await carregarListaBase();
                } catch (_) { locais = locais || []; }
                const options = (locais || []).map(local => 
                    `<option value="${local.id}">${local.nome}</option>`
                ).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            });
    } else {
        // Se nenhum produto selecionado, carregar lista base e mostrar todos os locais
        carregarListaBase()
            .then(lista => {
                locais = lista || [];
                const options = locais.map(local => 
                    `<option value="${local.id}">${local.nome}</option>`
                ).join('');
                select.innerHTML = '<option value="">Selecione...</option>' + options;
            })
            .catch(error => {
                console.error('Erro ao carregar locais:', error);
                select.innerHTML = '<option value="">Erro ao carregar locais</option>';
            });
    }
}

// Renderiza a lista de setores (checkboxes) no container
function renderSetoresDistribuicao(setores) {
    const container = document.getElementById('setoresDistribuicao');
    if (!container) return;
    if (!Array.isArray(setores) || setores.length === 0) {
        container.innerHTML = '<div class="text-muted">Nenhum setor disponível para a origem selecionada.</div>';
        updateResumoDistribuicao();
        return;
    }
    const html = `
        <div class="row mb-2">
            <div class="col-7"><small class="text-muted">Setor</small></div>
            <div class="col-5 text-end"><small class="text-muted">Quantidade</small></div>
        </div>
        ${setores.map(s => {
            const setorId = s.id;
            const setorNome = s.nome;
            const parentInfo = (() => {
                // Mostrar hierarquia breve usando nomes fornecidos pela API
                const parts = [];
                if (Array.isArray(s.sub_almoxarifado_nomes) && s.sub_almoxarifado_nomes.length) {
                    parts.push(s.sub_almoxarifado_nomes.join(' / '));
                } else if (s.sub_almoxarifado_nome) {
                    parts.push(s.sub_almoxarifado_nome);
                }
                if (s.almoxarifado_nome) {
                    parts.push(s.almoxarifado_nome);
                }
                return parts.length ? ' <small class="text-muted">(' + parts.join(' → ') + ')</small>' : '';
            })();
            return `
            <div class="row align-items-center py-1">
                <div class="col-7 d-flex align-items-center gap-2">
                    <input class="form-check-input setor-check" type="checkbox" value="${setorId}" id="setor${setorId}">
                    <label class="form-check-label" for="setor${setorId}">${setorNome}${parentInfo}</label>
                </div>
                <div class="col-5">
                    <input type="number" class="form-control form-control-sm setor-qty" data-setor-id="${setorId}" min="0.001" step="0.001" placeholder="0,000" disabled>
                </div>
            </div>`;
        }).join('')}
    `;
    container.innerHTML = html;
    // listeners para habilitar/desabilitar quantidade e atualizar resumo
    container.querySelectorAll('.setor-check').forEach(chk => {
        chk.addEventListener('change', (e) => {
            const setorId = e.target.value;
            const qtyInput = container.querySelector(`.setor-qty[data-setor-id="${setorId}"]`);
            if (qtyInput) {
                qtyInput.disabled = !e.target.checked;
                if (!e.target.checked) qtyInput.value = '';
            }
            updateResumoDistribuicao();
        });
    });
    container.querySelectorAll('.setor-qty').forEach(inp => {
        inp.addEventListener('input', updateResumoDistribuicao);
        inp.addEventListener('change', updateResumoDistribuicao);
    });
    updateResumoDistribuicao();
}

// Filtra setores obedecendo a hierarquia da origem selecionada
async function filtrarSetoresDistribuicao() {
    const origemSel = window.origemDistribuicaoSelecionada || {};
    const tipo = origemSel.tipo;
    const origemId = origemSel.id;
    const container = document.getElementById('setoresDistribuicao');
    if (container) {
        container.innerHTML = '<div class="text-muted">Carregando setores...</div>';
    }
    let todosSetores = [];
    try {
        const resp = await fetchJson('/api/setores?per_page=1000');
        todosSetores = resp.items || [];
    } catch (err) {
        console.error('Erro ao carregar setores via API:', err);
        // Fallback para dados embutidos no template
        todosSetores = locaisData.setores || [];
    }
    if (!tipo || !origemId) {
        renderSetoresDistribuicao([]);
        return;
    }

    // Helper: verifica se o setor pertence ao sub informado considerando
    // campo legado (sub_almoxarifado_id) e novo (sub_almoxarifado_ids)
    const setorPertenceAoSub = (setor, subId) => {
        const single = setor.sub_almoxarifado_id;
        const multi = Array.isArray(setor.sub_almoxarifado_ids) ? setor.sub_almoxarifado_ids : [];
        return idEq(single, subId) || multi.some(id => idEq(id, subId));
    };

    let setoresFiltrados = [];
    if (tipo === 'central') {
        // Filtrar diretamente pelos campos normalizados da API
        const matchId = (val) => idEq(val, origemId);
        const matchAny = (list) => Array.isArray(list) && list.some(matchId);
        setoresFiltrados = todosSetores.filter(s => matchId(s.central_id) || matchAny(s.central_ids));
    } else if (tipo === 'almoxarifado') {
        // Filtrar diretamente por almoxarifado_id(s) do setor
        const matchId = (val) => idEq(val, origemId);
        const matchAny = (list) => Array.isArray(list) && list.some(matchId);
        setoresFiltrados = todosSetores.filter(s => matchId(s.almoxarifado_id) || matchAny(s.almoxarifado_ids));
    } else if (tipo === 'sub_almoxarifado') {
        // Priorizar setores vinculados diretamente ao sub
        const diretos = todosSetores.filter(s => setorPertenceAoSub(s, origemId));
        // Além disso, incluir setores vinculados ao almoxarifado pai do sub selecionado
        let almoxDoSub = null;
        try {
            const subData = await fetchJson(`/api/sub-almoxarifados/${encodeURIComponent(origemId)}`);
            almoxDoSub = subData ? subData.almoxarifado_id : null;
        } catch (_) {
            almoxDoSub = null;
        }
        let porAlmox = [];
        if (almoxDoSub) {
            const matchId = (val) => idEq(val, almoxDoSub);
            const matchAny = (list) => Array.isArray(list) && list.some(matchId);
            porAlmox = todosSetores.filter(s => matchId(s.almoxarifado_id) || matchAny(s.almoxarifado_ids));
        }
        // Unir listas evitando duplicados por id
        const uniq = new Map();
        [...diretos, ...porAlmox].forEach(s => { if (s && s.id != null) uniq.set(String(s.id), s); });
        setoresFiltrados = Array.from(uniq.values());
    } else {
        setoresFiltrados = [];
    }

    renderSetoresDistribuicao(setoresFiltrados);
}

// Render disponibilidade por local para o produto selecionado e permitir seleção pelo clique
function renderDisponibilidadeProduto(estoques) {
    const cont = document.getElementById('distribuicaoDisponibilidade');
    if (!cont) return;
    if (!Array.isArray(estoques) || estoques.length === 0) {
        cont.innerHTML = '<div class="text-muted">Produto sem estoque disponível para saída.</div>';
        return;
    }
    const normalizeTipo = (t) => String(t || '').toLowerCase().replace(/[-]/g, '_').replace(/^subalmoxarifado$/, 'sub_almoxarifado');
    const linhas = estoques
        .filter(e => normalizeTipo(e.tipo) !== 'setor' && (e.quantidade_disponivel || 0) > 0)
        .map(e => ({ tipo: normalizeTipo(e.tipo), id: e.local_id, nome: e.nome_local, disponivel: e.quantidade_disponivel }));
    if (!linhas.length) {
        cont.innerHTML = '<div class="text-muted">Produto sem estoque disponível para saída.</div>';
        return;
    }
    cont.innerHTML = `
        <table class="table table-sm table-hover mb-0">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Local</th>
                    <th class="text-end">Disponível</th>
                </tr>
            </thead>
            <tbody>
                ${linhas.map(l => `
                    <tr class="cursor-pointer" data-tipo="${l.tipo}" data-id="${l.id}">
                        <td>${l.tipo.replace('_', ' ')}</td>
                        <td>${l.nome}</td>
                        <td class="text-end">${l.disponivel}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
    // Clique numa linha seleciona origem e atualiza resumo
    cont.querySelectorAll('tr[data-tipo][data-id]').forEach(tr => {
        tr.addEventListener('click', () => {
            const tipo = tr.getAttribute('data-tipo');
            const id = tr.getAttribute('data-id');
            // Destacar linha selecionada
            cont.querySelectorAll('tbody tr').forEach(r => r.classList.remove('table-active'));
            tr.classList.add('table-active');
            // Guardar seleção global
            const nomeLocal = tr.querySelector('td:nth-child(2)')?.textContent || 'Local';
            window.origemDistribuicaoSelecionada = { tipo, id: id, nome: nomeLocal };
            // definir disponibilidade global
            window.disponivelOrigemDistribuicao = parseFloat(tr.querySelector('td.text-end').textContent) || 0;
            updateResumoDistribuicao();
            // atualizar setores conforme origem selecionada
            filtrarSetoresDistribuicao();
        });
    });
    // Selecionar automaticamente se houver apenas um local disponível
    const rows = cont.querySelectorAll('tbody tr');
    if (rows.length === 1) {
        rows[0].click();
    }
}

// Resumo dinâmico
window.disponivelOrigemDistribuicao = 0;
function updateResumoDistribuicao() {
    const dispEl = document.getElementById('resumoDisponivel');
    const totEl = document.getElementById('resumoTotal');
    const alocEl = document.getElementById('resumoAlocado');
    const saldoEl = document.getElementById('resumoSaldo');
    const disp = typeof window.disponivelOrigemDistribuicao === 'number' ? window.disponivelOrigemDistribuicao : 0;
    // soma das quantidades dos setores selecionados
    let soma = 0;
    document.querySelectorAll('#setoresDistribuicao .setor-check').forEach(chk => {
        if (chk.checked) {
            const inp = document.querySelector(`#setoresDistribuicao .setor-qty[data-setor-id="${chk.value}"]`);
            const val = parseFloat(inp?.value || 0) || 0;
            soma += val;
        }
    });
    const saldo = disp - soma;
    if (dispEl) dispEl.textContent = `Disponível: ${disp}`;
    if (totEl) totEl.textContent = `Total: ${soma}`;
    if (alocEl) alocEl.textContent = `Alocado: ${soma}`;
    if (saldoEl) saldoEl.textContent = `Saldo: ${saldo}`;
}

// Carregar locais onde o produto está disponível para distribuição
function carregarLocaisProdutoDistribuicao() {
    const produtoId = document.getElementById('produtoDistribuicao').value;
    // Limpar seleção anterior e resumo
    window.origemDistribuicaoSelecionada = null;
    window.disponivelOrigemDistribuicao = 0;
    updateResumoDistribuicao();
    renderSetoresDistribuicao([]);
    const cont = document.getElementById('distribuicaoDisponibilidade');
    if (!produtoId) {
        if (cont) cont.innerHTML = '<div class="text-muted">Selecione um produto para visualizar a disponibilidade por local.</div>';
        return;
    }
    // Buscar estoque do produto e renderizar tabela
    fetchJson(`/api/produtos/${produtoId}/estoque`)
        .then(data => {
            try {
                renderDisponibilidadeProduto(data.estoques || []);
            } catch (e) { console.warn('Falha ao renderizar disponibilidade:', e); }
        })
        .catch(error => {
            console.error('Erro ao carregar estoque do produto:', error);
            if (cont) cont.innerHTML = '<div class="text-danger">Erro ao carregar estoque</div>';
        });
}

// Carregar locais onde o produto está disponível
function carregarLocaisProduto() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const tipoOrigemSelect = document.getElementById('tipoOrigemTransferencia');
    const localOrigemSelect = document.getElementById('localOrigemTransferencia');
    
    // Limpar seleções anteriores
    tipoOrigemSelect.value = '';
    localOrigemSelect.innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
    
    if (!produtoId) {
        return;
    }
    
    // Buscar estoque do produto
    fetchJson(`/api/produtos/${produtoId}/estoque`)
        .then(data => {
            if (data.estoques && data.estoques.length > 0) {
                // Agrupar por tipo de local (normalizando nomes)
                const locaisPorTipo = {};
                const normalizeTipo = (t) => String(t || '').toLowerCase().replace(/[-]/g, '_').replace(/^subalmoxarifado$/, 'sub_almoxarifado');
                data.estoques.forEach(estoque => {
                    // Para transferência, setor não pode ser origem: ignorar estoques em setores
                    const tipoNorm = normalizeTipo(estoque.tipo);
                    if (estoque.quantidade_disponivel > 0 && tipoNorm !== 'setor') {
                        if (!locaisPorTipo[tipoNorm]) {
                            locaisPorTipo[tipoNorm] = [];
                        }
                        locaisPorTipo[tipoNorm].push({
                            id: estoque.local_id,
                            nome: estoque.nome_local,
                            quantidade: estoque.quantidade_disponivel
                        });
                    }
                });
                
                // Se há apenas um tipo de local, selecionar automaticamente
                const tiposDisponiveis = Object.keys(locaisPorTipo);
                if (tiposDisponiveis.length === 1) {
                    const tipoUnico = tiposDisponiveis[0];
                    tipoOrigemSelect.value = tipoUnico;
                    
                    // Carregar locais deste tipo
                    const locais = locaisPorTipo[tipoUnico];
                    const options = locais.map(local => 
                        `<option value="${local.id}">${local.nome} (Disponível: ${local.quantidade})</option>`
                    ).join('');
                    
                    localOrigemSelect.innerHTML = '<option value="">Selecione...</option>' + options;
                    
                    // Se há apenas um local, selecionar automaticamente
                    if (locais.length === 1) {
                        localOrigemSelect.value = locais[0].id;
                    }
                } else if (tiposDisponiveis.length > 1) {
                    // Mostrar mensagem informativa
                    localOrigemSelect.innerHTML = '<option value="">Produto disponível em múltiplos tipos de local - selecione o tipo primeiro</option>';
                } else {
                    localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível</option>';
                }
            } else {
                localOrigemSelect.innerHTML = '<option value="">Produto sem estoque disponível</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar estoque:', error);
            localOrigemSelect.innerHTML = '<option value="">Erro ao carregar estoque</option>';
        });
}

// Executar transferência
function executarTransferencia() {
    const produtoId = document.getElementById('produtoTransferencia').value;
    const quantidade = document.getElementById('quantidadeTransferencia').value;
    const tipoOrigem = document.getElementById('tipoOrigemTransferencia').value;
    const localOrigem = document.getElementById('localOrigemTransferencia').value;
    const tipoDestino = document.getElementById('tipoDestinoTransferencia').value;
    const localDestino = document.getElementById('localDestinoTransferencia').value;
    const motivo = document.getElementById('motivoTransferencia').value;
    const observacoes = document.getElementById('observacoesTransferencia').value;
    const msgEl = document.getElementById('transferenciaMsg');
    if (msgEl) { msgEl.classList.add('d-none'); msgEl.textContent = ''; }
    
    // Validações básicas
    if (!produtoId || !quantidade || !tipoOrigem || !localOrigem || !tipoDestino || !localDestino) {
        if (msgEl) {
            msgEl.textContent = 'Preencha todos os campos obrigatórios.';
            msgEl.classList.remove('d-none');
            msgEl.classList.remove('alert-danger');
            msgEl.classList.add('alert-warning');
        } else {
            alert('Preencha todos os campos obrigatórios.');
        }
        return;
    }
    
    if (USE_MONGO) {
        // Em Mongo, IDs são strings
        if (!localOrigem || typeof localOrigem !== 'string') {
            if (msgEl) {
                msgEl.textContent = 'Por favor, selecione um local de origem válido.';
                msgEl.classList.remove('d-none');
                msgEl.classList.remove('alert-danger');
                msgEl.classList.add('alert-warning');
            } else {
                alert('Por favor, selecione um local de origem válido.');
            }
            return;
        }
        if (!localDestino || typeof localDestino !== 'string') {
            if (msgEl) {
                msgEl.textContent = 'Por favor, selecione um local de destino válido.';
                msgEl.classList.remove('d-none');
                msgEl.classList.remove('alert-danger');
                msgEl.classList.add('alert-warning');
            } else {
                alert('Por favor, selecione um local de destino válido.');
            }
            return;
        }
    } else {
        // SQL: validar IDs numéricos
        if (!localOrigem || localOrigem === '' || localOrigem === 'undefined' || localOrigem === undefined || localOrigem === null || isNaN(parseInt(localOrigem)) || parseInt(localOrigem) <= 0) {
            if (msgEl) {
                msgEl.textContent = 'Por favor, selecione um local de origem válido.';
                msgEl.classList.remove('d-none');
                msgEl.classList.remove('alert-danger');
                msgEl.classList.add('alert-warning');
            } else {
                alert('Por favor, selecione um local de origem válido.');
            }
            return;
        }
        if (!localDestino || localDestino === '' || localDestino === 'undefined' || localDestino === undefined || localDestino === null || isNaN(parseInt(localDestino)) || parseInt(localDestino) <= 0) {
            if (msgEl) {
                msgEl.textContent = 'Por favor, selecione um local de destino válido.';
                msgEl.classList.remove('d-none');
                msgEl.classList.remove('alert-danger');
                msgEl.classList.add('alert-warning');
            } else {
                alert('Por favor, selecione um local de destino válido.');
            }
            return;
        }
    }
    
    if (parseFloat(quantidade) <= 0) {
        if (msgEl) {
            msgEl.textContent = 'Quantidade deve ser maior que zero.';
            msgEl.classList.remove('d-none');
            msgEl.classList.remove('alert-danger');
            msgEl.classList.add('alert-warning');
        } else {
            alert('Quantidade deve ser maior que zero.');
        }
        return;
    }
    
    // Preparar IDs conforme modo
    const origemId = USE_MONGO ? String(localOrigem) : parseInt(localOrigem);
    const destinoId = USE_MONGO ? String(localDestino) : parseInt(localDestino);
    const produtoIdPayload = USE_MONGO ? String(produtoId) : parseInt(produtoId);
    
    // Validar se origem e destino são diferentes
    if (tipoOrigem === tipoDestino && origemId === destinoId) {
        if (msgEl) {
            msgEl.textContent = 'Origem e destino não podem ser o mesmo local. Selecione um destino diferente.';
            msgEl.classList.remove('d-none');
            msgEl.classList.remove('alert-danger');
            msgEl.classList.add('alert-warning');
        } else {
            alert('Origem e destino não podem ser o mesmo local. Selecione um destino diferente.');
        }
        return;
    }

    // Validar se origem e destino pertencem à mesma central
    const idEq = (a, b) => String(a) === String(b);
    const getCentralIdByLocal = (tipo, id) => {
        if (tipo === 'almoxarifado') {
            const a = (locaisData.almoxarifados || []).find(x => idEq(x.id, id));
            return a ? String(a.central_id) : null;
        } else if (tipo === 'sub_almoxarifado') {
            const sub = (locaisData.sub_almoxarifados || []).find(x => idEq(x.id, id));
            if (!sub) return null;
            const alm = (locaisData.almoxarifados || []).find(x => idEq(x.id, sub.almoxarifado_id));
            return alm ? String(alm.central_id) : null;
        } else if (tipo === 'setor') {
            const set = (locaisData.setores || []).find(x => idEq(x.id, id));
            if (!set) return null;
            const sub = (locaisData.sub_almoxarifados || []).find(x => idEq(x.id, set.sub_almoxarifado_id));
            if (!sub) return null;
            const alm = (locaisData.almoxarifados || []).find(x => idEq(x.id, sub.almoxarifado_id));
            return alm ? String(alm.central_id) : null;
        }
        return null;
    };

    const centralOrigem = getCentralIdByLocal(tipoOrigem, origemId);
    const centralDestino = getCentralIdByLocal(tipoDestino, destinoId);
    if (centralOrigem && centralDestino && centralOrigem !== centralDestino) {
        if (msgEl) {
            msgEl.textContent = 'Não é possível transferir entre locais de centrais diferentes.';
            msgEl.classList.remove('d-none');
            msgEl.classList.remove('alert-danger');
            msgEl.classList.add('alert-warning');
        } else {
            alert('Não é possível transferir entre locais de centrais diferentes.');
        }
        return;
    }

    const dadosTransferencia = {
        produto_id: produtoIdPayload,
        quantidade: parseFloat(quantidade),
        motivo: motivo || null,
        observacoes: observacoes || null,
        origem: {
            tipo: tipoOrigem,
            id: origemId
        },
        destino: {
            tipo: tipoDestino,
            id: destinoId
        }
    };

    // Enviar para API
    fetchJson('/api/movimentacoes/transferencia', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dadosTransferencia)
    })
    .then(result => {
        if (msgEl) { msgEl.classList.add('d-none'); msgEl.textContent = ''; }
        alert('Transferência executada com sucesso!');
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('novaTransferenciaModal'));
        modal.hide();
        
        // Limpar formulário
        document.getElementById('transferenciaForm').reset();
        
        // Recarregar lista
        carregarMovimentacoes(currentPage);
    })
    .catch(error => {
        console.error('Erro:', error);
        if (msgEl) {
            msgEl.textContent = 'Erro ao executar transferência: ' + (error && error.message ? error.message : String(error));
            msgEl.classList.remove('d-none');
            msgEl.classList.remove('alert-warning');
            msgEl.classList.add('alert-danger');
        } else {
            alert('Erro ao executar transferência: ' + error.message);
        }
    });
}

// Executar distribuição
function executarDistribuicao() {
    const produtoId = document.getElementById('produtoDistribuicao').value;
    const origemSel = window.origemDistribuicaoSelecionada || null;
    const tipoOrigem = origemSel?.tipo;
    const localOrigem = origemSel?.id;
    const motivo = document.getElementById('motivoDistribuicao').value;
    const observacoes = document.getElementById('observacoesDistribuicao').value;
    const msgElDist = document.getElementById('distribuicaoMsg');
    if (msgElDist) { msgElDist.classList.add('d-none'); msgElDist.textContent = ''; }
    
    // Coletar setores selecionados e quantidades
    const destinos = [];
    document.querySelectorAll('#setoresDistribuicao .setor-check').forEach(chk => {
        if (chk.checked) {
            const inp = document.querySelector(`#setoresDistribuicao .setor-qty[data-setor-id="${chk.value}"]`);
            const q = parseFloat(inp?.value || 0) || 0;
            if (q > 0) {
                destinos.push({ id: (USE_MONGO ? String(chk.value) : parseInt(chk.value)), quantidade: q });
            }
        }
    });
    
    // Validações
    if (!produtoId || !tipoOrigem || !localOrigem) {
        if (msgElDist) {
            msgElDist.textContent = 'Selecione o produto e um local de origem na tabela.';
            msgElDist.classList.remove('d-none');
            msgElDist.classList.remove('alert-danger');
            msgElDist.classList.add('alert-warning');
        } else {
            alert('Selecione o produto e um local de origem na tabela.');
        }
        return;
    }
    
    if (destinos.length === 0) {
        if (msgElDist) {
            msgElDist.textContent = 'Selecione um setor de destino.';
            msgElDist.classList.remove('d-none');
            msgElDist.classList.remove('alert-danger');
            msgElDist.classList.add('alert-warning');
        } else {
            alert('Selecione um setor de destino.');
        }
        return;
    }
    
    // Validar soma das quantidades dos destinos
    const somaDestinos = destinos.reduce((acc, d) => acc + (parseFloat(d.quantidade) || 0), 0);
    const disp = typeof window.disponivelOrigemDistribuicao === 'number' ? window.disponivelOrigemDistribuicao : 0;
    if (somaDestinos <= 0) {
        if (msgElDist) {
            msgElDist.textContent = 'Informe quantidades para os setores selecionados.';
            msgElDist.classList.remove('d-none');
            msgElDist.classList.remove('alert-danger');
            msgElDist.classList.add('alert-warning');
        } else {
            alert('Informe quantidades para os setores selecionados.');
        }
        return;
    }
    if (somaDestinos > disp) {
        if (msgElDist) {
            msgElDist.textContent = 'Quantidade alocada excede o disponível na origem.';
            msgElDist.classList.remove('d-none');
            msgElDist.classList.remove('alert-warning');
            msgElDist.classList.add('alert-danger');
        } else {
            alert('Quantidade alocada excede o disponível na origem.');
        }
        return;
    }
    
    const dadosDistribuicao = {
        produto_id: USE_MONGO ? String(produtoId) : parseInt(produtoId),
        motivo: motivo,
        observacoes: observacoes,
        origem: {
            tipo: tipoOrigem,
            id: USE_MONGO ? String(localOrigem) : parseInt(localOrigem)
        },
        destinos: destinos
    };
    
    // Enviar para API
    fetchJson('/api/movimentacoes/distribuicao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(dadosDistribuicao)
    })
    .then(result => {
        if (msgElDist) { msgElDist.classList.add('d-none'); msgElDist.textContent = ''; }
        alert(`Saída executada com sucesso! ${result.movimentacoes_criadas} movimentações criadas.`);
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('distribuicaoModal'));
        modal.hide();
        
        // Limpar formulário
        document.getElementById('distribuicaoForm').reset();
        document.querySelectorAll('#setoresDistribuicao .setor-check').forEach(chk => { chk.checked = false; });
        document.querySelectorAll('#setoresDistribuicao .setor-qty').forEach(inp => { inp.value = ''; inp.disabled = true; });
        window.disponivelOrigemDistribuicao = 0;
        updateResumoDistribuicao();
        
        // Recarregar lista
        carregarMovimentacoes(currentPage);
    })
    .catch(error => {
        console.error('Erro:', error);
        if (msgElDist) {
            msgElDist.textContent = 'Erro ao executar saída: ' + (error && error.message ? error.message : String(error));
            msgElDist.classList.remove('d-none');
            msgElDist.classList.remove('alert-warning');
            msgElDist.classList.add('alert-danger');
        } else {
            alert('Erro ao executar saída: ' + error.message);
        }
    });
}

// Validação reativa: mostrar/ocultar alerta quando Origem/Destino forem iguais
function atualizarMensagemTransferencia() {
    const tipoOrigem = document.getElementById('tipoOrigemTransferencia').value;
    const localOrigem = document.getElementById('localOrigemTransferencia').value;
    const tipoDestino = document.getElementById('tipoDestinoTransferencia').value;
    const localDestino = document.getElementById('localDestinoTransferencia').value;
    const msgEl = document.getElementById('transferenciaMsg');
    if (!msgEl) return;
    // Se campos ainda não preenchidos, esconder alerta
    if (!tipoOrigem || !localOrigem || !tipoDestino || !localDestino) {
        msgEl.classList.add('d-none');
        msgEl.textContent = '';
        return;
    }
    const origemId = USE_MONGO ? String(localOrigem) : parseInt(localOrigem);
    const destinoId = USE_MONGO ? String(localDestino) : parseInt(localDestino);
    if (tipoOrigem === tipoDestino && origemId === destinoId) {
        msgEl.textContent = 'Origem e destino não podem ser o mesmo local. Selecione um destino diferente.';
        msgEl.classList.remove('d-none');
        msgEl.classList.remove('alert-danger');
        msgEl.classList.add('alert-warning');
    } else {
        msgEl.classList.add('d-none');
        msgEl.textContent = '';
    }
}

// Event listeners
document.getElementById('filtroProduto').addEventListener('input', 
    debounce(() => filtrarMovimentacoes(), 500)
);

// Listeners de busca nos selects de produtos
const inputBuscaTransf = document.getElementById('buscaProdutoTransferencia');
if (inputBuscaTransf) {
    inputBuscaTransf.addEventListener('input', debounce(() => {
        carregarProdutos(inputBuscaTransf.value);
    }, 400));
}
const inputBuscaDist = document.getElementById('buscaProdutoDistribuicao');
if (inputBuscaDist) {
    inputBuscaDist.addEventListener('input', debounce(() => {
        carregarProdutos(inputBuscaDist.value);
    }, 400));
}

// Função debounce
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Carregar dados iniciais
document.addEventListener('DOMContentLoaded', () => {
    atualizarBotaoOrdenacao();
    carregarMovimentacoes(1);
    carregarProdutos();
    // Limpa a lista de setores inicialmente
    renderSetoresDistribuicao([]);
    // Seleção de origem agora é feita via tabela de disponibilidade; listeners de selects removidos.
    // Conectar validação reativa na modal de transferência
    const tipoOrigemTransf = document.getElementById('tipoOrigemTransferencia');
    const localOrigemTransf = document.getElementById('localOrigemTransferencia');
    const tipoDestinoTransf = document.getElementById('tipoDestinoTransferencia');
    const localDestinoTransf = document.getElementById('localDestinoTransferencia');
    [tipoOrigemTransf, localOrigemTransf, tipoDestinoTransf, localDestinoTransf].forEach(el => {
        if (el) {
            el.addEventListener('change', atualizarMensagemTransferencia);
        }
    });
    const modalTransf = document.getElementById('novaTransferenciaModal');
    if (modalTransf) {
        modalTransf.addEventListener('shown.bs.modal', atualizarMensagemTransferencia);
    }
});
</script>
{% endblock %}