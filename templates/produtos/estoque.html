{% extends "base.html" %}

{% block title %}PluckLog - Estoque por Hierarquia{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-sitemap"></i> Estoque por Hierarquia</h2>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <a href="{{ url_for('main.produtos') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>

            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="filtroProduto" class="form-label">Produto</label>
                                    <input type="text" class="form-control" id="filtroProduto" 
                                           placeholder="Buscar por código ou nome...">
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroTipo" class="form-label">Tipo de Local</label>
                                    <select class="form-select" id="filtroTipo">
                                        <option value="">Todos</option>
                                        <option value="central">Central</option>
                                        <option value="almoxarifado">Almoxarifado</option>
                                        <option value="subalmoxarifado">Sub-almoxarifado</option>
                                        <option value="setor">Setor</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroStatus" class="form-label">Status</label>
                                    <select class="form-select" id="filtroStatus">
                                        <option value="">Todos</option>
                                        <option value="disponivel">Disponível</option>
                                        <option value="baixo">Estoque Baixo</option>
                                        <option value="zerado">Zerado</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroLocal" class="form-label">Local</label>
                                    <select class="form-select" id="filtroLocal">
                                        <option value="">Todos os locais</option>
                                        <!-- Será preenchido dinamicamente -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                                            <i class="fas fa-filter"></i> Filtrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumo Geral -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 id="totalProdutos">-</h3>
                            <p class="mb-0">Produtos Diferentes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 id="totalLocais">-</h3>
                            <p class="mb-0">Locais com Estoque</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3 id="estoquesBaixos">-</h3>
                            <p class="mb-0">Estoques Baixos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h3 id="estoquesZerados">-</h3>
                            <p class="mb-0">Estoques Zerados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Estoque -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-table"></i> Estoque Detalhado</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-success" onclick="exportarExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="loadingFeedback" class="alert alert-info text-center" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando dados de estoque, aguarde...
                            </div>
                            <div id="tabelaEstoque"></div>
                            <nav id="navPaginationEstoque" aria-label="Paginação do estoque" style="display: none;">
                                <ul id="paginationEstoque" class="pagination justify-content-center mt-3"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Detalhes do Estoque
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalhesConteudo">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="verProdutoBtn">
                    <i class="fas fa-eye"></i> Ver Produto
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo para destacar quantidades por hierarquia */
.hier-qty { font-weight: 700; font-size: 1.1rem; }
.hier-line { line-height: 1.2; margin-bottom: 2px; }
.disp-qty { font-weight: 700; font-size: 1.3rem; }
</style>

<script>
let dadosEstoque = [];
let dadosFiltrados = [];
let itemsPerPage = 0;
let currentPage = 1;
let isLoading = false;
let locaisCache = null;
let locaisFetching = false;
let pendingReload = false;

// Formata quantidade como inteiro e anexa unidade de medida
function formatQuantidade(valor, unidade) {
    const v = parseFloat(valor || 0);
    const u = unidade ? ` ${unidade}` : '';
    return `${Number.isFinite(v) ? v.toFixed(0) : '0'}${u}`;
}

// Carregar dados com paginação
function carregarDados(page = 1) {
    if (isLoading) { pendingReload = true; return; }
    currentPage = page;
    isLoading = true;
    const lf = document.getElementById('loadingFeedback');
    if (lf) lf.style.display = '';
    const params = new URLSearchParams({
        page: 1,
        per_page: itemsPerPage,
        no_pagination: 1,
        produto: document.getElementById('filtroProduto').value,
        tipo: document.getElementById('filtroTipo').value,
        status: document.getElementById('filtroStatus').value,
        local: document.getElementById('filtroLocal').value
    });

    fetchJson(`/api/estoque/hierarquia?${params.toString()}`, { headers: { 'Accept': 'application/json' } })
    .then(resp => {
        const estoque = Array.isArray(resp.items) ? resp.items : (Array.isArray(resp) ? resp : []);
        const pagination = resp.pagination || { page: currentPage, pages: 1 };
        dadosEstoque = estoque;
        dadosFiltrados = [...dadosEstoque];
        preencherFiltroLocais(locaisCache || []);
        atualizarResumo();
        renderizarTabela();
        renderizarPaginacao(pagination);
        prefetchLocais();
        if (lf) lf.style.display = 'none';
    })
    .catch(error => {
        try {
            const det = String((error && (error.payload && error.payload.detail)) || error).toLowerCase();
            if (error && (error.aborted || error.status === 0 || det.includes('abort'))) {
                if (lf) lf.style.display = 'none';
                return;
            }
        } catch (_) {}
        console.error('Erro ao carregar dados:', error);
        if (lf) lf.style.display = 'none';
        document.getElementById('tabelaEstoque').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados do estoque
            </div>
        `;
        document.getElementById('paginationEstoque').innerHTML = '';
    })
    .finally(() => {
        isLoading = false;
        if (pendingReload) { pendingReload = false; carregarDados(currentPage); }
    });
}

function prefetchLocais() {
    if (locaisCache || locaisFetching) return;
    locaisFetching = true;
    fetchJson('/api/hierarquia/locais', { headers: { 'Accept': 'application/json' } })
        .then(locais => { locaisCache = locais; preencherFiltroLocais(locaisCache || []); })
        .catch(() => {})
        .finally(() => { locaisFetching = false; });
}

// Preencher filtro de locais
function preencherFiltroLocais(locais) {
    const select = document.getElementById('filtroLocal');
    select.innerHTML = '<option value="">Todos os locais</option>';
    
    // Agrupar por tipo
    const grupos = {
        central: [],
        almoxarifado: [],
        subalmoxarifado: [],
        setor: []
    };
    
    locais.forEach(local => {
        if (grupos[local.tipo]) {
            grupos[local.tipo].push(local);
        }
    });
    
    // Adicionar opções agrupadas
    Object.keys(grupos).forEach(tipo => {
        if (grupos[tipo].length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = tipo.charAt(0).toUpperCase() + tipo.slice(1);
            
            grupos[tipo].forEach(local => {
                const option = document.createElement('option');
                option.value = local.id;
                option.textContent = local.nome;
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
    });
}

// Aplicar filtros
function aplicarFiltros() {
    // Com paginação server-side: refaz a consulta no servidor
    carregarDados(1);
}

// Atualizar resumo
function atualizarResumo() {
    const produtosUnicos = new Set(dadosFiltrados.map(item => item.produto_id)).size;
    const locaisUnicos = new Set(dadosFiltrados.map(item => item.local_id)).size;
    
    let estoquesBaixos = 0;
    let estoquesZerados = 0;
    
    dadosFiltrados.forEach(item => {
        const quantidade = parseFloat(item.quantidade_disponivel || 0);
        const inicial = parseFloat(item.quantidade_inicial || 0);
        
        if (quantidade <= 0) {
            estoquesZerados++;
        } else if (quantidade <= Math.max(inicial * 0.1, 5)) {
            estoquesBaixos++;
        }
    });
    
    document.getElementById('totalProdutos').textContent = produtosUnicos;
    document.getElementById('totalLocais').textContent = locaisUnicos;
    document.getElementById('estoquesBaixos').textContent = estoquesBaixos;
    document.getElementById('estoquesZerados').textContent = estoquesZerados;
}

// Renderizar tabela
function renderizarTabela() {
    const container = document.getElementById('tabelaEstoque');
    
    if (dadosFiltrados.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> Nenhum item encontrado com os filtros aplicados
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Totais por Hierarquia</th>
                        <th>Disponível</th>
                        <th>Status</th>
                        <th>Última Atualização</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Agregar totais por produto e hierarquia (com base nos dados carregados)
    const totaisPorProduto = {};
    (dadosEstoque || []).forEach(it => {
        const pid = it.produto_id;
        const tipo = String(it.local_tipo || '').toLowerCase();
        const qtd = parseFloat(it.quantidade || 0);
        if (!totaisPorProduto[pid]) {
            totaisPorProduto[pid] = { alm: 0, sub: 0, set: 0, cen: 0 };
        }
        const agg = totaisPorProduto[pid];
        if (tipo === 'almoxarifado') agg.alm += qtd;
        else if (tipo === 'subalmoxarifado') agg.sub += qtd;
        else if (tipo === 'setor') agg.set += qtd;
        else if (tipo === 'central') agg.cen += qtd;
    });

    // Agregar linhas por produto a partir do dataset filtrado
    const produtosMapa = {};
    (dadosFiltrados || []).forEach(item => {
        const pid = item.produto_id;
        if (!pid) return;
        const tipo = String(item.local_tipo || '').toLowerCase();
        const qtd = parseFloat(item.quantidade || 0);
        const disponivel = parseFloat(item.quantidade_disponivel || 0);
        const inicial = parseFloat(item.quantidade_inicial || 0);
        const dt = item.data_atualizacao ? new Date(item.data_atualizacao) : null;

        if (!produtosMapa[pid]) {
            produtosMapa[pid] = {
                produto_id: pid,
                produto_nome: item.produto_nome,
                produto_codigo: item.produto_codigo,
                unidade_medida: item.unidade_medida || '',
                totais: { alm: 0, sub: 0, set: 0, cen: 0 },
                disponivel: 0,
                inicial: 0,
                ultima: null
            };
        }
        const p = produtosMapa[pid];
        if (tipo === 'almoxarifado') p.totais.alm += qtd;
        else if (tipo === 'subalmoxarifado') p.totais.sub += qtd;
        else if (tipo === 'setor') p.totais.set += qtd;
        else if (tipo === 'central') p.totais.cen += qtd;
        else p.totais.alm += qtd; // fallback
        p.disponivel += disponivel;
        p.inicial += inicial;
        if (dt && (!p.ultima || dt > p.ultima)) p.ultima = dt;
    });

    Object.values(produtosMapa).forEach(p => {
        let statusBadge = '<span class="badge bg-success">Normal</span>';
        if (p.disponivel <= 0) {
            statusBadge = '<span class="badge bg-danger">Zerado</span>';
        } else if (p.disponivel <= Math.max(p.inicial * 0.1, 5)) {
            statusBadge = '<span class="badge bg-warning">Baixo</span>';
        }

        const u = p.unidade_medida || '';
        const linhasHierarquia = [];
        // Central (rede) no topo: cen + alm + sub (exclui setor)
        const centralRede = (p.totais.cen || 0) + (p.totais.alm || 0) + (p.totais.sub || 0);
        if (centralRede > 0) linhasHierarquia.push(`<div class="hier-line"><span class="badge bg-warning text-dark me-2">cen</span><span class="hier-qty">${formatQuantidade(centralRede, u)}</span></div>`);
        if (p.totais.alm > 0) linhasHierarquia.push(`<div class="hier-line"><span class="badge bg-primary me-2">alm</span><span class="hier-qty">${formatQuantidade(p.totais.alm, u)}</span></div>`);
        if (p.totais.sub > 0) linhasHierarquia.push(`<div class="hier-line"><span class="badge bg-info text-dark me-2">sub</span><span class="hier-qty">${formatQuantidade(p.totais.sub, u)}</span></div>`);
        if (p.totais.set > 0) linhasHierarquia.push(`<div class="hier-line"><span class="badge bg-success me-2">set</span><span class="hier-qty">${formatQuantidade(p.totais.set, u)}</span></div>`);
        if (!linhasHierarquia.length) linhasHierarquia.push('<div class="text-muted">-</div>');

        html += `
            <tr>
                <td>
                    <div>
                        <strong>${p.produto_nome}</strong><br>
                        <small class="text-muted">Código: ${p.produto_codigo}</small>
                    </div>
                </td>
                <td>
                    <div class="d-flex flex-column" style="line-height: 1.1;">
                        ${linhasHierarquia.join('')}
                    </div>
                </td>
                <td class="text-success"><span class="disp-qty"><strong>${formatQuantidade(p.disponivel, u)}</strong></span></td>
                <td>${statusBadge}</td>
                <td class="text-muted">${p.ultima ? p.ultima.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${p.produto_id}')" title="Detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a class="btn btn-sm btn-outline-success ms-1" href="/produtos/${p.produto_id}/recebimento" title="Receber">
                        <i class="fas fa-plus-circle"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Ver detalhes
function verDetalhes(produtoId) {
    Promise.all([
        fetchJson(`/api/produtos/${produtoId}`, { headers: { 'Accept': 'application/json' } }),
        fetchJson(`/api/produtos/${produtoId}/lotes`, { headers: { 'Accept': 'application/json' } }),
        fetchJson(`/api/produtos/${produtoId}/movimentacoes?limit=10`, { headers: { 'Accept': 'application/json' } })
    ])
    .then(([produto, lotes, movimentacoes]) => {
        let html = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6><i class="fas fa-box"></i> Produto</h6>
                    <p><strong>${produto.nome}</strong><br>
                    <small>Código: ${produto.codigo} | Unidade: ${produto.unidade_medida}</small></p>
                </div>
                
            </div>
        `;
        
        // Lotes
        if (lotes.length > 0) {
            html += `
                <h6><i class="fas fa-calendar-alt"></i> Lotes</h6>
                <div class="table-responsive mb-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Lote</th>
                                <th>Quantidade</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            lotes.forEach(lote => {
                const hoje = new Date();
                const vencimento = new Date(lote.data_vencimento);
                const diasVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                
                let statusBadge = '<span class="badge bg-success">Válido</span>';
                if (diasVencimento < 0) {
                    statusBadge = '<span class="badge bg-danger">Vencido</span>';
                } else if (diasVencimento <= 30) {
                    statusBadge = '<span class="badge bg-warning">Próximo ao vencimento</span>';
                }
                
                html += `
                    <tr>
                        <td>${lote.lote || '-'}</td>
                        <td>${parseFloat(lote.quantidade_atual || 0).toFixed(2)}</td>
                        <td>${lote.data_vencimento ? new Date(lote.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        // Movimentações recentes
        if (movimentacoes.items && movimentacoes.items.length > 0) {
            html += `
                <h6><i class="fas fa-history"></i> Movimentações Recentes</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            movimentacoes.items.slice(0, 5).forEach(mov => {
        const tipoIcon = {
            'entrada': 'fas fa-arrow-down text-success',
            'saida': 'fas fa-arrow-up text-danger',
            'transferencia': 'fas fa-exchange-alt text-primary',
            'distribuicao': 'fas fa-share-alt text-info',
            'distribuição': 'fas fa-share-alt text-info'
        };
                
                html += `
                    <tr>
                        <td>${new Date(mov.data_movimentacao).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <i class="${tipoIcon[mov.tipo_movimentacao?.toLowerCase()] || 'fas fa-question'}"></i>
                            ${mov.tipo_movimentacao}
                        </td>
                        <td>${parseFloat(mov.quantidade).toFixed(2)}</td>
                        <td class="text-muted">${mov.observacoes || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        document.getElementById('detalhesConteudo').innerHTML = html;
        document.getElementById('verProdutoBtn').onclick = () => {
            window.location.href = `/produtos/${produtoId}`;
        };
        
        const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar detalhes');
    });
}

// Atualizar dados
function atualizarDados() {
    document.getElementById('tabelaEstoque').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Atualizando...</span>
            </div>
        </div>
    `;
    
    carregarDados(currentPage);
}

// Renderizar paginação
function renderizarPaginacao(pagination) {
    const paginationEl = document.getElementById('paginationEstoque');
    const navEl = document.getElementById('navPaginationEstoque');
    if (!pagination || !pagination.pages || pagination.pages <= 1) {
        paginationEl.innerHTML = '';
        if (navEl) navEl.style.display = 'none';
        return;
    }

    let html = '';
    html += `
        <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="carregarDados(${Math.max(1, pagination.page - 1)})">Anterior</a>
        </li>
    `;

    for (let i = 1; i <= pagination.pages; i++) {
        if (i === pagination.page || i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
            html += `
                <li class="page-item ${i === pagination.page ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="carregarDados(${i})">${i}</a>
                </li>
            `;
        } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    html += `
        <li class="page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="carregarDados(${Math.min(pagination.pages, pagination.page + 1)})">Próxima</a>
        </li>
    `;
    paginationEl.innerHTML = html;
    if (navEl) navEl.style.display = '';
}

// Exportar para Excel
function exportarExcel() {
    const params = new URLSearchParams({
        produto: document.getElementById('filtroProduto').value,
        tipo: document.getElementById('filtroTipo').value,
        status: document.getElementById('filtroStatus').value,
        local: document.getElementById('filtroLocal').value
    });
    
    window.open(`/api/estoque/hierarquia/export?${params.toString()}`, '_blank');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    carregarDados(1);
    
    // Busca em tempo real
    let timeoutBusca = null;
    document.getElementById('filtroProduto').addEventListener('input', function() {
        clearTimeout(timeoutBusca);
        timeoutBusca = setTimeout(aplicarFiltros, 300);
    });
    
    // Filtros automáticos
    document.getElementById('filtroTipo').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroLocal').addEventListener('change', aplicarFiltros);
});
</script>
{% endblock %}
