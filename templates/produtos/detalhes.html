{% extends "base.html" %}

{% block title %}Detalhes do Produto - Almox SMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box"></i> Detalhes do Produto</h2>
                <div>
                    <a href="{{ url_for('main.produtos') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <button class="btn btn-primary" id="btnRecebimento">
                        <i class="fas fa-plus-circle"></i> Registrar Recebimento
                    </button>
                </div>
            </div>

            <!-- Informações do Produto -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações do Produto</h5>
                        </div>
                        <div class="card-body" id="produtoInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Resumo de Estoque</h5>
                        </div>
                        <div class="card-body" id="resumoEstoque">
                            <div class="text-center py-4">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estoque por Hierarquia -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-sitemap"></i> Estoque por Hierarquia</h5>
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select form-select-sm" id="filtroPeriodoEstoque" style="width: auto;">
                                    <option value="">Todos</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="dia">Dia</option>
                                    <option value="semana">Semana</option>
                                    <option value="mes">Mês</option>
                                </select>
                                <button class="btn btn-sm btn-outline-primary" onclick="atualizarEstoque()">
                                    <i class="fas fa-sync-alt"></i> Atualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="estoqueHierarquia" class="limited-section">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Carregando estoque...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lotes e Validades -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Lotes e Validades</h5>
                        </div>
                        <div class="card-body">
                            <div id="lotesValidades" class="limited-section">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Carregando lotes...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movimentações Recentes -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-history"></i> Movimentações Recentes</h5>
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select form-select-sm" id="filtroPeriodoMov" style="width: auto;">
                                    <option value="">Todos</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="dia">Dia</option>
                                    <option value="semana">Semana</option>
                                    <option value="mes">Mês</option>
                                </select>
                                <select class="form-select form-select-sm" id="filtroMovimentacao" style="width: auto;">
                                    <option value="">Todas</option>
                                    <option value="entrada">Entradas</option>
                                    <option value="saida">Saídas</option>
                                    <option value="transferencia">Transferências</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="movimentacoes" class="limited-section">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Carregando movimentações...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Recebimento -->
<div class="modal fade" id="recebimentoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Registrar Recebimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recebimentoForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="quantidade" class="form-label">Quantidade *</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="quantidade" name="quantidade" 
                                           min="0.01" step="0.01" required>
                                    <span class="input-group-text" id="unidadeMedidaRecebimento">UN</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="preco_unitario" class="form-label">Preço Unitário</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="preco_unitario" name="preco_unitario" 
                                           min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="almoxarifado_id" class="form-label">Almoxarifado *</label>
                                <select class="form-select" id="almoxarifado_id" name="almoxarifado_id" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="lote" class="form-label">Número do Lote</label>
                                <input type="text" class="form-control" id="lote" name="lote" placeholder="Ex: L2024001">
                                <div class="form-text">Identificação do lote do fornecedor</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fornecedor" class="form-label">Fornecedor</label>
                                <input type="text" class="form-control" id="fornecedor" name="fornecedor" placeholder="Nome do fornecedor">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_fabricacao" class="form-label">Data de Fabricação</label>
                                <input type="date" class="form-control" id="data_fabricacao" name="data_fabricacao">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_vencimento" class="form-label">Data de Vencimento</label>
                                <input type="date" class="form-control" id="data_vencimento" name="data_vencimento">
                                <div class="form-text" id="alertaVencimentoModal"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="nota_fiscal" class="form-label">Nota Fiscal</label>
                        <input type="text" class="form-control" id="nota_fiscal" name="nota_fiscal" placeholder="Número da nota fiscal">
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Informações adicionais sobre o recebimento..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Valor Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="valor_total" readonly>
                                </div>
                                <div class="form-text">Calculado automaticamente</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_recebimento" class="form-label">Data do Recebimento</label>
                                <input type="datetime-local" class="form-control" id="data_recebimento" name="data_recebimento">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarRecebimento">
                    <i class="fas fa-save"></i> Registrar Recebimento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let produtoId = null;
let produtoDetalhes = null;
let estoqueAbortController = null;
let estoquePromise = null;
let estoqueDadosCache = null;
let lotesExpandido = false;
const LOTES_LIMITE = 10;

// Extrair ID do produto da URL
function obterProdutoId() {
    const path = window.location.pathname;
    const after = path.split('/produtos/')[1] || '';
    const idSegment = (after.split('/')[0] || '').trim();
    if (!idSegment) return null;
    // ObjectId (24 hex chars)
    if (/^[a-fA-F0-9]{24}$/.test(idSegment)) return idSegment;
    // Numeric ID
    if (/^\d+$/.test(idSegment)) return parseInt(idSegment, 10);
    // Fallback to raw segment
    return idSegment;
}

// Carregar dados do produto
function carregarProduto() {
    produtoId = obterProdutoId();
    if (!produtoId) {
        alert('ID do produto não encontrado');
        return;
    }
    fetchJson(`/api/produtos/${produtoId}`)
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            produtoDetalhes = data;
            renderizarProduto(data);
        })
        .catch(error => {
            console.error('Erro ao carregar produto:', error);
            document.getElementById('produtoInfo').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar produto: ${error.message}
                </div>
            `;
        });
}

// Renderizar informações do produto
function renderizarProduto(produto) {
    const statusBadge = produto.ativo ? 
        '<span class="badge bg-success">Ativo</span>' : 
        '<span class="badge bg-danger">Inativo</span>';
    const criadoEm = produto.data_criacao ? new Date(produto.data_criacao).toLocaleDateString('pt-BR') : '-';
    
    document.getElementById('produtoInfo').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h4>${produto.nome} ${statusBadge}</h4>
                <p class="text-muted mb-3">${produto.descricao || 'Sem descrição'}</p>
                
                <div class="row">
                    <div class="col-6">
                        <strong>Código:</strong><br>
                        <span class="badge bg-primary">${produto.codigo}</span>
                    </div>
                    <div class="col-6">
                        <strong>Unidade:</strong><br>
                        ${produto.unidade_medida}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-6">
                        <strong>Categoria:</strong><br>
                        ${produto.categoria || 'Não informada'}
                    </div>
                    <div class="col-6">
                        <strong>Criado em:</strong><br>
                        ${criadoEm}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Carregar dados relacionados
    carregarResumoEstoque();
    carregarEstoqueHierarquia();
    carregarLotes();
    carregarMovimentacoes();
}

// Carregar resumo de estoque
function carregarResumoEstoque() {
    obterEstoqueDados()
        .then(data => {
            const unidade = (produtoDetalhes && produtoDetalhes.unidade_medida) || '';

            // Somar apenas estoques internos (central, almoxarifado e sub‑almoxarifado), excluindo setores
            const itens = Array.isArray(data.estoques) ? data.estoques : [];
            const tiposInternos = new Set(['central', 'almoxarifado', 'sub_almoxarifado', 'subalmoxarifado']);
            const totalInterno = itens
                .filter(it => tiposInternos.has(String(it.tipo)))
                .reduce((acc, it) => acc + parseFloat(it.quantidade_disponivel || 0), 0);

            document.getElementById('resumoEstoque').innerHTML = `
                <div class="text-center">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h3 class="text-primary">${formatQuantidade(totalInterno, unidade)}</h3>
                            <small class="text-muted">Total Disponível (Exclui Setores)</small>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Erro ao carregar resumo:', error);
            document.getElementById('resumoEstoque').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar resumo
                </div>
            `;
        });
}

// Carregar estoque por hierarquia
function carregarEstoqueHierarquia() {
    obterEstoqueDados()
        .then(data => {
            const estoques = data.estoques || [];
            if (estoques.length === 0) {
                document.getElementById('estoqueHierarquia').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Nenhum estoque encontrado para este produto
                    </div>
                `;
                return;
            }
            const periodo = document.getElementById('filtroPeriodoEstoque')?.value || '';
            let inicio = null;
            const agora = new Date();
            if (periodo === 'hoje') { inicio = new Date(); inicio.setHours(0,0,0,0); }
            else if (periodo === 'dia') { inicio = new Date(agora.getTime() - 24*60*60*1000); }
            else if (periodo === 'semana') { inicio = new Date(agora.getTime() - 7*24*60*60*1000); }
            else if (periodo === 'mes') { inicio = new Date(agora.getTime() - 30*24*60*60*1000); }

            const aplicados = inicio ? estoques.filter(it => {
                const dt = parseDateFlexible(it.data_atualizacao);
                return dt && dt >= inicio;
            }) : estoques;
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>Local</th>
                        <th>Tipo</th>
                        <th>Quantidade Total</th>
                        <th>Disponível</th>
                        <th>Última Atualização</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            aplicados.forEach(item => {
                const tipoIcon = {
                    'central': 'fas fa-building',
                    'almoxarifado': 'fas fa-warehouse',
                    'subalmoxarifado': 'fas fa-boxes',
                    'sub_almoxarifado': 'fas fa-boxes',
                    'setor': 'fas fa-users'
                };
                
                html += `
                    <tr>
                        <td>
                            <i class="${tipoIcon[item.tipo] || 'fas fa-box'}"></i>
                            ${item.nome_local}
                        </td>
                        <td>
                            <span class="badge bg-secondary">${item.tipo}</span>
                        </td>
                        <td><strong>${formatQuantidade(item.quantidade)}</strong></td>
                        <td class="text-success">${formatQuantidade(item.quantidade_disponivel)}</td>
                        <td class="text-muted">
                            ${item.data_atualizacao ? parseDateFlexible(item.data_atualizacao).toLocaleString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('estoqueHierarquia').innerHTML = html;
        })
        .catch(error => {
            console.error('Erro ao carregar estoque:', error);
            document.getElementById('estoqueHierarquia').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar estoque por hierarquia
                </div>
            `;
        });
}

// Carregar lotes
function carregarLotes() {
    const url = `/api/produtos/${produtoId}/lotes`;
    fetchJson(url)
        .then(data => {
            const lotes = data.items || [];
            if (lotes.length === 0) {
                document.getElementById('lotesValidades').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Nenhum lote encontrado para este produto
                    </div>
                `;
                return;
            }
            
    renderizarTabelaLotes(lotes);
        })
        .catch(error => {
            console.error('Erro ao carregar lotes:', error);
            document.getElementById('lotesValidades').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar lotes
                </div>
            `;
        });
}

// Carregar movimentações
function carregarMovimentacoes() {
    const filtro = document.getElementById('filtroMovimentacao').value;
    const periodoMov = document.getElementById('filtroPeriodoMov')?.value || '';
    let url = `/api/produtos/${produtoId}/movimentacoes?limit=20`;
    if (filtro) {
        url += `&tipo=${filtro}`;
    }
    if (periodoMov) {
        const agora = new Date();
        let inicio = null;
        if (periodoMov === 'hoje') { inicio = new Date(); inicio.setHours(0,0,0,0); }
        else if (periodoMov === 'dia') { inicio = new Date(agora.getTime() - 24*60*60*1000); }
        else if (periodoMov === 'semana') { inicio = new Date(agora.getTime() - 7*24*60*60*1000); }
        else if (periodoMov === 'mes') { inicio = new Date(agora.getTime() - 30*24*60*60*1000); }
        if (inicio) {
            url += `&data_inicio=${encodeURIComponent(inicio.toISOString())}`;
        }
    }
    fetchJson(url)
        .then(data => {
            if (!data.items || data.items.length === 0) {
                document.getElementById('movimentacoes').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Nenhuma movimentação encontrada
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Quantidade</th>
                        <th>Local</th>
                        <th>Usuário</th>
                        <th>Observações</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            data.items.forEach(mov => {
    const tipoIcon = {
        'entrada': 'fas fa-arrow-down text-success',
        'saida': 'fas fa-arrow-up text-danger',
        'transferencia': 'fas fa-exchange-alt text-primary',
        'distribuicao': 'fas fa-share-alt text-info',
        'distribuição': 'fas fa-share-alt text-info'
    };
                
                html += `
                    <tr>
                        <td>
                            <div>${new Date(mov.data_movimentacao).toLocaleDateString('pt-BR')}</div>
                            <small class="text-muted">${new Date(mov.data_movimentacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</small>
                        </td>
                        <td>
                            <i class="${tipoIcon[mov.tipo_movimentacao?.toLowerCase()] || 'fas fa-question'}"></i>
                            ${mov.tipo_movimentacao}
                        </td>
                        <td><strong>${formatQuantidade(mov.quantidade)}</strong></td>
                        <td>${mov.local || '-'}</td>
                        <td class="text-muted">${mov.usuario_responsavel || '-'}</td>
                        <td class="text-muted">${mov.observacoes || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('movimentacoes').innerHTML = html;
        })
        .catch(error => {
            console.error('Erro ao carregar movimentações:', error);
            document.getElementById('movimentacoes').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar movimentações
                </div>
            `;
        });
}

// Atualizar estoque
function atualizarEstoque() {
    obterEstoqueDados(true)
        .then(() => {
            carregarResumoEstoque();
            carregarEstoqueHierarquia();
        })
        .catch(err => { if (err && err.name === 'AbortError') return; });
    carregarLotes();
}

// Função para carregar almoxarifados no modal de recebimento
// Botão de recebimento
document.getElementById('btnRecebimento').addEventListener('click', function() {
    carregarAlmoxarifadosDetalhes();
    // Preencher unidade de medida no campo de quantidade
    const unidadeSpan = document.getElementById('unidadeMedidaRecebimento');
    if (unidadeSpan) {
        unidadeSpan.textContent = (produtoDetalhes && produtoDetalhes.unidade_medida) ? produtoDetalhes.unidade_medida : 'UN';
    }
    // Definir data do recebimento para agora
    const agora = new Date();
    agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
    const dataRecInput = document.getElementById('data_recebimento');
    if (dataRecInput) {
        dataRecInput.value = agora.toISOString().slice(0, 16);
    }
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('recebimentoModal'));
    modal.show();
    // Focar na quantidade
    const qtdInput = document.getElementById('quantidade');
    if (qtdInput) qtdInput.focus();
});

// Função para carregar almoxarifados no modal de recebimento
function carregarAlmoxarifadosDetalhes() {
    const select = document.getElementById('almoxarifado_id');
    if (!produtoId) {
        select.innerHTML = '<option value="Produto não identificado">Produto não identificado</option>';
        select.disabled = true;
        return;
    }
    select.innerHTML = '<option value="">Carregando...</option>';
    select.disabled = true;
    fetchJson(`/api/produtos/${produtoId}/almoxarifados`)
        .then(res => {
            const lista = res.almoxarifados || [];
            if (lista.length === 0) {
                select.innerHTML = '<option value="">Nenhum almoxarifado disponível</option>';
            } else {
                const options = ['<option value="">Selecione...</option>'];
                lista.forEach(a => {
                    const qtd = (a.quantidade_atual && a.quantidade_atual > 0) ? ` - ${formatQuantidade(a.quantidade_atual)}` : '';
                    options.push(`<option value="${a.id}">${a.nome}${qtd}</option>`);
                });
                select.innerHTML = options.join('');
            }
            select.disabled = false;
        })
        .catch(err => {
            console.error('Erro ao carregar almoxarifados:', err);
            select.innerHTML = '<option value="">Erro ao carregar almoxarifados</option>';
            select.disabled = false;
        });
}

// Filtro de movimentações
document.getElementById('filtroMovimentacao').addEventListener('change', carregarMovimentacoes);
document.getElementById('filtroPeriodoMov').addEventListener('change', carregarMovimentacoes);
document.getElementById('filtroPeriodoEstoque').addEventListener('change', carregarEstoqueHierarquia);

// Salvar recebimento
document.getElementById('salvarRecebimento').addEventListener('click', function() {
    const form = document.getElementById('recebimentoForm');
    const formData = new FormData(form);
    
    const data = {
        produto_id: produtoId,
        quantidade: parseFloat(formData.get('quantidade')),
        preco_unitario: parseFloat(formData.get('preco_unitario')) || null,
        lote: formData.get('lote'),
        fornecedor: (formData.get('fornecedor') || '').trim() || null,
        data_fabricacao: formData.get('data_fabricacao'),
        data_vencimento: formData.get('data_vencimento'),
        nota_fiscal: (formData.get('nota_fiscal') || '').trim() || null,
        observacoes: formData.get('observacoes'),
        data_recebimento: formData.get('data_recebimento')
    };
    
    if (!data.quantidade || data.quantidade <= 0) {
        alert('Quantidade deve ser maior que zero');
        return;
    }
    const almoxId = formData.get('almoxarifado_id');
    if (!almoxId) {
        alert('Selecione um almoxarifado');
        return;
    }
    data.almoxarifado_id = (/^\d+$/.test(almoxId)) ? parseInt(almoxId, 10) : almoxId;
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    
    fetchJson(`/api/produtos/${produtoId}/recebimento`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(resp => {
        if (resp.error) {
            throw new Error(resp.error);
        }
        alert('Recebimento registrado com sucesso!');
        bootstrap.Modal.getInstance(document.getElementById('recebimentoModal')).hide();
        form.reset();
        atualizarEstoque();
        carregarMovimentacoes();
    })
    .catch(error => {
        console.error('Erro ao registrar recebimento:', error);
        alert('Erro ao registrar recebimento: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Registrar Recebimento';
    });
});
document.addEventListener('DOMContentLoaded', function() {
    carregarProduto();
    // Cálculo automático do valor total
    const qtdEl = document.getElementById('quantidade');
    const precoEl = document.getElementById('preco_unitario');
    if (qtdEl) qtdEl.addEventListener('input', calcularValorTotalModal);
    if (precoEl) precoEl.addEventListener('input', calcularValorTotalModal);
    // Verificação de vencimento
    const vencEl = document.getElementById('data_vencimento');
    if (vencEl) vencEl.addEventListener('change', verificarVencimentoModal);
});

// Helper: formatar quantidade como inteiro + unidade
function formatQuantidade(value, unidadeOverride) {
    const unidade = unidadeOverride || (produtoDetalhes && produtoDetalhes.unidade_medida) || '';
    let v = 0;
    try { v = parseFloat(value || 0); } catch (e) { v = 0; }
    const inteiro = Math.round(v);
    return unidade ? `${inteiro} ${unidade}` : `${inteiro}`;
}

// Helper: parse de data flexível (ISO, timestamp numérico, DD/MM/YYYY)
function parseDateFlexible(value) {
    if (!value) return null;
    try {
        if (value instanceof Date) return value;
        if (typeof value === 'number') return new Date(value);
        const s = String(value).trim();
        const dm = s.match(/^([0-3]?\d)[\/-]([0-1]?\d)[\/-](\d{4})(?:\s+(\d{1,2}):(\d{2}))?$/);
        if (dm) {
            const d = parseInt(dm[1], 10);
            const m = parseInt(dm[2], 10) - 1;
            const y = parseInt(dm[3], 10);
            const hh = dm[4] ? parseInt(dm[4], 10) : 0;
            const mm = dm[5] ? parseInt(dm[5], 10) : 0;
            return new Date(y, m, d, hh, mm);
        }
        const iso = new Date(s);
        if (!isNaN(iso.getTime())) return iso;
    } catch (_) {}
    return null;
}

// Cache: obter dados de estoque com AbortController
function obterEstoqueDados(force = false) {
    if (!produtoId) return Promise.reject(new Error('Produto não identificado'));
    if (!force && estoquePromise) return estoquePromise;
    if (estoqueAbortController) { try { estoqueAbortController.abort(); } catch (_) {} }
    estoqueAbortController = new AbortController();
    estoquePromise = fetchJson(`/api/produtos/${produtoId}/estoque`, { signal: estoqueAbortController.signal })
        .then(data => { estoqueDadosCache = data; return data; })
        .catch(err => { if (err && err.name === 'AbortError') { throw err; } throw err; });
    return estoquePromise;
}

// Renderização: tabela de lotes com limite e toggle
function renderizarTabelaLotes(lotes) {
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Lote</th>
                <th>Quantidade</th>
                <th>Data Fabricação</th>
                <th>Data Vencimento</th>
                <th>Status</th>
                <th>Observações</th>
            </tr>
        </thead>
        <tbody>
    `;
    const hoje = new Date();
    const mostrar = lotesExpandido ? lotes : lotes.slice(0, LOTES_LIMITE);
    mostrar.forEach(lote => {
        const vencDt = parseDateFlexible(lote.data_vencimento);
        const diasVencimento = (vencDt) ? Math.ceil((vencDt - hoje) / (1000 * 60 * 60 * 24)) : null;
        let statusBadge = '<span class="badge bg-success">Válido</span>';
        if (diasVencimento !== null) {
            if (diasVencimento < 0) statusBadge = '<span class="badge bg-danger">Vencido</span>';
            else if (diasVencimento <= 30) statusBadge = '<span class="badge bg-warning">Próximo ao vencimento</span>';
        }
        html += `
            <tr>
                <td><strong>${lote.numero_lote || '-'}</strong></td>
                <td>${formatQuantidade(lote.quantidade_atual)}</td>
                <td>${lote.data_fabricacao ? parseDateFlexible(lote.data_fabricacao).toLocaleDateString('pt-BR') : '-'}</td>
                <td>${lote.data_vencimento ? parseDateFlexible(lote.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                <td>${statusBadge}</td>
                <td class="text-muted">${lote.observacoes || '-'}</td>
            </tr>
        `;
    });
    html += '</tbody></table></div>';
    if (lotes.length > LOTES_LIMITE) {
        html += `
            <div class="d-flex justify-content-center">
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleLotesExpandido()">
                    ${lotesExpandido ? 'Mostrar menos' : 'Mostrar mais'}
                </button>
            </div>
        `;
    }
    document.getElementById('lotesValidades').innerHTML = html;
}

function toggleLotesExpandido() {
    lotesExpandido = !lotesExpandido;
    carregarLotes();
}

// Calcular valor total (modal)
function calcularValorTotalModal() {
    const quantidade = parseFloat(document.getElementById('quantidade')?.value) || 0;
    const precoUnitario = parseFloat(document.getElementById('preco_unitario')?.value) || 0;
    const valorTotal = quantidade * precoUnitario;
    const valorEl = document.getElementById('valor_total');
    if (valorEl) {
        valorEl.value = valorTotal.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
});
    }
}

// Verificar vencimento (modal)
function verificarVencimentoModal() {
    const dataVencimento = document.getElementById('data_vencimento')?.value;
    const alertaDiv = document.getElementById('alertaVencimentoModal');
    if (!alertaDiv) return;
    if (!dataVencimento) {
        alertaDiv.innerHTML = '';
        return;
    }
    const hoje = new Date();
    const vencimento = new Date(dataVencimento);
    const diasVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
    if (diasVencimento < 0) {
        alertaDiv.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Produto já vencido!</span>';
    } else if (diasVencimento <= 30) {
        alertaDiv.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vence em breve!</span>';
    } else if (diasVencimento <= 90) {
        alertaDiv.innerHTML = '<span class="text-info"><i class="fas fa-info-circle"></i> Vencimento próximo</span>';
    } else {
        alertaDiv.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Validade adequada</span>';
    }
}
</script>
<style>
.limited-section { max-height: 360px; overflow-y: auto; }
</style>
{% endblock %}