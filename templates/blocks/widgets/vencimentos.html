<!-- Widget: Vencimentos de Lotes -->
<div class="card border-0 shadow-sm h-100">
  <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-calendar-exclamation me-2"></i>
      Vencimentos de Lotes
    </h5>
    <div class="d-flex align-items-center gap-2" id="vencimentos-counters">
      <span class="badge bg-danger">Vencidos: <span id="vencidos-count">-</span></span>
      <span class="badge bg-warning text-dark">Próximos (30d): <span id="proximos-count">-</span></span>
    </div>
  </div>
  <div class="card-body">
    <div id="vencimentos-content">
      <div class="text-center">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 mb-0 text-muted">Carregando...</p>
      </div>
    </div>
  </div>
  <div class="card-footer bg-light d-flex justify-content-end">
    <a href="{{ url_for('main.estoque') }}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-warehouse me-1"></i>
      Consultar Estoque
    </a>
  </div>
</div>

<script>
(function() {
  function formatDateISO(s) {
    try {
      const d = new Date(s);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    } catch (e) {
      return String(s || '-');
    }
  }

  function formatDias(dias) {
    const n = Number(dias || 0);
    if (!isFinite(n)) return '-';
    if (n < 0) return `Vencido há ${Math.abs(n)}d`;
    if (n === 0) return 'Vence hoje';
    return `Vence em ${n}d`;
  }

  async function loadVencimentos() {
    try {
      const data = await fetchJson('/api/dashboard/vencimentos?limit=5');
      const content = document.getElementById('vencimentos-content');
      const vencidosEl = document.getElementById('vencidos-count');
      const proximosEl = document.getElementById('proximos-count');
      if (vencidosEl) vencidosEl.textContent = Number(data.total_vencidos || 0);
      if (proximosEl) proximosEl.textContent = Number(data.total_proximos || 0);

      const items = Array.isArray(data.items) ? data.items : [];
      if (items.length === 0) {
        content.innerHTML = `
          <div class="text-center text-success">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <p class="mb-0">Nenhum lote vencido ou próximo ao vencimento.</p>
          </div>
        `;
        return;
      }

      let html = '<div class="list-group list-group-flush">';
      for (const item of items) {
        const status = String(item.status || '').toLowerCase();
        const cls = status === 'vencido' ? 'text-danger' : 'text-warning';
        const lot = item.numero_lote || '-';
        const nome = item.produto_nome || 'Produto';
        html += `
          <div class="list-group-item px-0 py-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${nome}</h6>
                <small class="text-muted">Lote: ${lot}</small>
              </div>
              <div class="text-end">
                <div class="${cls}"><strong>${formatDias(item.dias_para_vencer)}</strong></div>
                <small class="text-muted">Venc.: ${formatDateISO(item.data_vencimento)}</small>
              </div>
            </div>
          </div>
        `;
      }
      html += '</div>';
      content.innerHTML = html;
    } catch (e) {
      console.error('Erro ao carregar vencimentos:', e);
      const content = document.getElementById('vencimentos-content');
      content.innerHTML = `
        <div class="text-center text-danger">
          <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
          <p class="mb-0">Erro ao carregar dados</p>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', loadVencimentos);
})();
</script>